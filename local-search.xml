<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>day12</title>
    <link href="/2024/12/13/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day12/"/>
    <url>/2024/12/13/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day12/</url>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js"></script><h1 id="苍穹外卖-day12"><a href="#苍穹外卖-day12" class="headerlink" title="苍穹外卖-day12"></a>苍穹外卖-day12</h1><h2 id="课程内容"><a href="#课程内容" class="headerlink" title="课程内容"></a>课程内容</h2><ul><li>工作台</li><li>Apache POI</li><li>导出运营数据Excel报表</li></ul><p>功能实现：<strong>工作台</strong>、<strong>数据导出</strong></p><p><strong>工作台效果图：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355457.png" alt="image-20230130190031553" style="zoom: 50%;" />  <p><strong>数据导出效果图：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355459.png" alt="image-20230130190124725" style="zoom: 50%;" />   <p>在数据统计页面点击<strong>数据导出</strong>：生成Excel报表</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355460.png" alt="image-20230130190243865" style="zoom: 50%;" />    <h2 id="1-工作台"><a href="#1-工作台" class="headerlink" title="1. 工作台"></a>1. 工作台</h2><h3 id="1-1-需求分析和设计"><a href="#1-1-需求分析和设计" class="headerlink" title="1.1 需求分析和设计"></a>1.1 需求分析和设计</h3><h4 id="1-1-1-产品原型"><a href="#1-1-1-产品原型" class="headerlink" title="1.1.1 产品原型"></a>1.1.1 产品原型</h4><p>工作台是系统运营的数据看板，并提供快捷操作入口，可以有效提高商家的工作效率。</p><p><strong>工作台展示的数据：</strong></p><ul><li>今日数据</li><li>订单管理</li><li>菜品总览</li><li>套餐总览</li><li>订单信息</li></ul><p><strong>原型图：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355461.png" alt="image-20230130191051003" style="zoom:50%;" /> <p><strong>名词解释：</strong></p><ul><li>营业额：已完成订单的总金额</li><li>有效订单：已完成订单的数量</li><li>订单完成率：有效订单数 / 总订单数 * 100%</li><li>平均客单价：营业额 / 有效订单数</li><li>新增用户：新增用户的数量</li></ul><h4 id="1-1-2-接口设计"><a href="#1-1-2-接口设计" class="headerlink" title="1.1.2 接口设计"></a>1.1.2 接口设计</h4><p>通过上述原型图分析，共包含6个接口。</p><p><strong>接口设计：</strong></p><ul><li>今日数据接口</li><li>订单管理接口</li><li>菜品总览接口</li><li>套餐总览接口</li><li>订单搜索（已完成）</li><li>各个状态的订单数量统计（已完成）</li></ul><p><strong>1). 今日数据的接口设计</strong></p><p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355462.png" alt="image-20230130191820764" style="zoom:50%;" /> <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355463.png" alt="image-20230130191837090" style="zoom:50%;" /></p><p><strong>2). 订单管理的接口设计</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355464.png" alt="image-20230130192105373" style="zoom:50%;" /> <p><strong>3). 菜品总览的接口设计</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355465.png" alt="image-20230130192225168" style="zoom:50%;" /> <p><strong>4). 套餐总览的接口设计</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355466.png" alt="image-20230130195425389" style="zoom:50%;" /> <h3 id="1-2-代码导入"><a href="#1-2-代码导入" class="headerlink" title="1.2 代码导入"></a>1.2 代码导入</h3><p>直接导入课程资料中的工作台模块功能代码即可：</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355467.png" alt="image-20230130195535421" style="zoom:50%;" /> <h4 id="1-2-1-Controller层"><a href="#1-2-1-Controller层" class="headerlink" title="1.2.1 Controller层"></a>1.2.1 Controller层</h4><p><strong>添加WorkSpaceController.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.controller.admin;<br><br><span class="hljs-keyword">import</span> com.sky.result.Result;<br><span class="hljs-keyword">import</span> com.sky.service.WorkspaceService;<br><span class="hljs-keyword">import</span> com.sky.vo.BusinessDataVO;<br><span class="hljs-keyword">import</span> com.sky.vo.DishOverViewVO;<br><span class="hljs-keyword">import</span> com.sky.vo.OrderOverViewVO;<br><span class="hljs-keyword">import</span> com.sky.vo.SetmealOverViewVO;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><span class="hljs-keyword">import</span> java.time.LocalTime;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 工作台</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/admin/workspace&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Api(tags = &quot;工作台相关接口&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WorkSpaceController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> WorkspaceService workspaceService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 工作台今日数据查询</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;/businessData&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;工作台今日数据查询&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;BusinessDataVO&gt; <span class="hljs-title function_">businessData</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">//获得当天的开始时间</span><br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">begin</span> <span class="hljs-operator">=</span> LocalDateTime.now().with(LocalTime.MIN);<br>        <span class="hljs-comment">//获得当天的结束时间</span><br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> LocalDateTime.now().with(LocalTime.MAX);<br><br>        <span class="hljs-type">BusinessDataVO</span> <span class="hljs-variable">businessDataVO</span> <span class="hljs-operator">=</span> workspaceService.getBusinessData(begin, end);<br>        <span class="hljs-keyword">return</span> Result.success(businessDataVO);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询订单管理数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;/overviewOrders&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;查询订单管理数据&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;OrderOverViewVO&gt; <span class="hljs-title function_">orderOverView</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> Result.success(workspaceService.getOrderOverView());<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询菜品总览</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;/overviewDishes&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;查询菜品总览&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;DishOverViewVO&gt; <span class="hljs-title function_">dishOverView</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> Result.success(workspaceService.getDishOverView());<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询套餐总览</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;/overviewSetmeals&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;查询套餐总览&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;SetmealOverViewVO&gt; <span class="hljs-title function_">setmealOverView</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> Result.success(workspaceService.getSetmealOverView());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="1-2-2-Service层接口"><a href="#1-2-2-Service层接口" class="headerlink" title="1.2.2 Service层接口"></a>1.2.2 Service层接口</h4><p><strong>添加WorkspaceService.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.service;<br><br><span class="hljs-keyword">import</span> com.sky.vo.BusinessDataVO;<br><span class="hljs-keyword">import</span> com.sky.vo.DishOverViewVO;<br><span class="hljs-keyword">import</span> com.sky.vo.OrderOverViewVO;<br><span class="hljs-keyword">import</span> com.sky.vo.SetmealOverViewVO;<br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">WorkspaceService</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据时间段统计营业数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> begin</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> end</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    BusinessDataVO <span class="hljs-title function_">getBusinessData</span><span class="hljs-params">(LocalDateTime begin, LocalDateTime end)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询订单管理数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    OrderOverViewVO <span class="hljs-title function_">getOrderOverView</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询菜品总览</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    DishOverViewVO <span class="hljs-title function_">getDishOverView</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询套餐总览</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    SetmealOverViewVO <span class="hljs-title function_">getSetmealOverView</span><span class="hljs-params">()</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="1-2-3-Service层实现类"><a href="#1-2-3-Service层实现类" class="headerlink" title="1.2.3 Service层实现类"></a>1.2.3 Service层实现类</h4><p><strong>添加WorkspaceServiceImpl.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.service.impl;<br><br><span class="hljs-keyword">import</span> com.sky.constant.StatusConstant;<br><span class="hljs-keyword">import</span> com.sky.entity.Orders;<br><span class="hljs-keyword">import</span> com.sky.mapper.DishMapper;<br><span class="hljs-keyword">import</span> com.sky.mapper.OrderMapper;<br><span class="hljs-keyword">import</span> com.sky.mapper.SetmealMapper;<br><span class="hljs-keyword">import</span> com.sky.mapper.UserMapper;<br><span class="hljs-keyword">import</span> com.sky.service.WorkspaceService;<br><span class="hljs-keyword">import</span> com.sky.vo.BusinessDataVO;<br><span class="hljs-keyword">import</span> com.sky.vo.DishOverViewVO;<br><span class="hljs-keyword">import</span> com.sky.vo.OrderOverViewVO;<br><span class="hljs-keyword">import</span> com.sky.vo.SetmealOverViewVO;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><span class="hljs-keyword">import</span> java.time.LocalTime;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WorkspaceServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WorkspaceService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderMapper orderMapper;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserMapper userMapper;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> DishMapper dishMapper;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SetmealMapper setmealMapper;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据时间段统计营业数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> begin</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> end</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> BusinessDataVO <span class="hljs-title function_">getBusinessData</span><span class="hljs-params">(LocalDateTime begin, LocalDateTime end)</span> &#123;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 营业额：当日已完成订单的总金额</span><br><span class="hljs-comment">         * 有效订单：当日已完成订单的数量</span><br><span class="hljs-comment">         * 订单完成率：有效订单数 / 总订单数</span><br><span class="hljs-comment">         * 平均客单价：营业额 / 有效订单数</span><br><span class="hljs-comment">         * 新增用户：当日新增用户的数量</span><br><span class="hljs-comment">         */</span><br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(<span class="hljs-string">&quot;begin&quot;</span>,begin);<br>        map.put(<span class="hljs-string">&quot;end&quot;</span>,end);<br><br>        <span class="hljs-comment">//查询总订单数</span><br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">totalOrderCount</span> <span class="hljs-operator">=</span> orderMapper.countByMap(map);<br><br>        map.put(<span class="hljs-string">&quot;status&quot;</span>, Orders.COMPLETED);<br>        <span class="hljs-comment">//营业额</span><br>        <span class="hljs-type">Double</span> <span class="hljs-variable">turnover</span> <span class="hljs-operator">=</span> orderMapper.sumByMap(map);<br>        turnover = turnover == <span class="hljs-literal">null</span>? <span class="hljs-number">0.0</span> : turnover;<br><br>        <span class="hljs-comment">//有效订单数</span><br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">validOrderCount</span> <span class="hljs-operator">=</span> orderMapper.countByMap(map);<br><br>        <span class="hljs-type">Double</span> <span class="hljs-variable">unitPrice</span> <span class="hljs-operator">=</span> <span class="hljs-number">0.0</span>;<br><br>        <span class="hljs-type">Double</span> <span class="hljs-variable">orderCompletionRate</span> <span class="hljs-operator">=</span> <span class="hljs-number">0.0</span>;<br>        <span class="hljs-keyword">if</span>(totalOrderCount != <span class="hljs-number">0</span> &amp;&amp; validOrderCount != <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-comment">//订单完成率</span><br>            orderCompletionRate = validOrderCount.doubleValue() / totalOrderCount;<br>            <span class="hljs-comment">//平均客单价</span><br>            unitPrice = turnover / validOrderCount;<br>        &#125;<br><br>        <span class="hljs-comment">//新增用户数</span><br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">newUsers</span> <span class="hljs-operator">=</span> userMapper.countByMap(map);<br><br>        <span class="hljs-keyword">return</span> BusinessDataVO.builder()<br>                .turnover(turnover)<br>                .validOrderCount(validOrderCount)<br>                .orderCompletionRate(orderCompletionRate)<br>                .unitPrice(unitPrice)<br>                .newUsers(newUsers)<br>                .build();<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询订单管理数据</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> OrderOverViewVO <span class="hljs-title function_">getOrderOverView</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(<span class="hljs-string">&quot;begin&quot;</span>, LocalDateTime.now().with(LocalTime.MIN));<br>        map.put(<span class="hljs-string">&quot;status&quot;</span>, Orders.TO_BE_CONFIRMED);<br><br>        <span class="hljs-comment">//待接单</span><br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">waitingOrders</span> <span class="hljs-operator">=</span> orderMapper.countByMap(map);<br><br>        <span class="hljs-comment">//待派送</span><br>        map.put(<span class="hljs-string">&quot;status&quot;</span>, Orders.CONFIRMED);<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">deliveredOrders</span> <span class="hljs-operator">=</span> orderMapper.countByMap(map);<br><br>        <span class="hljs-comment">//已完成</span><br>        map.put(<span class="hljs-string">&quot;status&quot;</span>, Orders.COMPLETED);<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">completedOrders</span> <span class="hljs-operator">=</span> orderMapper.countByMap(map);<br><br>        <span class="hljs-comment">//已取消</span><br>        map.put(<span class="hljs-string">&quot;status&quot;</span>, Orders.CANCELLED);<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">cancelledOrders</span> <span class="hljs-operator">=</span> orderMapper.countByMap(map);<br><br>        <span class="hljs-comment">//全部订单</span><br>        map.put(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-literal">null</span>);<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">allOrders</span> <span class="hljs-operator">=</span> orderMapper.countByMap(map);<br><br>        <span class="hljs-keyword">return</span> OrderOverViewVO.builder()<br>                .waitingOrders(waitingOrders)<br>                .deliveredOrders(deliveredOrders)<br>                .completedOrders(completedOrders)<br>                .cancelledOrders(cancelledOrders)<br>                .allOrders(allOrders)<br>                .build();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询菜品总览</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> DishOverViewVO <span class="hljs-title function_">getDishOverView</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(<span class="hljs-string">&quot;status&quot;</span>, StatusConstant.ENABLE);<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">sold</span> <span class="hljs-operator">=</span> dishMapper.countByMap(map);<br><br>        map.put(<span class="hljs-string">&quot;status&quot;</span>, StatusConstant.DISABLE);<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">discontinued</span> <span class="hljs-operator">=</span> dishMapper.countByMap(map);<br><br>        <span class="hljs-keyword">return</span> DishOverViewVO.builder()<br>                .sold(sold)<br>                .discontinued(discontinued)<br>                .build();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询套餐总览</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> SetmealOverViewVO <span class="hljs-title function_">getSetmealOverView</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(<span class="hljs-string">&quot;status&quot;</span>, StatusConstant.ENABLE);<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">sold</span> <span class="hljs-operator">=</span> setmealMapper.countByMap(map);<br><br>        map.put(<span class="hljs-string">&quot;status&quot;</span>, StatusConstant.DISABLE);<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">discontinued</span> <span class="hljs-operator">=</span> setmealMapper.countByMap(map);<br><br>        <span class="hljs-keyword">return</span> SetmealOverViewVO.builder()<br>                .sold(sold)<br>                .discontinued(discontinued)<br>                .build();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="1-2-4-Mapper层"><a href="#1-2-4-Mapper层" class="headerlink" title="1.2.4 Mapper层"></a>1.2.4 Mapper层</h4><p><strong>在SetmealMapper中添加countByMap方法定义</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 根据条件统计套餐数量</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> map</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   Integer <span class="hljs-title function_">countByMap</span><span class="hljs-params">(Map map)</span>;<br></code></pre></td></tr></table></figure><p><strong>在SetmealMapper.xml中添加对应SQL实现</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;countByMap&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;java.lang.Integer&quot;</span>&gt;</span><br>        select count(id) from setmeal<br>        <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;status != null&quot;</span>&gt;</span><br>                and status = #&#123;status&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;categoryId != null&quot;</span>&gt;</span><br>                and category_id = #&#123;categoryId&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>在DishMapper中添加countByMap方法定义</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 根据条件统计菜品数量</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> map</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   Integer <span class="hljs-title function_">countByMap</span><span class="hljs-params">(Map map)</span>;<br></code></pre></td></tr></table></figure><p><strong>在DishMapper.xml中添加对应SQL实现</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;countByMap&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;java.lang.Integer&quot;</span>&gt;</span><br>        select count(id) from dish<br>        <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;status != null&quot;</span>&gt;</span><br>                and status = #&#123;status&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;categoryId != null&quot;</span>&gt;</span><br>                and category_id = #&#123;categoryId&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="1-3-功能测试"><a href="#1-3-功能测试" class="headerlink" title="1.3 功能测试"></a>1.3 功能测试</h3><p>可以通过如下方式进行测试：</p><ul><li>通过接口文档测试</li><li>前后端联调测试</li></ul><p>接下来我们使用上述两种方式分别测试。</p><h4 id="1-3-1-接口文档测试"><a href="#1-3-1-接口文档测试" class="headerlink" title="1.3.1 接口文档测试"></a>1.3.1 接口文档测试</h4><p><strong>启动服务</strong>，访问<a href="http://localhost:8080/doc.html%EF%BC%8C%E8%BF%9B%E5%85%A5%E5%B7%A5%E4%BD%9C%E5%8F%B0%E7%9B%B8%E5%85%B3%E6%8E%A5%E5%8F%A3">http://localhost:8080/doc.html，进入工作台相关接口</a></p><p><strong>注意：</strong>使用admin用户登录重新获取token，在全局参数设置中添加，防止token失效。</p><p><strong>1). 今日数据查询</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355468.png" alt="image-20230131103600918" style="zoom:50%;" /> <p><strong>2). 菜品总览查询</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355469.png" alt="image-20230131103714898" style="zoom:50%;" /> <p><strong>3). 订单管理数据查询</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355470.png" alt="image-20230131103808342" style="zoom:50%;" /> <p><strong>4). 套餐总览查询</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355471.png" alt="image-20230131103903802" style="zoom:50%;" /> <h4 id="1-3-2-前后端联调测试"><a href="#1-3-2-前后端联调测试" class="headerlink" title="1.3.2 前后端联调测试"></a>1.3.2 前后端联调测试</h4><p><strong>启动nginx</strong>,访问 <a href="http://localhost,进入工作台/">http://localhost，进入工作台</a></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355472.png" alt="image-20230131104243713" style="zoom:50%;" /> <p>进入开发者模式，分别查看今日数据、订单管理、菜品总览、套餐总览</p><p><strong>1). 今日数据查询</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355473.png" alt="image-20230131104849876" style="zoom:50%;" /> <p><strong>2). 订单管理数据查询</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355474.png" alt="image-20230131104939694" style="zoom:50%;" /> <p><strong>3). 菜品总览查询</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355475.png" alt="image-20230131105023109" style="zoom:50%;" /> <p><strong>4). 套餐总览查询</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355476.png" alt="image-20230131105123610" style="zoom:50%;" /> <h3 id="1-4-代码提交"><a href="#1-4-代码提交" class="headerlink" title="1.4 代码提交"></a>1.4 代码提交</h3><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355477.png" alt="image-20230131105528906" style="zoom:50%;" /> <p>后续步骤和其它功能代码提交一致，不再赘述。</p><h2 id="2-Apache-POI"><a href="#2-Apache-POI" class="headerlink" title="2. Apache POI"></a>2. Apache POI</h2><h3 id="2-1-介绍"><a href="#2-1-介绍" class="headerlink" title="2.1 介绍"></a>2.1 介绍</h3><p>Apache POI 是一个处理Miscrosoft Office各种文件格式的开源项目。简单来说就是，我们可以使用 POI 在 Java 程序中对Miscrosoft Office各种文件进行读写操作。<br>一般情况下，POI 都是用于操作 Excel 文件。</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355478.png" alt="image-20230131110631081" style="zoom:50%;" /> <p><strong>Apache POI 的应用场景：</strong></p><ul><li><p>银行网银系统导出交易明细</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355479.png" alt="image-20230131110810568" style="zoom:50%;" /> </li><li><p>各种业务系统导出Excel报表</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355480.png" alt="image-20230131110839959" style="zoom:50%;" /> </li><li><p>批量导入业务数据</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355481.png" alt="image-20230131110856903" style="zoom:50%;" /> </li></ul><h3 id="2-2-入门案例"><a href="#2-2-入门案例" class="headerlink" title="2.2 入门案例"></a>2.2 入门案例</h3><p>Apache POI既可以将数据写入Excel文件，也可以读取Excel文件中的数据，接下来分别进行实现。</p><p><strong>Apache POI的maven坐标：</strong>(项目中已导入)</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.poi<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>poi<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.16<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.poi<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>poi-ooxml<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.16<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="2-2-1-将数据写入Excel文件"><a href="#2-2-1-将数据写入Excel文件" class="headerlink" title="2.2.1 将数据写入Excel文件"></a>2.2.1 将数据写入Excel文件</h4><p><strong>1). 代码开发</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.test;<br><br><span class="hljs-keyword">import</span> org.apache.poi.xssf.usermodel.XSSFCell;<br><span class="hljs-keyword">import</span> org.apache.poi.xssf.usermodel.XSSFRow;<br><span class="hljs-keyword">import</span> org.apache.poi.xssf.usermodel.XSSFSheet;<br><span class="hljs-keyword">import</span> org.apache.poi.xssf.usermodel.XSSFWorkbook;<br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">POITest</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 基于POI向Excel文件写入数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">write</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//在内存中创建一个Excel文件对象</span><br>        <span class="hljs-type">XSSFWorkbook</span> <span class="hljs-variable">excel</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XSSFWorkbook</span>();<br>        <span class="hljs-comment">//创建Sheet页</span><br>        <span class="hljs-type">XSSFSheet</span> <span class="hljs-variable">sheet</span> <span class="hljs-operator">=</span> excel.createSheet(<span class="hljs-string">&quot;itcast&quot;</span>);<br><br>        <span class="hljs-comment">//在Sheet页中创建行，0表示第1行</span><br>        <span class="hljs-type">XSSFRow</span> <span class="hljs-variable">row1</span> <span class="hljs-operator">=</span> sheet.createRow(<span class="hljs-number">0</span>);<br>        <span class="hljs-comment">//创建单元格并在单元格中设置值，单元格编号也是从0开始，1表示第2个单元格</span><br>        row1.createCell(<span class="hljs-number">1</span>).setCellValue(<span class="hljs-string">&quot;姓名&quot;</span>);<br>        row1.createCell(<span class="hljs-number">2</span>).setCellValue(<span class="hljs-string">&quot;城市&quot;</span>);<br><br>        <span class="hljs-type">XSSFRow</span> <span class="hljs-variable">row2</span> <span class="hljs-operator">=</span> sheet.createRow(<span class="hljs-number">1</span>);<br>        row2.createCell(<span class="hljs-number">1</span>).setCellValue(<span class="hljs-string">&quot;张三&quot;</span>);<br>        row2.createCell(<span class="hljs-number">2</span>).setCellValue(<span class="hljs-string">&quot;北京&quot;</span>);<br><br>        <span class="hljs-type">XSSFRow</span> <span class="hljs-variable">row3</span> <span class="hljs-operator">=</span> sheet.createRow(<span class="hljs-number">2</span>);<br>        row3.createCell(<span class="hljs-number">1</span>).setCellValue(<span class="hljs-string">&quot;李四&quot;</span>);<br>        row3.createCell(<span class="hljs-number">2</span>).setCellValue(<span class="hljs-string">&quot;上海&quot;</span>);<br><br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;D:\\itcast.xlsx&quot;</span>));<br>        <span class="hljs-comment">//通过输出流将内存中的Excel文件写入到磁盘上</span><br>        excel.write(out);<br><br>        <span class="hljs-comment">//关闭资源</span><br>        out.flush();<br>        out.close();<br>        excel.close();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        write();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>2). 实现效果</strong></p><p>在D盘中生成itcast.xlsx文件，创建名称为itcast的Sheet页，同时将内容成功写入。</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355482.png" alt="image-20230131112905034" style="zoom:50%;" /> <h4 id="2-2-2-读取Excel文件中的数据"><a href="#2-2-2-读取Excel文件中的数据" class="headerlink" title="2.2.2 读取Excel文件中的数据"></a>2.2.2 读取Excel文件中的数据</h4><p><strong>1). 代码开发</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.test;<br><br><span class="hljs-keyword">import</span> org.apache.poi.xssf.usermodel.XSSFCell;<br><span class="hljs-keyword">import</span> org.apache.poi.xssf.usermodel.XSSFRow;<br><span class="hljs-keyword">import</span> org.apache.poi.xssf.usermodel.XSSFSheet;<br><span class="hljs-keyword">import</span> org.apache.poi.xssf.usermodel.XSSFWorkbook;<br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">POITest</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 基于POI读取Excel文件</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">read</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;D:\\itcast.xlsx&quot;</span>));<br>        <span class="hljs-comment">//通过输入流读取指定的Excel文件</span><br>        <span class="hljs-type">XSSFWorkbook</span> <span class="hljs-variable">excel</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XSSFWorkbook</span>(in);<br>        <span class="hljs-comment">//获取Excel文件的第1个Sheet页</span><br>        <span class="hljs-type">XSSFSheet</span> <span class="hljs-variable">sheet</span> <span class="hljs-operator">=</span> excel.getSheetAt(<span class="hljs-number">0</span>);<br><br>        <span class="hljs-comment">//获取Sheet页中的最后一行的行号</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">lastRowNum</span> <span class="hljs-operator">=</span> sheet.getLastRowNum();<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt;= lastRowNum; i++) &#123;<br>            <span class="hljs-comment">//获取Sheet页中的行</span><br>            <span class="hljs-type">XSSFRow</span> <span class="hljs-variable">titleRow</span> <span class="hljs-operator">=</span> sheet.getRow(i);<br>            <span class="hljs-comment">//获取行的第2个单元格</span><br>            <span class="hljs-type">XSSFCell</span> <span class="hljs-variable">cell1</span> <span class="hljs-operator">=</span> titleRow.getCell(<span class="hljs-number">1</span>);<br>            <span class="hljs-comment">//获取单元格中的文本内容</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">cellValue1</span> <span class="hljs-operator">=</span> cell1.getStringCellValue();<br>            <span class="hljs-comment">//获取行的第3个单元格</span><br>            <span class="hljs-type">XSSFCell</span> <span class="hljs-variable">cell2</span> <span class="hljs-operator">=</span> titleRow.getCell(<span class="hljs-number">2</span>);<br>            <span class="hljs-comment">//获取单元格中的文本内容</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">cellValue2</span> <span class="hljs-operator">=</span> cell2.getStringCellValue();<br><br>            System.out.println(cellValue1 + <span class="hljs-string">&quot; &quot;</span> +cellValue2);<br>        &#125;<br><br>        <span class="hljs-comment">//关闭资源</span><br>        in.close();<br>        excel.close();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        read();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><strong>2). 实现效果</strong></p><p>将itcast.xlsx文件中的数据进行读取</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355483.png" alt="image-20230131113255962" style="zoom:50%;" /> <h2 id="3-导出运营数据Excel报表"><a href="#3-导出运营数据Excel报表" class="headerlink" title="3. 导出运营数据Excel报表"></a>3. 导出运营数据Excel报表</h2><h3 id="3-1-需求分析和设计"><a href="#3-1-需求分析和设计" class="headerlink" title="3.1 需求分析和设计"></a>3.1 需求分析和设计</h3><h4 id="3-1-1-产品原型"><a href="#3-1-1-产品原型" class="headerlink" title="3.1.1 产品原型"></a>3.1.1 产品原型</h4><p>在数据统计页面，有一个数据导出的按钮，点击该按钮时，其实就会下载一个文件。这个文件实际上是一个Excel形式的文件，文件中主要包含最近30日运营相关的数据。表格的形式已经固定，主要由概览数据和明细数据两部分组成。真正导出这个报表之后，相对应的数字就会填充在表格中，就可以进行存档。</p><p><strong>原型图：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355484.png" alt="image-20230131151132672" style="zoom:50%;" /> <p>导出的Excel报表格式：</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355485.png" alt="image-20230130201026785" style="zoom: 67%;" />  <p><strong>业务规则：</strong></p><ul><li>导出Excel形式的报表文件</li><li>导出最近30天的运营数据</li></ul><h4 id="3-1-2-接口设计"><a href="#3-1-2-接口设计" class="headerlink" title="3.1.2 接口设计"></a>3.1.2 接口设计</h4><p>通过上述原型图设计对应的接口。</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355486.png" alt="image-20230130201109280" style="zoom:50%;" /> <p><strong>注意：</strong></p><ul><li><p>当前接口没有传递参数，因为导出的是最近30天的运营数据，后端计算即可，所以不需要任何参数</p></li><li><p>当前接口没有返回数据，因为报表导出功能本质上是文件下载，服务端会通过输出流将Excel文件下载到客户端浏览器</p></li></ul><h3 id="3-2-代码开发"><a href="#3-2-代码开发" class="headerlink" title="3.2 代码开发"></a>3.2 代码开发</h3><h4 id="3-2-1-实现步骤"><a href="#3-2-1-实现步骤" class="headerlink" title="3.2.1 实现步骤"></a>3.2.1 实现步骤</h4><p>1). 设计Excel模板文件</p><p>2). 查询近30天的运营数据</p><p>3). 将查询到的运营数据写入模板文件</p><p>4). 通过输出流将Excel文件下载到客户端浏览器</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355487.png" alt="image-20230131152610559" style="zoom:50%;" /> <h4 id="3-2-2-Controller层"><a href="#3-2-2-Controller层" class="headerlink" title="3.2.2 Controller层"></a>3.2.2 Controller层</h4><p><strong>根据接口定义，在ReportController中创建export方法：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 导出运营数据报表</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> response</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@GetMapping(&quot;/export&quot;)</span><br>   <span class="hljs-meta">@ApiOperation(&quot;导出运营数据报表&quot;)</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">export</span><span class="hljs-params">(HttpServletResponse response)</span>&#123;<br>       reportService.exportBusinessData(response);<br>   &#125;<br></code></pre></td></tr></table></figure><h4 id="3-2-3-Service层接口"><a href="#3-2-3-Service层接口" class="headerlink" title="3.2.3 Service层接口"></a>3.2.3 Service层接口</h4><p><strong>在ReportService接口中声明导出运营数据报表的方法：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 导出近30天的运营数据报表</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> response</span><br><span class="hljs-comment">    **/</span><br>   <span class="hljs-keyword">void</span> <span class="hljs-title function_">exportBusinessData</span><span class="hljs-params">(HttpServletResponse response)</span>;<br></code></pre></td></tr></table></figure><h4 id="3-2-4-Service层实现类"><a href="#3-2-4-Service层实现类" class="headerlink" title="3.2.4 Service层实现类"></a>3.2.4 Service层实现类</h4><p><strong>在ReportServiceImpl实现类中实现导出运营数据报表的方法:</strong></p><p>提前将资料中的<strong>运营数据报表模板.xlsx</strong>拷贝到项目的resources/template目录中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**导出近30天的运营数据报表</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> response</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exportBusinessData</span><span class="hljs-params">(HttpServletResponse response)</span> &#123;<br>    <span class="hljs-type">LocalDate</span> <span class="hljs-variable">begin</span> <span class="hljs-operator">=</span> LocalDate.now().minusDays(<span class="hljs-number">30</span>);<br>    <span class="hljs-type">LocalDate</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> LocalDate.now().minusDays(<span class="hljs-number">1</span>);<br>    <span class="hljs-comment">//查询概览运营数据，提供给Excel模板文件</span><br>    <span class="hljs-type">BusinessDataVO</span> <span class="hljs-variable">businessData</span> <span class="hljs-operator">=</span> workspaceService.getBusinessData(LocalDateTime.of(begin,LocalTime.MIN), LocalDateTime.of(end, LocalTime.MAX));<br>    <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getClass().getClassLoader().getResourceAsStream(<span class="hljs-string">&quot;template/运营数据报表模板.xlsx&quot;</span>);<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//基于提供好的模板文件创建一个新的Excel表格对象</span><br>        <span class="hljs-type">XSSFWorkbook</span> <span class="hljs-variable">excel</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XSSFWorkbook</span>(inputStream);<br>        <span class="hljs-comment">//获得Excel文件中的一个Sheet页</span><br>        <span class="hljs-type">XSSFSheet</span> <span class="hljs-variable">sheet</span> <span class="hljs-operator">=</span> excel.getSheet(<span class="hljs-string">&quot;Sheet1&quot;</span>);<br><br>        sheet.getRow(<span class="hljs-number">1</span>).getCell(<span class="hljs-number">1</span>).setCellValue(begin + <span class="hljs-string">&quot;至&quot;</span> + end);<br>        <span class="hljs-comment">//获得第4行</span><br>        <span class="hljs-type">XSSFRow</span> <span class="hljs-variable">row</span> <span class="hljs-operator">=</span> sheet.getRow(<span class="hljs-number">3</span>);<br>        <span class="hljs-comment">//获取单元格</span><br>        row.getCell(<span class="hljs-number">2</span>).setCellValue(businessData.getTurnover());<br>        row.getCell(<span class="hljs-number">4</span>).setCellValue(businessData.getOrderCompletionRate());<br>        row.getCell(<span class="hljs-number">6</span>).setCellValue(businessData.getNewUsers());<br>        row = sheet.getRow(<span class="hljs-number">4</span>);<br>        row.getCell(<span class="hljs-number">2</span>).setCellValue(businessData.getValidOrderCount());<br>        row.getCell(<span class="hljs-number">4</span>).setCellValue(businessData.getUnitPrice());<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">30</span>; i++) &#123;<br>            <span class="hljs-type">LocalDate</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> begin.plusDays(i);<br>           <span class="hljs-comment">//准备明细数据</span><br>            businessData = workspaceService.getBusinessData(LocalDateTime.of(date,LocalTime.MIN), LocalDateTime.of(date, LocalTime.MAX));<br>            row = sheet.getRow(<span class="hljs-number">7</span> + i);<br>            row.getCell(<span class="hljs-number">1</span>).setCellValue(date.toString());<br>            row.getCell(<span class="hljs-number">2</span>).setCellValue(businessData.getTurnover());<br>            row.getCell(<span class="hljs-number">3</span>).setCellValue(businessData.getValidOrderCount());<br>            row.getCell(<span class="hljs-number">4</span>).setCellValue(businessData.getOrderCompletionRate());<br>            row.getCell(<span class="hljs-number">5</span>).setCellValue(businessData.getUnitPrice());<br>            row.getCell(<span class="hljs-number">6</span>).setCellValue(businessData.getNewUsers());<br>        &#125;<br>        <span class="hljs-comment">//通过输出流将文件下载到客户端浏览器中</span><br>        <span class="hljs-type">ServletOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> response.getOutputStream();<br>        excel.write(out);<br>        <span class="hljs-comment">//关闭资源</span><br>        out.flush();<br>        out.close();<br>        excel.close();<br><br>    &#125;<span class="hljs-keyword">catch</span> (IOException e)&#123;<br>        e.printStackTrace();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-3-功能测试"><a href="#3-3-功能测试" class="headerlink" title="3.3 功能测试"></a>3.3 功能测试</h3><p>直接使用前后端联调测试。</p><p><strong>进入数据统计</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355488.png" alt="image-20230131155111294" style="zoom:50%;" /> <p><strong>点击数据导出</strong>：Excel报表下载成功</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355489.png" alt="image-20230131160647328" style="zoom:50%;" /> <h3 id="3-4-代码提交"><a href="#3-4-代码提交" class="headerlink" title="3.4 代码提交"></a>3.4 代码提交</h3><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355490.png" alt="image-20230131160929202" style="zoom:50%;" /> <p>后续步骤和其它功能代码提交一致，不再赘述。</p>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
      <tag>项目</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>day11</title>
    <link href="/2024/12/13/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day11/"/>
    <url>/2024/12/13/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day11/</url>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js"></script><h1 id="苍穹外卖-day11"><a href="#苍穹外卖-day11" class="headerlink" title="苍穹外卖-day11"></a>苍穹外卖-day11</h1><h2 id="课程内容"><a href="#课程内容" class="headerlink" title="课程内容"></a>课程内容</h2><ul><li>Apache ECharts</li><li>营业额统计</li><li>用户统计</li><li>订单统计</li><li>销量排名Top10</li></ul><p>功能实现：<strong>数据统计</strong></p><p><strong>数据统计效果图：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355557.png" alt="image-20230101152725417" style="zoom:80%;" /> <h2 id="1-Apache-ECharts"><a href="#1-Apache-ECharts" class="headerlink" title="1. Apache ECharts"></a>1. Apache ECharts</h2><h3 id="1-1-介绍"><a href="#1-1-介绍" class="headerlink" title="1.1 介绍"></a>1.1 介绍</h3><p>Apache ECharts 是一款基于 Javascript 的数据可视化图表库，提供直观，生动，可交互，可个性化定制的数据可视化图表。<br>官网地址：<a href="https://echarts.apache.org/zh/index.html">https://echarts.apache.org/zh/index.html</a></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355559.png" alt="image-20230101153041348" style="zoom:50%;" /> <p><strong>常见效果展示：</strong></p><p>1). 柱形图</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355560.png" alt="image-20230101153748714" style="zoom:50%;" /> <p>2). 饼形图</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355561.png" alt="image-20230101153230868" style="zoom:50%;" /> <p>3). 折线图</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355562.png" alt="image-20230101153824086" style="zoom:50%;" /> <p><strong>总结：</strong>不管是哪种形式的图形，最本质的东西实际上是数据，它其实是对数据的一种可视化展示。</p><h3 id="1-2-入门案例"><a href="#1-2-入门案例" class="headerlink" title="1.2 入门案例"></a>1.2 入门案例</h3><p>Apache Echarts官方提供的快速入门：<a href="https://echarts.apache.org/handbook/zh/get-started/">https://echarts.apache.org/handbook/zh/get-started/</a></p><p><strong>效果展示：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355563.png" alt="image-20230101155524477" style="zoom:50%;" /> <p><strong>实现步骤：</strong></p><p>1). 引入echarts.js 文件(当天资料已提供)</p><p>2). 为 ECharts 准备一个设置宽高的 DOM</p><p>3). 初始化echarts实例</p><p>4). 指定图表的配置项和数据</p><p>5). 使用指定的配置项和数据显示图表</p><p><strong>代码开发：</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;utf-8&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>ECharts<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 引入刚刚下载的 ECharts 文件 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;echarts.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 为 ECharts 准备一个定义了宽高的 DOM --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;main&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;width: 600px;height:400px;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">      <span class="hljs-comment">// 基于准备好的dom，初始化echarts实例</span></span><br><span class="language-javascript">      <span class="hljs-keyword">var</span> myChart = echarts.<span class="hljs-title function_">init</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;main&#x27;</span>));</span><br><span class="language-javascript"></span><br><span class="language-javascript">      <span class="hljs-comment">// 指定图表的配置项和数据</span></span><br><span class="language-javascript">      <span class="hljs-keyword">var</span> option = &#123;</span><br><span class="language-javascript">        <span class="hljs-attr">title</span>: &#123;</span><br><span class="language-javascript">          <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;ECharts 入门示例&#x27;</span></span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript">        <span class="hljs-attr">tooltip</span>: &#123;&#125;,</span><br><span class="language-javascript">        <span class="hljs-attr">legend</span>: &#123;</span><br><span class="language-javascript">          <span class="hljs-attr">data</span>: [<span class="hljs-string">&#x27;销量&#x27;</span>]</span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript">        <span class="hljs-attr">xAxis</span>: &#123;</span><br><span class="language-javascript">          <span class="hljs-attr">data</span>: [<span class="hljs-string">&#x27;衬衫&#x27;</span>, <span class="hljs-string">&#x27;羊毛衫&#x27;</span>, <span class="hljs-string">&#x27;雪纺衫&#x27;</span>, <span class="hljs-string">&#x27;裤子&#x27;</span>, <span class="hljs-string">&#x27;高跟鞋&#x27;</span>, <span class="hljs-string">&#x27;袜子&#x27;</span>]</span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript">        <span class="hljs-attr">yAxis</span>: &#123;&#125;,</span><br><span class="language-javascript">        <span class="hljs-attr">series</span>: [</span><br><span class="language-javascript">          &#123;</span><br><span class="language-javascript">            <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;销量&#x27;</span>,</span><br><span class="language-javascript">            <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;bar&#x27;</span>,</span><br><span class="language-javascript">            <span class="hljs-attr">data</span>: [<span class="hljs-number">5</span>, <span class="hljs-number">20</span>, <span class="hljs-number">36</span>, <span class="hljs-number">10</span>, <span class="hljs-number">10</span>, <span class="hljs-number">20</span>]</span><br><span class="language-javascript">          &#125;</span><br><span class="language-javascript">        ]</span><br><span class="language-javascript">      &#125;;</span><br><span class="language-javascript"></span><br><span class="language-javascript">      <span class="hljs-comment">// 使用刚指定的配置项和数据显示图表。</span></span><br><span class="language-javascript">      myChart.<span class="hljs-title function_">setOption</span>(option);</span><br><span class="language-javascript">    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>测试：</strong>(当天资料中已提供)</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355564.png" alt="image-20230101160244104" style="zoom:50%;" /> <p>使用浏览器方式打开即可。</p><p><strong>总结：</strong>使用Echarts，重点在于研究当前图表所需的数据格式。通常是需要后端提供符合格式要求的动态数据，然后响应给前端来展示图表。</p><h2 id="2-营业额统计"><a href="#2-营业额统计" class="headerlink" title="2. 营业额统计"></a>2. 营业额统计</h2><h3 id="2-1-需求分析和设计"><a href="#2-1-需求分析和设计" class="headerlink" title="2.1 需求分析和设计"></a>2.1 需求分析和设计</h3><h4 id="2-1-1-产品原型"><a href="#2-1-1-产品原型" class="headerlink" title="2.1.1 产品原型"></a>2.1.1 产品原型</h4><p>营业额统计是基于折现图来展现，并且按照天来展示的。实际上，就是某一个时间范围之内的每一天的营业额。同时，不管光标放在哪个点上，那么它就会把具体的数值展示出来。并且还需要注意日期并不是固定写死的，是由上边时间选择器来决定。比如选择是近7天、或者是近30日，或者是本周，就会把相应这个时间段之内的每一天日期通过横坐标展示。</p><p><strong>原型图：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355565.png" alt="image-20230101160747433" style="zoom:50%;" /> <p><strong>业务规则：</strong></p><ul><li>营业额指订单状态为已完成的订单金额合计</li><li>基于可视化报表的折线图展示营业额数据，X轴为日期，Y轴为营业额</li><li>根据时间选择区间，展示每天的营业额数据</li></ul><h4 id="2-1-2-接口设计"><a href="#2-1-2-接口设计" class="headerlink" title="2.1.2 接口设计"></a>2.1.2 接口设计</h4><p>通过上述原型图，设计出对应的接口。</p><p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355566.png" alt="image-20230101160801758" style="zoom:50%;" /> <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355567.png" alt="image-20230101160812029" style="zoom:50%;" /> </p><p><strong>注意：</strong>具体返回数据一般由前端来决定，前端展示图表，具体折现图对应数据是什么格式，是有固定的要求的。<br>所以说，后端需要去适应前端，它需要什么格式的数据，我们就给它返回什么格式的数据。</p><h3 id="2-2-代码开发"><a href="#2-2-代码开发" class="headerlink" title="2.2 代码开发"></a>2.2 代码开发</h3><h4 id="2-2-1-VO设计"><a href="#2-2-1-VO设计" class="headerlink" title="2.2.1 VO设计"></a>2.2.1 VO设计</h4><p><strong>根据接口定义设计对应的VO：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355568.png" alt="image-20230101164058056" style="zoom:50%;" /> <p>在sky-pojo模块，TurnoverReportVO.java已定义</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.vo;<br><br><span class="hljs-keyword">import</span> lombok.AllArgsConstructor;<br><span class="hljs-keyword">import</span> lombok.Builder;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> lombok.NoArgsConstructor;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Builder</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TurnoverReportVO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-comment">//日期，以逗号分隔，例如：2022-10-01,2022-10-02,2022-10-03</span><br>    <span class="hljs-keyword">private</span> String dateList;<br><br>    <span class="hljs-comment">//营业额，以逗号分隔，例如：406.0,1520.0,75.0</span><br>    <span class="hljs-keyword">private</span> String turnoverList;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-2-2-Controller层"><a href="#2-2-2-Controller层" class="headerlink" title="2.2.2 Controller层"></a>2.2.2 Controller层</h4><p><strong>根据接口定义创建ReportController：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.controller.admin;<br><br><span class="hljs-keyword">import</span> com.sky.result.Result;<br><span class="hljs-keyword">import</span> com.sky.service.ReportService;<br><span class="hljs-keyword">import</span> com.sky.vo.TurnoverReportVO;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.format.annotation.DateTimeFormat;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><span class="hljs-keyword">import</span> java.time.LocalDate;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 报表</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/admin/report&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Api(tags = &quot;统计报表相关接口&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReportController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ReportService reportService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 营业额数据统计</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> begin</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> end</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;/turnoverStatistics&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;营业额数据统计&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;TurnoverReportVO&gt; <span class="hljs-title function_">turnoverStatistics</span><span class="hljs-params">(</span><br><span class="hljs-params">            <span class="hljs-meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span></span><br><span class="hljs-params">                    LocalDate begin,</span><br><span class="hljs-params">            <span class="hljs-meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span></span><br><span class="hljs-params">                    LocalDate end)</span> &#123;<br>        <span class="hljs-keyword">return</span> Result.success(reportService.getTurnover(begin, end));<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-2-3-Service层接口"><a href="#2-2-3-Service层接口" class="headerlink" title="2.2.3 Service层接口"></a>2.2.3 Service层接口</h4><p><strong>创建ReportService接口，声明getTurnover方法：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.service;<br><br><span class="hljs-keyword">import</span> com.sky.vo.TurnoverReportVO;<br><span class="hljs-keyword">import</span> java.time.LocalDate;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ReportService</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据时间区间统计营业额</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> beginTime</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> endTime</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    TurnoverReportVO <span class="hljs-title function_">getTurnover</span><span class="hljs-params">(LocalDate beginTime, LocalDate endTime)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-2-4-Service层实现类"><a href="#2-2-4-Service层实现类" class="headerlink" title="2.2.4 Service层实现类"></a>2.2.4 Service层实现类</h4><p><strong>创建ReportServiceImpl实现类，实现getTurnover方法:</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.service.impl;<br><br><span class="hljs-keyword">import</span> com.sky.entity.Orders;<br><span class="hljs-keyword">import</span> com.sky.mapper.OrderMapper;<br><span class="hljs-keyword">import</span> com.sky.service.ReportService;<br><span class="hljs-keyword">import</span> com.sky.vo.TurnoverReportVO;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.commons.lang.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> java.time.LocalDate;<br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><span class="hljs-keyword">import</span> java.time.LocalTime;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReportServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ReportService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderMapper orderMapper;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据时间区间统计营业额</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> begin</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> end</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> TurnoverReportVO <span class="hljs-title function_">getTurnover</span><span class="hljs-params">(LocalDate begin, LocalDate end)</span> &#123;<br>        List&lt;LocalDate&gt; dateList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        dateList.add(begin);<br><br>        <span class="hljs-keyword">while</span> (!begin.equals(end))&#123;<br>            begin = begin.plusDays(<span class="hljs-number">1</span>);<span class="hljs-comment">//日期计算，获得指定日期后1天的日期</span><br>            dateList.add(begin);<br>        &#125;<br>        <br>       List&lt;Double&gt; turnoverList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (LocalDate date : dateList) &#123;<br>            <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">beginTime</span> <span class="hljs-operator">=</span> LocalDateTime.of(date, LocalTime.MIN);<br>            <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> LocalDateTime.of(date, LocalTime.MAX);<br>            <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(<span class="hljs-string">&quot;status&quot;</span>, Orders.COMPLETED);<br>        map.put(<span class="hljs-string">&quot;begin&quot;</span>,beginTime);<br>        map.put(<span class="hljs-string">&quot;end&quot;</span>, endTime);<br>            <span class="hljs-type">Double</span> <span class="hljs-variable">turnover</span> <span class="hljs-operator">=</span> orderMapper.sumByMap(map); <br>            turnover = turnover == <span class="hljs-literal">null</span> ? <span class="hljs-number">0.0</span> : turnover;<br>            turnoverList.add(turnover);<br>        &#125;<br><br>        <span class="hljs-comment">//数据封装</span><br>        <span class="hljs-keyword">return</span> TurnoverReportVO.builder()<br>                .dateList(StringUtils.join(dateList,<span class="hljs-string">&quot;,&quot;</span>))<br>                .turnoverList(StringUtils.join(turnoverList,<span class="hljs-string">&quot;,&quot;</span>))<br>                .build();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-2-5-Mapper层"><a href="#2-2-5-Mapper层" class="headerlink" title="2.2.5 Mapper层"></a>2.2.5 Mapper层</h4><p><strong>在OrderMapper接口声明sumByMap方法：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 根据动态条件统计营业额</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> map</span><br><span class="hljs-comment">    */</span><br>   Double <span class="hljs-title function_">sumByMap</span><span class="hljs-params">(Map map)</span>;<br></code></pre></td></tr></table></figure><p><strong>在OrderMapper.xml文件中编写动态SQL：</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;sumByMap&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;java.lang.Double&quot;</span>&gt;</span><br>        select sum(amount) from orders<br>        <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;status != null&quot;</span>&gt;</span><br>                and status = #&#123;status&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;begin != null&quot;</span>&gt;</span><br>                and order_time <span class="hljs-symbol">&amp;gt;</span>= #&#123;begin&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;end != null&quot;</span>&gt;</span><br>                and order_time <span class="hljs-symbol">&amp;lt;</span>= #&#123;end&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="2-3-功能测试"><a href="#2-3-功能测试" class="headerlink" title="2.3 功能测试"></a>2.3 功能测试</h3><p>可以通过如下方式进行测试：</p><ul><li>接口文档测试</li><li>前后端联调测试</li></ul><p>启动服务器，启动nginx，直接采用前后端联调测试。</p><p>进入数据统计模块</p><p><strong>1). 查看近7日营业额统计</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355569.png" alt="image-20230101172807757" style="zoom:50%;" /> <p>进入开发者模式，查看返回数据</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355570.png" alt="image-20230101173031357" style="zoom:80%;" /> <p><strong>2). 查看近30日营业额统计</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355571.png" alt="image-20230101173201667" style="zoom:50%;" /> <p>进入开发者模式，查看返回数据</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355572.png" alt="image-20230101173304127" style="zoom:80%;" /> <p>也可通过断点方式启动，查看每步执行情况。</p><h3 id="2-4-代码提交"><a href="#2-4-代码提交" class="headerlink" title="2.4 代码提交"></a>2.4 代码提交</h3><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355573.png" alt="image-20230107183427167" style="zoom:50%;" /> <p>后续步骤和其它功能代码提交一致，不再赘述。</p><h2 id="3-用户统计"><a href="#3-用户统计" class="headerlink" title="3. 用户统计"></a>3. 用户统计</h2><h3 id="3-1-需求分析和设计"><a href="#3-1-需求分析和设计" class="headerlink" title="3.1 需求分析和设计"></a>3.1 需求分析和设计</h3><h4 id="3-1-1-产品原型"><a href="#3-1-1-产品原型" class="headerlink" title="3.1.1 产品原型"></a>3.1.1 产品原型</h4><p>所谓用户统计，实际上统计的是用户的数量。通过折线图来展示，上面这根蓝色线代表的是用户总量，下边这根绿色线代表的是新增用户数量，是具体到每一天。所以说用户统计主要统计<strong>两个数据</strong>，一个是<strong>总的用户数量</strong>，另外一个是<strong>新增用户数量</strong>。</p><p><strong>原型图：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355574.png" alt="image-20230102213727736" style="zoom:50%;" /> <p><strong>业务规则：</strong></p><ul><li>基于可视化报表的折线图展示用户数据，X轴为日期，Y轴为用户数</li><li>根据时间选择区间，展示每天的用户总量和新增用户量数据</li></ul><h4 id="3-1-2-接口设计"><a href="#3-1-2-接口设计" class="headerlink" title="3.1.2 接口设计"></a>3.1.2 接口设计</h4><p>根据上述原型图设计接口。</p><p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355575.png" alt="image-20230102213809414" style="zoom:50%;" /> <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355576.png" alt="image-20230102213818334" style="zoom:50%;" /> </p><h3 id="3-2-代码开发"><a href="#3-2-代码开发" class="headerlink" title="3.2 代码开发"></a>3.2 代码开发</h3><h4 id="3-2-1-VO设计"><a href="#3-2-1-VO设计" class="headerlink" title="3.2.1 VO设计"></a>3.2.1 VO设计</h4><p><strong>根据用户统计接口的返回结果设计VO：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355577.png" alt="image-20230102211004237" style="zoom:50%;" /> <p>在sky-pojo模块，UserReportVO.java已定义</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.vo;<br><br><span class="hljs-keyword">import</span> lombok.AllArgsConstructor;<br><span class="hljs-keyword">import</span> lombok.Builder;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> lombok.NoArgsConstructor;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Builder</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserReportVO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-comment">//日期，以逗号分隔，例如：2022-10-01,2022-10-02,2022-10-03</span><br>    <span class="hljs-keyword">private</span> String dateList;<br><br>    <span class="hljs-comment">//用户总量，以逗号分隔，例如：200,210,220</span><br>    <span class="hljs-keyword">private</span> String totalUserList;<br><br>    <span class="hljs-comment">//新增用户，以逗号分隔，例如：20,21,10</span><br>    <span class="hljs-keyword">private</span> String newUserList;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-2-2-Controller层"><a href="#3-2-2-Controller层" class="headerlink" title="3.2.2 Controller层"></a>3.2.2 Controller层</h4><p><strong>根据接口定义，在ReportController中创建userStatistics方法：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 用户数据统计</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> begin</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> end</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;/userStatistics&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;用户数据统计&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;UserReportVO&gt; <span class="hljs-title function_">userStatistics</span><span class="hljs-params">(</span><br><span class="hljs-params">            <span class="hljs-meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> LocalDate begin,</span><br><span class="hljs-params">            <span class="hljs-meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> LocalDate end)</span>&#123;<br><br>        <span class="hljs-keyword">return</span> Result.success(reportService.getUserStatistics(begin,end));            <br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-2-3-Service层接口"><a href="#3-2-3-Service层接口" class="headerlink" title="3.2.3 Service层接口"></a>3.2.3 Service层接口</h4><p><strong>在ReportService接口中声明getUserStatistics方法：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 根据时间区间统计用户数量</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> begin</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> end</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   UserReportVO <span class="hljs-title function_">getUserStatistics</span><span class="hljs-params">(LocalDate begin, LocalDate end)</span>;<br></code></pre></td></tr></table></figure><h4 id="3-2-4-Service层实现类"><a href="#3-2-4-Service层实现类" class="headerlink" title="3.2.4 Service层实现类"></a>3.2.4 Service层实现类</h4><p><strong>在ReportServiceImpl实现类中实现getUserStatistics方法：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>   <span class="hljs-keyword">public</span> UserReportVO <span class="hljs-title function_">getUserStatistics</span><span class="hljs-params">(LocalDate begin, LocalDate end)</span> &#123;<br>       List&lt;LocalDate&gt; dateList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>       dateList.add(begin);<br><br>       <span class="hljs-keyword">while</span> (!begin.equals(end))&#123;<br>           begin = begin.plusDays(<span class="hljs-number">1</span>);<br>           dateList.add(begin);<br>       &#125;<br>       List&lt;Integer&gt; newUserList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(); <span class="hljs-comment">//新增用户数</span><br>       List&lt;Integer&gt; totalUserList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(); <span class="hljs-comment">//总用户数</span><br><br>       <span class="hljs-keyword">for</span> (LocalDate date : dateList) &#123;<br>           <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">beginTime</span> <span class="hljs-operator">=</span> LocalDateTime.of(date, LocalTime.MIN);<br>           <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> LocalDateTime.of(date, LocalTime.MAX);<br>           <span class="hljs-comment">//新增用户数量 select count(id) from user where create_time &gt; ? and create_time &lt; ?</span><br>           <span class="hljs-type">Integer</span> <span class="hljs-variable">newUser</span> <span class="hljs-operator">=</span> getUserCount(beginTime, endTime);<br>           <span class="hljs-comment">//总用户数量 select count(id) from user where  create_time &lt; ?</span><br>           <span class="hljs-type">Integer</span> <span class="hljs-variable">totalUser</span> <span class="hljs-operator">=</span> getUserCount(<span class="hljs-literal">null</span>, endTime);<br><br>           newUserList.add(newUser);<br>           totalUserList.add(totalUser);<br>       &#125;<br><br>       <span class="hljs-keyword">return</span> UserReportVO.builder()<br>               .dateList(StringUtils.join(dateList,<span class="hljs-string">&quot;,&quot;</span>))<br>               .newUserList(StringUtils.join(newUserList,<span class="hljs-string">&quot;,&quot;</span>))<br>               .totalUserList(StringUtils.join(totalUserList,<span class="hljs-string">&quot;,&quot;</span>))<br>               .build();<br>   &#125;<br></code></pre></td></tr></table></figure><p><strong>在ReportServiceImpl实现类中创建私有方法getUserCount：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 根据时间区间统计用户数量</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> beginTime</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> endTime</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">private</span> Integer <span class="hljs-title function_">getUserCount</span><span class="hljs-params">(LocalDateTime beginTime, LocalDateTime endTime)</span> &#123;<br>       <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>       map.put(<span class="hljs-string">&quot;begin&quot;</span>,beginTime);<br>       map.put(<span class="hljs-string">&quot;end&quot;</span>, endTime);<br>       <span class="hljs-keyword">return</span> userMapper.countByMap(map);<br>   &#125;<br></code></pre></td></tr></table></figure><h4 id="3-2-5-Mapper层"><a href="#3-2-5-Mapper层" class="headerlink" title="3.2.5 Mapper层"></a>3.2.5 Mapper层</h4><p><strong>在UserMapper接口中声明countByMap方法：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 根据动态条件统计用户数量</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> map</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   Integer <span class="hljs-title function_">countByMap</span><span class="hljs-params">(Map map)</span>;<br></code></pre></td></tr></table></figure><p><strong>在UserMapper.xml文件中编写动态SQL：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;select id=<span class="hljs-string">&quot;countByMap&quot;</span> resultType=<span class="hljs-string">&quot;java.lang.Integer&quot;</span>&gt;<br>        select <span class="hljs-title function_">count</span><span class="hljs-params">(id)</span> from user<br>        &lt;where&gt;<br>            &lt;<span class="hljs-keyword">if</span> test=<span class="hljs-string">&quot;begin != null&quot;</span>&gt;<br>                and create_time &amp;gt;= #&#123;begin&#125;<br>            &lt;/<span class="hljs-keyword">if</span>&gt;<br>            &lt;<span class="hljs-keyword">if</span> test=<span class="hljs-string">&quot;end != null&quot;</span>&gt;<br>                and create_time &amp;lt;= #&#123;end&#125;<br>            &lt;/<span class="hljs-keyword">if</span>&gt;<br>        &lt;/where&gt;<br>&lt;/select&gt;<br></code></pre></td></tr></table></figure><h3 id="3-3-功能测试"><a href="#3-3-功能测试" class="headerlink" title="3.3 功能测试"></a>3.3 功能测试</h3><p>可以通过如下方式进行测试：</p><ul><li>接口文档测试</li><li>前后端联调测试</li></ul><p>进入数据统计模块</p><p><strong>1). 查看近7日用户统计</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355578.png" alt="image-20230107191339668" style="zoom:50%;" /> <p>进入开发者模式，查看返回数据</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355579.png" alt="image-20230107191532175" style="zoom:50%;" /> <p><strong>2). 查看近30日用户统计</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355580.png" alt="image-20230107191613369" style="zoom:50%;" /> <p>进入开发者模式，查看返回数据</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355581.png" alt="image-20230107191707568" style="zoom:50%;" /> <p>也可通过断点方式启动，查看每步执行情况。</p><h3 id="3-4-代码提交"><a href="#3-4-代码提交" class="headerlink" title="3.4 代码提交"></a>3.4 代码提交</h3><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355582.png" alt="image-20230107191949566" style="zoom:50%;" /> <p>后续步骤和其它功能代码提交一致，不再赘述。</p><h2 id="4-订单统计"><a href="#4-订单统计" class="headerlink" title="4. 订单统计"></a>4. 订单统计</h2><h3 id="4-1-需求分析和设计"><a href="#4-1-需求分析和设计" class="headerlink" title="4.1 需求分析和设计"></a>4.1 需求分析和设计</h3><h4 id="4-1-1-产品原型"><a href="#4-1-1-产品原型" class="headerlink" title="4.1.1 产品原型"></a>4.1.1 产品原型</h4><p>订单统计通过一个折现图来展现，折线图上有两根线，这根蓝色的线代表的是订单总数，而下边这根绿色的线代表的是有效订单数，指的就是状态是已完成的订单就属于有效订单，分别反映的是每一天的数据。上面还有3个数字，分别是订单总数、有效订单、订单完成率，它指的是整个时间区间之内总的数据。</p><p><strong>原型图：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355583.png" alt="image-20230107192859270" style="zoom:50%;" /> <p><strong>业务规则：</strong></p><ul><li>有效订单指状态为 “已完成” 的订单</li><li>基于可视化报表的折线图展示订单数据，X轴为日期，Y轴为订单数量</li><li>根据时间选择区间，展示每天的订单总数和有效订单数</li><li>展示所选时间区间内的有效订单数、总订单数、订单完成率，订单完成率 = 有效订单数 / 总订单数 * 100%</li></ul><h4 id="4-1-2-接口设计"><a href="#4-1-2-接口设计" class="headerlink" title="4.1.2 接口设计"></a>4.1.2 接口设计</h4><p>根据上述原型图设计接口。</p><p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355584.png" alt="image-20230107192942872" style="zoom:50%;" /> <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355585.png" alt="image-20230107192952958" style="zoom:50%;" /> </p><h3 id="4-2-代码开发"><a href="#4-2-代码开发" class="headerlink" title="4.2 代码开发"></a>4.2 代码开发</h3><h4 id="4-2-1-VO设计"><a href="#4-2-1-VO设计" class="headerlink" title="4.2.1 VO设计"></a>4.2.1 VO设计</h4><p><strong>根据订单统计接口的返回结果设计VO：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355586.png" alt="image-20230107195325915" style="zoom:50%;" /> <p>在sky-pojo模块，OrderReportVO.java已定义</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.vo;<br><br><span class="hljs-keyword">import</span> lombok.AllArgsConstructor;<br><span class="hljs-keyword">import</span> lombok.Builder;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> lombok.NoArgsConstructor;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Builder</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderReportVO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-comment">//日期，以逗号分隔，例如：2022-10-01,2022-10-02,2022-10-03</span><br>    <span class="hljs-keyword">private</span> String dateList;<br><br>    <span class="hljs-comment">//每日订单数，以逗号分隔，例如：260,210,215</span><br>    <span class="hljs-keyword">private</span> String orderCountList;<br><br>    <span class="hljs-comment">//每日有效订单数，以逗号分隔，例如：20,21,10</span><br>    <span class="hljs-keyword">private</span> String validOrderCountList;<br><br>    <span class="hljs-comment">//订单总数</span><br>    <span class="hljs-keyword">private</span> Integer totalOrderCount;<br><br>    <span class="hljs-comment">//有效订单数</span><br>    <span class="hljs-keyword">private</span> Integer validOrderCount;<br><br>    <span class="hljs-comment">//订单完成率</span><br>    <span class="hljs-keyword">private</span> Double orderCompletionRate;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="4-2-2-Controller层"><a href="#4-2-2-Controller层" class="headerlink" title="4.2.2 Controller层"></a>4.2.2 Controller层</h4><p><strong>在ReportController中根据订单统计接口创建orderStatistics方法：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 订单数据统计</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> begin</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> end</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;/ordersStatistics&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;用户数据统计&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;OrderReportVO&gt; <span class="hljs-title function_">orderStatistics</span><span class="hljs-params">(</span><br><span class="hljs-params">            <span class="hljs-meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span></span><br><span class="hljs-params">                    LocalDate begin,</span><br><span class="hljs-params">            <span class="hljs-meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span></span><br><span class="hljs-params">                    LocalDate end)</span>&#123;<br><br>        <span class="hljs-keyword">return</span> Result.success(reportService.getOrderStatistics(begin,end));<br>    &#125;<br></code></pre></td></tr></table></figure><h4 id="4-2-3-Service层接口"><a href="#4-2-3-Service层接口" class="headerlink" title="4.2.3 Service层接口"></a>4.2.3 Service层接口</h4><p><strong>在ReportService接口中声明getOrderStatistics方法：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 根据时间区间统计订单数量</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> begin </span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> end</span><br><span class="hljs-comment">* <span class="hljs-doctag">@return</span> </span><br><span class="hljs-comment">*/</span><br>OrderReportVO <span class="hljs-title function_">getOrderStatistics</span><span class="hljs-params">(LocalDate begin, LocalDate end)</span>;<br></code></pre></td></tr></table></figure><h4 id="4-2-4-Service层实现类"><a href="#4-2-4-Service层实现类" class="headerlink" title="4.2.4 Service层实现类"></a>4.2.4 Service层实现类</h4><p><strong>在ReportServiceImpl实现类中实现getOrderStatistics方法：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 根据时间区间统计订单数量</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> begin </span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> end</span><br><span class="hljs-comment">* <span class="hljs-doctag">@return</span> </span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> OrderReportVO <span class="hljs-title function_">getOrderStatistics</span><span class="hljs-params">(LocalDate begin, LocalDate end)</span>&#123;<br>List&lt;LocalDate&gt; dateList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    dateList.add(begin);<br><br>    <span class="hljs-keyword">while</span> (!begin.equals(end))&#123;<br>          begin = begin.plusDays(<span class="hljs-number">1</span>);<br>          dateList.add(begin);<br>     &#125;<br>    <span class="hljs-comment">//每天订单总数集合</span><br>     List&lt;Integer&gt; orderCountList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-comment">//每天有效订单数集合</span><br>    List&lt;Integer&gt; validOrderCountList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-keyword">for</span> (LocalDate date : dateList) &#123;<br>         <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">beginTime</span> <span class="hljs-operator">=</span> LocalDateTime.of(date, LocalTime.MIN);<br>         <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> LocalDateTime.of(date, LocalTime.MAX);<br>   <span class="hljs-comment">//查询每天的总订单数 select count(id) from orders where order_time &gt; ? and order_time &lt; ?</span><br>         <span class="hljs-type">Integer</span> <span class="hljs-variable">orderCount</span> <span class="hljs-operator">=</span> getOrderCount(beginTime, endTime, <span class="hljs-literal">null</span>);<br><br>  <span class="hljs-comment">//查询每天的有效订单数 select count(id) from orders where order_time &gt; ? and order_time &lt; ? and status = ?</span><br>         <span class="hljs-type">Integer</span> <span class="hljs-variable">validOrderCount</span> <span class="hljs-operator">=</span> getOrderCount(beginTime, endTime, Orders.COMPLETED);<br><br>         orderCountList.add(orderCount);<br>         validOrderCountList.add(validOrderCount);<br>        &#125;<br><br>    <span class="hljs-comment">//时间区间内的总订单数</span><br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">totalOrderCount</span> <span class="hljs-operator">=</span> orderCountList.stream().reduce(Integer::sum).get();<br>    <span class="hljs-comment">//时间区间内的总有效订单数</span><br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">validOrderCount</span> <span class="hljs-operator">=</span> validOrderCountList.stream().reduce(Integer::sum).get();<br>    <span class="hljs-comment">//订单完成率</span><br>    <span class="hljs-type">Double</span> <span class="hljs-variable">orderCompletionRate</span> <span class="hljs-operator">=</span> <span class="hljs-number">0.0</span>;<br>    <span class="hljs-keyword">if</span>(totalOrderCount != <span class="hljs-number">0</span>)&#123;<br>         orderCompletionRate = validOrderCount.doubleValue() / totalOrderCount;<br>     &#125;<br>    <span class="hljs-keyword">return</span> OrderReportVO.builder()<br>                .dateList(StringUtils.join(dateList, <span class="hljs-string">&quot;,&quot;</span>))<br>                .orderCountList(StringUtils.join(orderCountList, <span class="hljs-string">&quot;,&quot;</span>))<br>                .validOrderCountList(StringUtils.join(validOrderCountList, <span class="hljs-string">&quot;,&quot;</span>))<br>                .totalOrderCount(totalOrderCount)<br>                .validOrderCount(validOrderCount)<br>                .orderCompletionRate(orderCompletionRate)<br>                .build();<br>    <br>&#125;<br></code></pre></td></tr></table></figure><p><strong>在ReportServiceImpl实现类中提供私有方法getOrderCount：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 根据时间区间统计指定状态的订单数量</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> beginTime</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> endTime</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> status</span><br><span class="hljs-comment">* <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">private</span> Integer <span class="hljs-title function_">getOrderCount</span><span class="hljs-params">(LocalDateTime beginTime, LocalDateTime endTime, Integer status)</span> &#123;<br><span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>map.put(<span class="hljs-string">&quot;status&quot;</span>, status);<br>map.put(<span class="hljs-string">&quot;begin&quot;</span>,beginTime);<br>map.put(<span class="hljs-string">&quot;end&quot;</span>, endTime);<br><span class="hljs-keyword">return</span> orderMapper.countByMap(map);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="4-2-5-Mapper层"><a href="#4-2-5-Mapper层" class="headerlink" title="4.2.5 Mapper层"></a>4.2.5 Mapper层</h4><p><strong>在OrderMapper接口中声明countByMap方法：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">*根据动态条件统计订单数量</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> map</span><br><span class="hljs-comment">*/</span><br>Integer <span class="hljs-title function_">countByMap</span><span class="hljs-params">(Map map)</span>;<br></code></pre></td></tr></table></figure><p><strong>在OrderMapper.xml文件中编写动态SQL：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;select id=<span class="hljs-string">&quot;countByMap&quot;</span> resultType=<span class="hljs-string">&quot;java.lang.Integer&quot;</span>&gt;<br>        select <span class="hljs-title function_">count</span><span class="hljs-params">(id)</span> from orders<br>        &lt;where&gt;<br>            &lt;<span class="hljs-keyword">if</span> test=<span class="hljs-string">&quot;status != null&quot;</span>&gt;<br>                <span class="hljs-type">and</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> #&#123;status&#125;<br>            &lt;/<span class="hljs-keyword">if</span>&gt;<br>            &lt;<span class="hljs-keyword">if</span> test=<span class="hljs-string">&quot;begin != null&quot;</span>&gt;<br>                and order_time &amp;gt;= #&#123;begin&#125;<br>            &lt;/<span class="hljs-keyword">if</span>&gt;<br>            &lt;<span class="hljs-keyword">if</span> test=<span class="hljs-string">&quot;end != null&quot;</span>&gt;<br>                and order_time &amp;lt;= #&#123;end&#125;<br>            &lt;/<span class="hljs-keyword">if</span>&gt;<br>        &lt;/where&gt;<br>&lt;/select&gt;<br></code></pre></td></tr></table></figure><h3 id="4-3-功能测试"><a href="#4-3-功能测试" class="headerlink" title="4.3 功能测试"></a>4.3 功能测试</h3><p>可以通过如下方式进行测试：</p><ul><li>接口文档测试</li><li>前后端联调</li></ul><p>重启服务，直接采用前后端联调测试。</p><p>进入数据统计模块</p><p><strong>1). 查看近7日订单统计</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355587.png" alt="image-20230107202854533" style="zoom:50%;" /> <p>进入开发者模式，查看返回数据</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355588.png" alt="image-20230107202953128" style="zoom:50%;" /> <p><strong>2). 查看近30日订单统计</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355589.png" alt="image-20230107203025165" style="zoom:50%;" /> <p>进入开发者模式，查看返回数据</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355590.png" alt="image-20230107203127308" style="zoom:50%;" /> <p>也可通过断点方式启动，查看每步执行情况。</p><h3 id="4-4-代码提交"><a href="#4-4-代码提交" class="headerlink" title="4.4 代码提交"></a>4.4 代码提交</h3><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355591.png" alt="image-20230107203344774" style="zoom:50%;" /> <p>后续步骤和其它功能代码提交一致，不再赘述。</p><h2 id="5-销量排名Top10"><a href="#5-销量排名Top10" class="headerlink" title="5. 销量排名Top10"></a>5. 销量排名Top10</h2><h3 id="5-1-需求分析和设计"><a href="#5-1-需求分析和设计" class="headerlink" title="5.1 需求分析和设计"></a>5.1 需求分析和设计</h3><h4 id="5-1-1-产品原型"><a href="#5-1-1-产品原型" class="headerlink" title="5.1.1 产品原型"></a>5.1.1 产品原型</h4><p>所谓销量排名，销量指的是商品销售的数量。项目当中的商品主要包含两类：一个是<strong>套餐</strong>，一个是<strong>菜品</strong>，所以销量排名其实指的就是菜品和套餐销售的数量排名。通过柱形图来展示销量排名，这些销量是按照降序来排列，并且只需要统计销量排名前十的商品。</p><p><strong>原型图：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355592.png" alt="image-20230107203622747" style="zoom:50%;" /> <p><strong>业务规则：</strong></p><ul><li>根据时间选择区间，展示销量前10的商品（包括菜品和套餐）</li><li>基于可视化报表的柱状图降序展示商品销量</li><li>此处的销量为商品销售的份数</li></ul><h4 id="5-1-2-接口设计"><a href="#5-1-2-接口设计" class="headerlink" title="5.1.2 接口设计"></a>5.1.2 接口设计</h4><p>根据上述原型图设计接口。</p><p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355593.png" alt="image-20230107203720606" style="zoom:50%;" /> <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355594.png" alt="image-20230107203730681" style="zoom:50%;" /> </p><h3 id="5-2-代码开发"><a href="#5-2-代码开发" class="headerlink" title="5.2 代码开发"></a>5.2 代码开发</h3><h4 id="5-2-1-VO设计"><a href="#5-2-1-VO设计" class="headerlink" title="5.2.1 VO设计"></a>5.2.1 VO设计</h4><p><strong>根据销量排名接口的返回结果设计VO：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355595.png" alt="image-20230107204028895" style="zoom:50%;" /> <p>在sky-pojo模块，SalesTop10ReportVO.java已定义</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.vo;<br><br><span class="hljs-keyword">import</span> lombok.AllArgsConstructor;<br><span class="hljs-keyword">import</span> lombok.Builder;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> lombok.NoArgsConstructor;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Builder</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SalesTop10ReportVO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-comment">//商品名称列表，以逗号分隔，例如：鱼香肉丝,宫保鸡丁,水煮鱼</span><br>    <span class="hljs-keyword">private</span> String nameList;<br><br>    <span class="hljs-comment">//销量列表，以逗号分隔，例如：260,215,200</span><br>    <span class="hljs-keyword">private</span> String numberList;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="5-2-2-Controller层"><a href="#5-2-2-Controller层" class="headerlink" title="5.2.2 Controller层"></a>5.2.2 Controller层</h4><p><strong>在ReportController中根据销量排名接口创建top10方法：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 销量排名统计</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> begin</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> end</span><br><span class="hljs-comment">* <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">@GetMapping(&quot;/top10&quot;)</span><br><span class="hljs-meta">@ApiOperation(&quot;销量排名统计&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;SalesTop10ReportVO&gt; <span class="hljs-title function_">top10</span><span class="hljs-params">(</span><br><span class="hljs-params">    <span class="hljs-meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> LocalDate begin,</span><br><span class="hljs-params">    <span class="hljs-meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> LocalDate end)</span>&#123;<br><span class="hljs-keyword">return</span> Result.success(reportService.getSalesTop10(begin,end));<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="5-2-3-Service层接口"><a href="#5-2-3-Service层接口" class="headerlink" title="5.2.3 Service层接口"></a>5.2.3 Service层接口</h4><p><strong>在ReportService接口中声明getSalesTop10方法：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 查询指定时间区间内的销量排名top10 </span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> begin</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> end</span><br><span class="hljs-comment">* <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">*/</span><br>SalesTop10ReportVO <span class="hljs-title function_">getSalesTop10</span><span class="hljs-params">(LocalDate begin, LocalDate end)</span>;<br></code></pre></td></tr></table></figure><h4 id="5-2-4-Service层实现类"><a href="#5-2-4-Service层实现类" class="headerlink" title="5.2.4 Service层实现类"></a>5.2.4 Service层实现类</h4><p><strong>在ReportServiceImpl实现类中实现getSalesTop10方法：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询指定时间区间内的销量排名top10</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> begin</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> end</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * */</span><br>    <span class="hljs-keyword">public</span> SalesTop10ReportVO <span class="hljs-title function_">getSalesTop10</span><span class="hljs-params">(LocalDate begin, LocalDate end)</span>&#123;<br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">beginTime</span> <span class="hljs-operator">=</span> LocalDateTime.of(begin, LocalTime.MIN);<br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> LocalDateTime.of(end, LocalTime.MAX);<br>        List&lt;GoodsSalesDTO&gt; goodsSalesDTOList = orderMapper.getSalesTop10(beginTime, endTime);<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">nameList</span> <span class="hljs-operator">=</span> StringUtils.join(goodsSalesDTOList.stream().map(GoodsSalesDTO::getName).collect(Collectors.toList()),<span class="hljs-string">&quot;,&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">numberList</span> <span class="hljs-operator">=</span> StringUtils.join(goodsSalesDTOList.stream().map(GoodsSalesDTO::getNumber).collect(Collectors.toList()),<span class="hljs-string">&quot;,&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> SalesTop10ReportVO.builder()<br>                .nameList(nameList)<br>                .numberList(numberList)<br>                .build();<br>    &#125;<br></code></pre></td></tr></table></figure><h4 id="5-2-5-Mapper层"><a href="#5-2-5-Mapper层" class="headerlink" title="5.2.5 Mapper层"></a>5.2.5 Mapper层</h4><p><strong>在OrderMapper接口中声明getSalesTop10方法：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 查询商品销量排名</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> begin</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> end</span><br><span class="hljs-comment">*/</span><br>List&lt;GoodsSalesDTO&gt; <span class="hljs-title function_">getSalesTop10</span><span class="hljs-params">(LocalDateTime begin, LocalDateTime end)</span>;<br></code></pre></td></tr></table></figure><p><strong>在OrderMapper.xml文件中编写动态SQL：</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;getSalesTop10&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;com.sky.dto.GoodsSalesDTO&quot;</span>&gt;</span><br>        select od.name name,sum(od.number) number from order_detail od ,orders o<br>        where od.order_id = o.id<br>            and o.status = 5<br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;begin != null&quot;</span>&gt;</span><br>                and order_time <span class="hljs-symbol">&amp;gt;</span>= #&#123;begin&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;end != null&quot;</span>&gt;</span><br>                and order_time <span class="hljs-symbol">&amp;lt;</span>= #&#123;end&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        group by name<br>        order by number desc<br>        limit 0, 10<br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="5-3-功能测试"><a href="#5-3-功能测试" class="headerlink" title="5.3 功能测试"></a>5.3 功能测试</h3><p>可以通过如下方式进行测试：</p><ul><li>接口文档测试</li><li>前后端联调</li></ul><p>重启服务，直接采用前后端联调测试。</p><p><strong>查看近30日销量排名Top10统计</strong></p><p>若查询的某一段时间没有销量数据，则显示不出效果。</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355596.png" alt="image-20230107210518821" style="zoom:50%;" /> <p>进入开发者模式，查看返回数据</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355597.png" alt="image-20230107210711326" style="zoom:50%;" /> <p>也可通过断点方式启动，查看每步执行情况。</p><h3 id="5-4-代码提交"><a href="#5-4-代码提交" class="headerlink" title="5.4 代码提交"></a>5.4 代码提交</h3><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122355598.png" alt="image-20230107210835115" style="zoom:50%;" /> <p>后续步骤和其它功能代码提交一致，不再赘述。</p>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
      <tag>项目</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>day10</title>
    <link href="/2024/12/13/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10/"/>
    <url>/2024/12/13/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10/</url>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js"></script><h1 id="苍穹外卖-day10"><a href="#苍穹外卖-day10" class="headerlink" title="苍穹外卖-day10"></a>苍穹外卖-day10</h1><h2 id="课程内容"><a href="#课程内容" class="headerlink" title="课程内容"></a>课程内容</h2><ul><li>Spring Task</li><li>订单状态定时处理</li><li>WebSocket</li><li>来单提醒</li><li>客户催单</li></ul><p>功能实现：<strong>订单状态定时处理</strong>、<strong>来单提醒</strong>和<strong>客户催单</strong></p><p><strong>订单状态定时处理：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323070.png" alt="image-20221218204021760" style="zoom:50%;" /> <p><strong>来单提醒：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323072.png" alt="image-20221218204119663" style="zoom:50%;" /> <p><strong>客户催单：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323073.png" alt="image-20221218204202847" style="zoom:50%;" /> <h2 id="1-Spring-Task"><a href="#1-Spring-Task" class="headerlink" title="1. Spring Task"></a>1. Spring Task</h2><h3 id="1-1-介绍"><a href="#1-1-介绍" class="headerlink" title="1.1 介绍"></a>1.1 介绍</h3><p><strong>Spring Task</strong> 是Spring框架提供的任务调度工具，可以按照约定的时间自动执行某个代码逻辑。</p><p><strong>定位：</strong>定时任务框架</p><p><strong>作用：</strong>定时自动执行某段Java代码</p><p> <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323074.png" alt="image-20221218183054818" style="zoom:50%;" /> 为什么要在Java程序中使用Spring Task？</p><p><strong>应用场景：</strong></p><p>1). 信用卡每月还款提醒</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323075.png" alt="image-20221218183213088" style="zoom:50%;" /> <p>2). 银行贷款每月还款提醒</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323076.png" alt="image-20221218183410430" style="zoom:50%;" /> <p>3). 火车票售票系统处理未支付订单</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323077.png" alt="image-20221218183614351" style="zoom:50%;" /> <p>4). 入职纪念日为用户发送通知</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323078.png" alt="image-20221218183655186" style="zoom:50%;" /> <p><strong>强调：</strong>只要是需要定时处理的场景都可以使用Spring Task</p><h3 id="1-2-cron表达式"><a href="#1-2-cron表达式" class="headerlink" title="1.2 cron表达式"></a>1.2 cron表达式</h3><p><strong>cron表达式</strong>其实就是一个字符串，通过cron表达式可以<strong>定义任务触发的时间</strong></p><p><strong>构成规则：</strong>分为6或7个域，由空格分隔开，每个域代表一个含义</p><p>每个域的含义分别为：秒、分钟、小时、日、月、周、年(可选)</p><p><strong>举例：</strong></p><p>2022年10月12日上午9点整 对应的cron表达式为：<strong>0 0 9 12 10 ? 2022</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323079.png" alt="image-20221218184412491" style="zoom:50%;" /> <p><strong>说明：</strong>一般<strong>日</strong>和<strong>周</strong>的值不同时设置，其中一个设置，另一个用？表示。</p><p><strong>比如：</strong>描述2月份的最后一天，最后一天具体是几号呢？可能是28号，也有可能是29号，所以就不能写具体数字。</p><p>为了描述这些信息，提供一些特殊的字符。这些具体的细节，我们就不用自己去手写，因为这个cron表达式，它其实有在线生成器。</p><p>cron表达式在线生成器：<a href="https://cron.qqe2.com/">https://cron.qqe2.com/</a></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323080.png" alt="image-20221218184959888" style="zoom:50%;" /> <p>可以直接在这个网站上面，只要根据自己的要求去生成corn表达式即可。所以一般就不用自己去编写这个表达式。</p><p><strong>通配符：</strong></p><p>* 表示所有值； </p><p>? 表示未说明的值，即不关心它为何值； </p><p>- 表示一个指定的范围； </p><p>, 表示附加一个可能值； </p><p>/ 符号前表示开始时间，符号后表示每次递增的值；</p><p><strong>cron表达式案例：</strong></p><p>*/5 * * * * ? 每隔5秒执行一次</p><p>0 */1 * * * ? 每隔1分钟执行一次</p><p>0 0 5-15 * * ? 每天5-15点整点触发</p><p>0 0/3 * * * ? 每三分钟触发一次</p><p>0 0-5 14 * * ? 在每天下午2点到下午2:05期间的每1分钟触发 </p><p>0 0/5 14 * * ? 在每天下午2点到下午2:55期间的每5分钟触发</p><p>0 0/5 14,18 * * ? 在每天下午2点到2:55期间和下午6点到6:55期间的每5分钟触发</p><p>0 0/30 9-17 * * ? 朝九晚五工作时间内每半小时</p><p>0 0 10,14,16 * * ? 每天上午10点，下午2点，4点 </p><h3 id="1-3-入门案例"><a href="#1-3-入门案例" class="headerlink" title="1.3 入门案例"></a>1.3 入门案例</h3><h4 id="1-3-1-Spring-Task使用步骤"><a href="#1-3-1-Spring-Task使用步骤" class="headerlink" title="1.3.1 Spring Task使用步骤"></a>1.3.1 Spring Task使用步骤</h4><p>1). 导入maven坐标 spring-context（已存在）</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323081.png" alt="image-20221218193251182" style="zoom:50%;" /> <p>2). 启动类添加注解 @EnableScheduling 开启任务调度</p><p>3). 自定义定时任务类</p><h4 id="1-3-2-代码开发"><a href="#1-3-2-代码开发" class="headerlink" title="1.3.2 代码开发"></a>1.3.2 代码开发</h4><p><strong>编写定时任务类：</strong></p><p>进入sky-server模块中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.task;<br><br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.Scheduled;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 自定义定时任务类</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTask</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 定时任务 每隔5秒触发一次</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Scheduled(cron = &quot;0/5 * * * * ?&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeTask</span><span class="hljs-params">()</span>&#123;<br>        log.info(<span class="hljs-string">&quot;定时任务开始执行：&#123;&#125;&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>开启任务调度：</strong></p><p>启动类添加注解 @EnableScheduling</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky;<br><br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><span class="hljs-keyword">import</span> org.springframework.cache.annotation.EnableCaching;<br><span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.EnableScheduling;<br><span class="hljs-keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableTransactionManagement</span> <span class="hljs-comment">//开启注解方式的事务管理</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@EnableCaching</span><br><span class="hljs-meta">@EnableScheduling</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SkyApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(SkyApplication.class, args);<br>        log.info(<span class="hljs-string">&quot;server started&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="1-3-3-功能测试"><a href="#1-3-3-功能测试" class="headerlink" title="1.3.3 功能测试"></a>1.3.3 功能测试</h4><p>启动服务，查看日志</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323082.png" alt="image-20221218194511420" style="zoom:80%;" /> <p>每隔5秒执行一次。</p><h2 id="2-订单状态定时处理"><a href="#2-订单状态定时处理" class="headerlink" title="2.订单状态定时处理"></a>2.订单状态定时处理</h2><h3 id="2-1-需求分析"><a href="#2-1-需求分析" class="headerlink" title="2.1 需求分析"></a>2.1 需求分析</h3><p>用户下单后可能存在的情况：</p><ul><li>下单后未支付，订单一直处于<strong>“待支付”</strong>状态</li><li>用户收货后管理端未点击完成按钮，订单一直处于<strong>“派送中”</strong>状态</li></ul><p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323083.png" alt="image-20221218194939516" style="zoom:50%;" />                  <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323084.png" alt="image-20221218194951963" style="zoom:50%;" /></p><p>支付超时的订单如何处理？                                                       派送中的订单一直不点击完成如何处理？</p><p>对于上面两种情况需要通过<strong>定时任务</strong>来修改订单状态，具体逻辑为：</p><ul><li>通过定时任务每分钟检查一次是否存在支付超时订单（下单后超过15分钟仍未支付则判定为支付超时订单），如果存在则修改订单状态为“已取消”</li><li>通过定时任务每天凌晨1点检查一次是否存在“派送中”的订单，如果存在则修改订单状态为“已完成”</li></ul><h3 id="2-2-代码开发"><a href="#2-2-代码开发" class="headerlink" title="2.2 代码开发"></a>2.2 代码开发</h3><p><strong>1). 自定义定时任务类OrderTask（待完善）：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.task;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 自定义定时任务，实现订单状态定时处理</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderTask</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderMapper orderMapper;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 处理支付超时订单</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Scheduled(cron = &quot;0 * * * * ?&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processTimeoutOrder</span><span class="hljs-params">()</span>&#123;<br>        log.info(<span class="hljs-string">&quot;处理支付超时订单：&#123;&#125;&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 处理“派送中”状态的订单</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Scheduled(cron = &quot;0 0 1 * * ?&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processDeliveryOrder</span><span class="hljs-params">()</span>&#123;<br>        log.info(<span class="hljs-string">&quot;处理派送中订单：&#123;&#125;&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>2). 在OrderMapper接口中扩展方法:</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 根据状态和下单时间查询订单</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> status</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> orderTime</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@Select(&quot;select * from orders where status = #&#123;status&#125; and order_time &lt; #&#123;orderTime&#125;&quot;)</span><br>   List&lt;Orders&gt; <span class="hljs-title function_">getByStatusAndOrdertimeLT</span><span class="hljs-params">(Integer status, LocalDateTime orderTime)</span>;<br></code></pre></td></tr></table></figure><p><strong>3). 完善定时任务类的processTimeoutOrder方法：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 处理支付超时订单</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@Scheduled(cron = &quot;0 * * * * ?&quot;)</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processTimeoutOrder</span><span class="hljs-params">()</span>&#123;<br>       log.info(<span class="hljs-string">&quot;处理支付超时订单：&#123;&#125;&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br><br>       <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> LocalDateTime.now().plusMinutes(-<span class="hljs-number">15</span>);<br><br>       <span class="hljs-comment">// select * from orders where status = 1 and order_time &lt; 当前时间-15分钟</span><br>       List&lt;Orders&gt; ordersList = orderMapper.getByStatusAndOrdertimeLT(Orders.PENDING_PAYMENT, time);<br>       <span class="hljs-keyword">if</span>(ordersList != <span class="hljs-literal">null</span> &amp;&amp; ordersList.size() &gt; <span class="hljs-number">0</span>)&#123;<br>           ordersList.forEach(order -&gt; &#123;<br>               order.setStatus(Orders.CANCELLED);<br>               order.setCancelReason(<span class="hljs-string">&quot;支付超时，自动取消&quot;</span>);<br>               order.setCancelTime(LocalDateTime.now());<br>               orderMapper.update(order);<br>           &#125;);<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure><p><strong>4). 完善定时任务类的processDeliveryOrder方法：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 处理“派送中”状态的订单</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@Scheduled(cron = &quot;0 0 1 * * ?&quot;)</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processDeliveryOrder</span><span class="hljs-params">()</span>&#123;<br>       log.info(<span class="hljs-string">&quot;处理派送中订单：&#123;&#125;&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>       <span class="hljs-comment">// select * from orders where status = 4 and order_time &lt; 当前时间-1小时</span><br>       <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> LocalDateTime.now().plusMinutes(-<span class="hljs-number">60</span>);<br>       List&lt;Orders&gt; ordersList = orderMapper.getByStatusAndOrdertimeLT(Orders.DELIVERY_IN_PROGRESS, time);<br><br>       <span class="hljs-keyword">if</span>(ordersList != <span class="hljs-literal">null</span> &amp;&amp; ordersList.size() &gt; <span class="hljs-number">0</span>)&#123;<br>           ordersList.forEach(order -&gt; &#123;<br>               order.setStatus(Orders.COMPLETED);<br>               orderMapper.update(order);<br>           &#125;);<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure><h3 id="2-3-功能测试"><a href="#2-3-功能测试" class="headerlink" title="2.3 功能测试"></a>2.3 功能测试</h3><p>可以通过如下方式进行测试：</p><ul><li>查看控制台sql</li><li>查看数据库中数据变化</li></ul><p><strong>支付超时的订单测试：</strong></p><p><strong>1). 查看订单表</strong></p><p>有一条订单，状态为1。订单状态 1待付款 2待接单 3已接单 4派送中 5已完成 6已取消</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323085.png" alt="image-20221218202334773" style="zoom:50%;" /> <p><strong>2). 开启定时任务</strong></p><p>启动服务，观察控制台日志。处理支付超时订单任务每隔1分钟执行一次。</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323086.png" alt="image-20221218203045089" style="zoom:50%;" /> <p><strong>3). 再次查看订单表</strong></p><p>状态已更改为6，已取消。</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323087.png" alt="image-20221218203146535" style="zoom:80%;" /> <p>证明定时任务已生效。</p><p><strong>处理“派送中”状态的订单任务</strong>测试自已完成，测试步骤和上述一致。可适当修改cron表达式，改变任务执行频率，方便测试。</p><h2 id="3-WebSocket"><a href="#3-WebSocket" class="headerlink" title="3. WebSocket"></a>3. WebSocket</h2><h3 id="3-1-介绍"><a href="#3-1-介绍" class="headerlink" title="3.1 介绍"></a>3.1 介绍</h3><p>WebSocket 是基于 TCP 的一种新的<strong>网络协议</strong>。它实现了浏览器与服务器全双工通信——浏览器和服务器只需要完成一次握手，两者之间就可以创建<strong>持久性</strong>的连接， 并进行<strong>双向</strong>数据传输。</p><p><strong>HTTP协议和WebSocket协议对比：</strong></p><ul><li>HTTP是<strong>短连接</strong></li><li>WebSocket是<strong>长连接</strong></li><li>HTTP通信是<strong>单向</strong>的，基于请求响应模式</li><li>WebSocket支持<strong>双向</strong>通信</li><li>HTTP和WebSocket底层都是TCP连接</li></ul><p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323088.png" alt="image-20221222184340172" style="zoom:50%;" />           <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323089.png" alt="image-20221222184352573" style="zoom:50%;" /> </p><p><strong>思考：</strong>既然WebSocket支持双向通信，功能看似比HTTP强大，那么我们是不是可以基于WebSocket开发所有的业务功能？</p><p><strong>WebSocket缺点：</strong></p><p>服务器长期维护长连接需要一定的成本<br>各个浏览器支持程度不一<br>WebSocket 是长连接，受网络限制比较大，需要处理好重连</p><p><strong>结论：</strong>WebSocket并不能完全取代HTTP，它只适合在特定的场景下使用</p><p><strong>WebSocket应用场景：</strong></p><p>1). 视频弹幕</p><p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323090.png" alt="image-20221222184616570" style="zoom:50%;" />v</p><p>2). 网页聊天</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323091.png" alt="image-20221222184641675" style="zoom:50%;" /> <p>3). 体育实况更新</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323092.png" alt="image-20221222184714092" style="zoom:50%;" /> <p>4). 股票基金报价实时更新</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323093.png" alt="image-20221222184742094" style="zoom:50%;" /> <h3 id="3-2-入门案例"><a href="#3-2-入门案例" class="headerlink" title="3.2 入门案例"></a>3.2 入门案例</h3><h4 id="3-2-1-案例分析"><a href="#3-2-1-案例分析" class="headerlink" title="3.2.1 案例分析"></a>3.2.1 案例分析</h4><p><strong>需求：</strong>实现浏览器与服务器全双工通信。浏览器既可以向服务器发送消息，服务器也可主动向浏览器推送消息。</p><p><strong>效果展示：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323094.png" alt="image-20221222190401414" style="zoom:50%;" /> <p><strong>实现步骤：</strong></p><p>1). 直接使用websocket.html页面作为WebSocket客户端</p><p>2). 导入WebSocket的maven坐标</p><p>3). 导入WebSocket服务端组件WebSocketServer，用于和客户端通信</p><p>4). 导入配置类WebSocketConfiguration，注册WebSocket的服务端组件</p><p>5). 导入定时任务类WebSocketTask，定时向客户端推送数据</p><h4 id="3-2-2-代码开发"><a href="#3-2-2-代码开发" class="headerlink" title="3.2.2 代码开发"></a>3.2.2 代码开发</h4><p>1). 定义websocket.html页面(资料中已提供)</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">HTML</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>WebSocket Demo<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;send()&quot;</span>&gt;</span>发送消息<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;closeWebSocket()&quot;</span>&gt;</span>关闭连接<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;message&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">var</span> websocket = <span class="hljs-literal">null</span>;</span><br><span class="language-javascript">    <span class="hljs-keyword">var</span> clientId = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>().<span class="hljs-title function_">toString</span>(<span class="hljs-number">36</span>).<span class="hljs-title function_">substr</span>(<span class="hljs-number">2</span>);</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//判断当前浏览器是否支持WebSocket</span></span><br><span class="language-javascript">    <span class="hljs-keyword">if</span>(<span class="hljs-string">&#x27;WebSocket&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>)&#123;</span><br><span class="language-javascript">        <span class="hljs-comment">//连接WebSocket节点</span></span><br><span class="language-javascript">        websocket = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-string">&quot;ws://localhost:8080/ws/&quot;</span>+clientId);</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript">    <span class="hljs-keyword">else</span>&#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;Not support websocket&#x27;</span>)</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//连接发生错误的回调方法</span></span><br><span class="language-javascript">    websocket.<span class="hljs-property">onerror</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">setMessageInnerHTML</span>(<span class="hljs-string">&quot;error&quot;</span>);</span><br><span class="language-javascript">    &#125;;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//连接成功建立的回调方法</span></span><br><span class="language-javascript">    websocket.<span class="hljs-property">onopen</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">setMessageInnerHTML</span>(<span class="hljs-string">&quot;连接成功&quot;</span>);</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//接收到消息的回调方法</span></span><br><span class="language-javascript">    websocket.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>)&#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">setMessageInnerHTML</span>(event.<span class="hljs-property">data</span>);</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//连接关闭的回调方法</span></span><br><span class="language-javascript">    websocket.<span class="hljs-property">onclose</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">setMessageInnerHTML</span>(<span class="hljs-string">&quot;close&quot;</span>);</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。</span></span><br><span class="language-javascript">    <span class="hljs-variable language_">window</span>.<span class="hljs-property">onbeforeunload</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">        websocket.<span class="hljs-title function_">close</span>();</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//将消息显示在网页上</span></span><br><span class="language-javascript">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">setMessageInnerHTML</span>(<span class="hljs-params">innerHTML</span>)&#123;</span><br><span class="language-javascript">        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;message&#x27;</span>).<span class="hljs-property">innerHTML</span> += innerHTML + <span class="hljs-string">&#x27;&lt;br/&gt;&#x27;</span>;</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//发送消息</span></span><br><span class="language-javascript">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">send</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">        <span class="hljs-keyword">var</span> message = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;text&#x27;</span>).<span class="hljs-property">value</span>;</span><br><span class="language-javascript">        websocket.<span class="hljs-title function_">send</span>(message);</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-comment">//关闭连接</span></span><br><span class="language-javascript">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">closeWebSocket</span>(<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">        websocket.<span class="hljs-title function_">close</span>();</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p>2). 导入maven坐标</p><p>在sky-server模块pom.xml中已定义</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>3). 定义WebSocket服务端组件(资料中已提供)</p><p>直接导入到sky-server模块即可</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.websocket;<br><br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> javax.websocket.OnClose;<br><span class="hljs-keyword">import</span> javax.websocket.OnMessage;<br><span class="hljs-keyword">import</span> javax.websocket.OnOpen;<br><span class="hljs-keyword">import</span> javax.websocket.Session;<br><span class="hljs-keyword">import</span> javax.websocket.server.PathParam;<br><span class="hljs-keyword">import</span> javax.websocket.server.ServerEndpoint;<br><span class="hljs-keyword">import</span> java.util.Collection;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * WebSocket服务</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@ServerEndpoint(&quot;/ws/&#123;sid&#125;&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocketServer</span> &#123;<br><br>    <span class="hljs-comment">//存放会话对象</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;String, Session&gt; sessionMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 连接建立成功调用的方法</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@OnOpen</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onOpen</span><span class="hljs-params">(Session session, <span class="hljs-meta">@PathParam(&quot;sid&quot;)</span> String sid)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;客户端：&quot;</span> + sid + <span class="hljs-string">&quot;建立连接&quot;</span>);<br>        sessionMap.put(sid, session);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 收到客户端消息后调用的方法</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message 客户端发送过来的消息</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@OnMessage</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(String message, <span class="hljs-meta">@PathParam(&quot;sid&quot;)</span> String sid)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;收到来自客户端：&quot;</span> + sid + <span class="hljs-string">&quot;的信息:&quot;</span> + message);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 连接关闭调用的方法</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> sid</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@OnClose</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClose</span><span class="hljs-params">(<span class="hljs-meta">@PathParam(&quot;sid&quot;)</span> String sid)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;连接断开:&quot;</span> + sid);<br>        sessionMap.remove(sid);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 群发</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendToAllClient</span><span class="hljs-params">(String message)</span> &#123;<br>        Collection&lt;Session&gt; sessions = sessionMap.values();<br>        <span class="hljs-keyword">for</span> (Session session : sessions) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">//服务器向客户端发送消息</span><br>                session.getBasicRemote().sendText(message);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>4). 定义配置类，注册WebSocket的服务端组件(从资料中直接导入即可)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.config;<br><br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.web.socket.server.standard.ServerEndpointExporter;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * WebSocket配置类，用于注册WebSocket的Bean</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocketConfiguration</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> ServerEndpointExporter <span class="hljs-title function_">serverEndpointExporter</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerEndpointExporter</span>();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>5). 定义定时任务类，定时向客户端推送数据(从资料中直接导入即可)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.task;<br><br><span class="hljs-keyword">import</span> com.sky.websocket.WebSocketServer;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.Scheduled;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><span class="hljs-keyword">import</span> java.time.format.DateTimeFormatter;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocketTask</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> WebSocketServer webSocketServer;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 通过WebSocket每隔5秒向客户端发送消息</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Scheduled(cron = &quot;0/5 * * * * ?&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessageToClient</span><span class="hljs-params">()</span> &#123;<br>        webSocketServer.sendToAllClient(<span class="hljs-string">&quot;这是来自服务端的消息：&quot;</span> + DateTimeFormatter.ofPattern(<span class="hljs-string">&quot;HH:mm:ss&quot;</span>).format(LocalDateTime.now()));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-2-3-功能测试"><a href="#3-2-3-功能测试" class="headerlink" title="3.2.3 功能测试"></a>3.2.3 功能测试</h4><p>启动服务，打开websocket.html页面</p><p><strong>浏览器向服务器发送数据：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323095.png" alt="image-20221222192759049" style="zoom:50%;" /> <p><strong>服务器向浏览器间隔5秒推送数据：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323096.png" alt="image-20221222192926954" style="zoom:50%;" /> <h2 id="4-来单提醒"><a href="#4-来单提醒" class="headerlink" title="4. 来单提醒"></a>4. 来单提醒</h2><h3 id="4-1-需求分析和设计"><a href="#4-1-需求分析和设计" class="headerlink" title="4.1 需求分析和设计"></a>4.1 需求分析和设计</h3><p>用户下单并且支付成功后，需要第一时间通知外卖商家。通知的形式有如下两种：</p><ul><li>语音播报  <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323097.png" alt="image-20221222194413901" style="zoom:50%;" /></li><li>弹出提示框</li></ul><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323098.png" alt="image-20221222194450142" style="zoom:50%;" /> <p><strong>设计思路：</strong></p><ul><li>通过WebSocket实现管理端页面和服务端保持长连接状态</li><li>当客户支付后，调用WebSocket的相关API实现服务端向客户端推送消息</li><li>客户端浏览器解析服务端推送的消息，判断是来单提醒还是客户催单，进行相应的消息提示和语音播报</li><li>约定服务端发送给客户端浏览器的数据格式为JSON，字段包括：type，orderId，content<ul><li>type 为消息类型，1为来单提醒 2为客户催单</li><li>orderId 为订单id</li><li>content 为消息内容</li></ul></li></ul><h3 id="4-2-代码开发"><a href="#4-2-代码开发" class="headerlink" title="4.2 代码开发"></a>4.2 代码开发</h3><p><strong>在OrderServiceImpl中注入WebSocketServer对象，修改paySuccess方法，加入如下代码：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br>   <span class="hljs-keyword">private</span> WebSocketServer webSocketServer;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 支付成功，修改订单状态</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> outTradeNo</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">paySuccess</span><span class="hljs-params">(String outTradeNo)</span> &#123;<br>       <span class="hljs-comment">// 当前登录用户id</span><br>       <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> BaseContext.getCurrentId();<br><br>       <span class="hljs-comment">// 根据订单号查询当前用户的订单</span><br>       <span class="hljs-type">Orders</span> <span class="hljs-variable">ordersDB</span> <span class="hljs-operator">=</span> orderMapper.getByNumberAndUserId(outTradeNo, userId);<br><br>       <span class="hljs-comment">// 根据订单id更新订单的状态、支付方式、支付状态、结账时间</span><br>       <span class="hljs-type">Orders</span> <span class="hljs-variable">orders</span> <span class="hljs-operator">=</span> Orders.builder()<br>               .id(ordersDB.getId())<br>               .status(Orders.TO_BE_CONFIRMED)<br>               .payStatus(Orders.PAID)<br>               .checkoutTime(LocalDateTime.now())<br>               .build();<br><br>       orderMapper.update(orders);<br><span class="hljs-comment">//////////////////////////////////////////////</span><br>       <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>       map.put(<span class="hljs-string">&quot;type&quot;</span>, <span class="hljs-number">1</span>);<span class="hljs-comment">//消息类型，1表示来单提醒</span><br>       map.put(<span class="hljs-string">&quot;orderId&quot;</span>, orders.getId());<br>       map.put(<span class="hljs-string">&quot;content&quot;</span>, <span class="hljs-string">&quot;订单号：&quot;</span> + outTradeNo);<br><br>       <span class="hljs-comment">//通过WebSocket实现来单提醒，向客户端浏览器推送消息</span><br>       webSocketServer.sendToAllClient(JSON.toJSONString(map));<br>       <span class="hljs-comment">///////////////////////////////////////////////////</span><br>   &#125;<br></code></pre></td></tr></table></figure><h3 id="4-3-功能测试"><a href="#4-3-功能测试" class="headerlink" title="4.3 功能测试"></a>4.3 功能测试</h3><p>可以通过如下方式进行测试：</p><ul><li>查看浏览器调试工具数据交互过程</li><li>前后端联调</li></ul><p><strong>1). 登录管理端后台</strong></p><p>登录成功后，浏览器与服务器建立长连接</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323099.png" alt="image-20221222200842731" style="zoom:50%;" /> <p>查看控制台日志</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323100.png" alt="image-20221222200941497" style="zoom:50%;" /> <p><strong>2). 小程序端下单支付</strong></p><p>修改回调地址，利用内网穿透获取域名</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323101.png" alt="image-20221222201350616" style="zoom:50%;" /> <p>下单支付</p><p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323102.png" alt="image-20221222201718622" style="zoom:50%;" /> <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323103.png" alt="image-20221222201754866" style="zoom:50%;" /> <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323104.png" alt="image-20221222201826173" style="zoom:50%;" /> <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323105.png" alt="image-20221222202101677" style="zoom:50%;" /></p><p><strong>3). 查看来单提醒</strong></p><p>支付成功后，后台收到来单提醒，并有语音播报</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323106.png" alt="image-20221222202310953" style="zoom:50%;" /> <h3 id="4-4-代码提交"><a href="#4-4-代码提交" class="headerlink" title="4.4 代码提交"></a>4.4 代码提交</h3><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323107.png" alt="image-20221222202632141" style="zoom:50%;" /> <p>后续步骤和其它功能代码提交一致，不再赘述。</p><h2 id="5-客户催单"><a href="#5-客户催单" class="headerlink" title="5. 客户催单"></a>5. 客户催单</h2><h3 id="5-1-需求分析和设计"><a href="#5-1-需求分析和设计" class="headerlink" title="5.1 需求分析和设计"></a>5.1 需求分析和设计</h3><p>用户在小程序中点击催单按钮后，需要第一时间通知外卖商家。通知的形式有如下两种：</p><ul><li>语音播报 <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323108.png" alt="image-20221222203301218" style="zoom:50%;" /></li><li>弹出提示框</li></ul><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323109.png" alt="image-20221222203345829" style="zoom:50%;" /> <p><strong>设计思路：</strong></p><ul><li>通过WebSocket实现管理端页面和服务端保持长连接状态</li><li>当用户点击催单按钮后，调用WebSocket的相关API实现服务端向客户端推送消息</li><li>客户端浏览器解析服务端推送的消息，判断是来单提醒还是客户催单，进行相应的消息提示和语音播报<br>约定服务端发送给客户端浏览器的数据格式为JSON，字段包括：type，orderId，content<ul><li>type 为消息类型，1为来单提醒 2为客户催单</li><li>orderId 为订单id</li><li>content 为消息内容</li></ul></li></ul><p>当用户点击催单按钮时，向服务端发送请求。</p><p><strong>接口设计(催单)：</strong></p><p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323110.png" alt="image-20221222204415339" style="zoom:50%;" /> <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323111.png" alt="image-20221222204434174" style="zoom:50%;" /></p><h3 id="5-2-代码开发"><a href="#5-2-代码开发" class="headerlink" title="5.2 代码开发"></a>5.2 代码开发</h3><h4 id="5-2-1-Controller层"><a href="#5-2-1-Controller层" class="headerlink" title="5.2.1 Controller层"></a>5.2.1 Controller层</h4><p><strong>根据用户催单的接口定义，在user/OrderController中创建催单方法：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 用户催单</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@GetMapping(&quot;/reminder/&#123;id&#125;&quot;)</span><br>   <span class="hljs-meta">@ApiOperation(&quot;用户催单&quot;)</span><br>   <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">reminder</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;<br>       orderService.reminder(id);<br>       <span class="hljs-keyword">return</span> Result.success();<br>   &#125;<br></code></pre></td></tr></table></figure><h4 id="5-2-2-Service层接口"><a href="#5-2-2-Service层接口" class="headerlink" title="5.2.2 Service层接口"></a>5.2.2 Service层接口</h4><p><strong>在OrderService接口中声明reminder方法：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 用户催单</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">void</span> <span class="hljs-title function_">reminder</span><span class="hljs-params">(Long id)</span>;<br></code></pre></td></tr></table></figure><h4 id="5-2-3-Service层实现类"><a href="#5-2-3-Service层实现类" class="headerlink" title="5.2.3 Service层实现类"></a>5.2.3 Service层实现类</h4><p><strong>在OrderServiceImpl中实现reminder方法：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 用户催单</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reminder</span><span class="hljs-params">(Long id)</span> &#123;<br>       <span class="hljs-comment">// 查询订单是否存在</span><br>       <span class="hljs-type">Orders</span> <span class="hljs-variable">orders</span> <span class="hljs-operator">=</span> orderMapper.getById(id);<br>       <span class="hljs-keyword">if</span> (orders == <span class="hljs-literal">null</span>) &#123;<br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderBusinessException</span>(MessageConstant.ORDER_NOT_FOUND);<br>       &#125;<br><br>       <span class="hljs-comment">//基于WebSocket实现催单</span><br>       <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>       map.put(<span class="hljs-string">&quot;type&quot;</span>, <span class="hljs-number">2</span>);<span class="hljs-comment">//2代表用户催单</span><br>       map.put(<span class="hljs-string">&quot;orderId&quot;</span>, id);<br>       map.put(<span class="hljs-string">&quot;content&quot;</span>, <span class="hljs-string">&quot;订单号：&quot;</span> + orders.getNumber());<br>       webSocketServer.sendToAllClient(JSON.toJSONString(map));<br>   &#125;<br></code></pre></td></tr></table></figure><p>5.2.4 Mapper层</p><p><strong>在OrderMapper中添加getById：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 根据id查询订单</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@Select(&quot;select * from orders where id=#&#123;id&#125;&quot;)</span><br>   Orders <span class="hljs-title function_">getById</span><span class="hljs-params">(Long id)</span>;<br></code></pre></td></tr></table></figure><h3 id="5-3-功能测试"><a href="#5-3-功能测试" class="headerlink" title="5.3 功能测试"></a>5.3 功能测试</h3><p>可以通过如下方式进行测试：</p><ul><li>查看浏览器调试工具数据交互过程</li><li>前后端联调</li></ul><p><strong>1). 登录管理端后台</strong></p><p>登录成功后，浏览器与服务器建立长连接</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323099.png" alt="image-20221222200842731" style="zoom:50%;" /> <p>查看控制台日志</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323100.png" alt="image-20221222200941497" style="zoom:50%;" /> <p><strong>2). 用户进行催单</strong></p><p>用户可在订单列表或者订单详情，进行催单</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323112.png" alt="image-20221222210932942" style="zoom:50%;" /> <p><strong>3). 查看催单提醒</strong></p><p>既有催单弹窗，同时语音播报</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323113.png" alt="image-20221222211238000" style="zoom:50%;" /> <h3 id="5-4-代码提交"><a href="#5-4-代码提交" class="headerlink" title="5.4 代码提交"></a>5.4 代码提交</h3><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122323114.png" alt="image-20221222211740927" style="zoom:50%;" /> <p>后续步骤和其它功能代码提交一致，不再赘述。</p>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
      <tag>项目</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>day8</title>
    <link href="/2024/12/12/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08/"/>
    <url>/2024/12/12/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08/</url>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js"></script><h1 id="苍穹外卖-day08"><a href="#苍穹外卖-day08" class="headerlink" title="苍穹外卖-day08"></a>苍穹外卖-day08</h1><h2 id="课程内容"><a href="#课程内容" class="headerlink" title="课程内容"></a>课程内容</h2><ul><li>导入地址簿功能代码</li><li>用户下单</li><li>订单支付</li></ul><p>功能实现：<strong>用户下单</strong>、<strong>订单支付</strong></p><p><strong>用户下单效果图：</strong></p><p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356270.png" alt="image-20221214181127718" style="zoom:50%;" />    <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356271.png" alt="image-20221214181140570" style="zoom:50%;" />     </p><p><strong>订单支付效果图：</strong></p><p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122327808.png" alt="image-20221214181221426">    <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356272.png" alt="image-20221214181234208" style="zoom:50%;" />    <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356273.png" alt="image-20221214181301304" style="zoom:50%;" /></p><h2 id="1-导入地址簿功能代码"><a href="#1-导入地址簿功能代码" class="headerlink" title="1. 导入地址簿功能代码"></a>1. 导入地址簿功能代码</h2><h3 id="1-1-需求分析和设计"><a href="#1-1-需求分析和设计" class="headerlink" title="1.1 需求分析和设计"></a>1.1 需求分析和设计</h3><h4 id="1-1-1-产品原型"><a href="#1-1-1-产品原型" class="headerlink" title="1.1.1 产品原型"></a>1.1.1 产品原型</h4><p>地址簿，指的是消费者用户的地址信息，用户登录成功后可以维护自己的地址信息。同一个用户可以有多个地址信息，但是只能有一个<strong>默认地址</strong>。</p><p><strong>效果图：</strong></p><p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356274.png" alt="image-20221214183615228" style="zoom:50%;" />      <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356275.png" alt="image-20221214183626673" style="zoom:50%;" />       <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356276.png" alt="image-20221214183859446" style="zoom:50%;" /> </p><p>对于地址簿管理，我们需要实现以下几个功能： </p><ul><li>查询地址列表</li><li>新增地址</li><li>修改地址</li><li>删除地址</li><li>设置默认地址</li><li>查询默认地址</li></ul><h4 id="1-1-2-接口设计"><a href="#1-1-2-接口设计" class="headerlink" title="1.1.2 接口设计"></a>1.1.2 接口设计</h4><p>根据上述原型图先<strong>粗粒度</strong>设计接口，共包含7个接口。</p><p><strong>接口设计：</strong></p><ul><li>新增地址</li><li>查询登录用户所有地址</li><li>查询默认地址</li><li>根据id修改地址</li><li>根据id删除地址</li><li>根据id查询地址</li><li>设置默认地址</li></ul><p>接下来<strong>细粒度</strong>分析每个接口，明确每个接口的请求方式、请求路径、传入参数和返回值。</p><p><strong>1). 新增地址</strong></p><p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356277.png" alt="image-20221214185000982" style="zoom:50%;" /> <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356278.png" alt="image-20221214185013172" style="zoom:50%;" /> <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356279.png" alt="image-20221214185028575" style="zoom:50%;" /> </p><p><strong>2). 查询登录用户所有地址</strong></p><p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356280.png" alt="image-20221214185112802" style="zoom:50%;" /> <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356281.png" alt="image-20221214185124296" style="zoom:50%;" /> </p><p><strong>3). 查询默认地址</strong></p><p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356282.png" alt="image-20221214185209235" style="zoom:50%;" /> <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356283.png" alt="image-20221214185221421" style="zoom:50%;" /> </p><p><strong>4). 修改地址</strong></p><p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356284.png" alt="image-20221214185309798" style="zoom:50%;" /> <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356285.png" alt="image-20221214185321203" style="zoom:50%;" /> <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356286.png" alt="image-20221214185334356" style="zoom:50%;" /> </p><p><strong>5). 根据id删除地址</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356287.png" alt="image-20221214185443519" style="zoom:50%;" /> <p><strong>6). 根据id查询地址</strong></p><p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356288.png" alt="image-20221214185534450" style="zoom:50%;" /> <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356289.png" alt="image-20221214185545692" style="zoom:50%;" /> </p><p><strong>7). 设置默认地址</strong></p><p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356290.png" alt="image-20221214185622092" style="zoom:50%;" /> <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356291.png" alt="image-20221214185631755" style="zoom:50%;" /> </p><h4 id="1-1-3-表设计"><a href="#1-1-3-表设计" class="headerlink" title="1.1.3 表设计"></a>1.1.3 表设计</h4><p>用户的地址信息会存储在address_book表，即地址簿表中。具体表结构如下：</p><table><thead><tr><th><strong>字段名</strong></th><th><strong>数据类型</strong></th><th><strong>说明</strong></th><th><strong>备注</strong></th></tr></thead><tbody><tr><td>id</td><td>bigint</td><td>主键</td><td>自增</td></tr><tr><td>user_id</td><td>bigint</td><td>用户id</td><td>逻辑外键</td></tr><tr><td>consignee</td><td>varchar(50)</td><td>收货人</td><td></td></tr><tr><td>sex</td><td>varchar(2)</td><td>性别</td><td></td></tr><tr><td>phone</td><td>varchar(11)</td><td>手机号</td><td></td></tr><tr><td>province_code</td><td>varchar(12)</td><td>省份编码</td><td></td></tr><tr><td>province_name</td><td>varchar(32)</td><td>省份名称</td><td></td></tr><tr><td>city_code</td><td>varchar(12)</td><td>城市编码</td><td></td></tr><tr><td>city_name</td><td>varchar(32)</td><td>城市名称</td><td></td></tr><tr><td>district_code</td><td>varchar(12)</td><td>区县编码</td><td></td></tr><tr><td>district_name</td><td>varchar(32)</td><td>区县名称</td><td></td></tr><tr><td>detail</td><td>varchar(200)</td><td>详细地址信息</td><td>具体到门牌号</td></tr><tr><td>label</td><td>varchar(100)</td><td>标签</td><td>公司、家、学校</td></tr><tr><td>is_default</td><td>tinyint(1)</td><td>是否默认地址</td><td>1是 0否</td></tr></tbody></table><p>这里面有一个字段is_default，实际上我们在设置默认地址时，只需要更新这个字段就可以了。</p><h3 id="1-2-代码导入"><a href="#1-2-代码导入" class="headerlink" title="1.2 代码导入"></a>1.2 代码导入</h3><p>对于这一类的单表的增删改查，我们已经写过很多了，基本的开发思路都是一样的，那么本小节的用户地址簿管理的增删改查功能，我们就不再一一实现了，基本的代码我们都已经提供了，直接导入进来，做一个测试即可。</p><p>导入课程资料中的地址簿模块功能代码：</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356292.png" alt="image-20221214190135741" style="zoom:50%;" /> <p>进入到sky-server模块中</p><h4 id="1-2-1-Mapper层"><a href="#1-2-1-Mapper层" class="headerlink" title="1.2.1 Mapper层"></a>1.2.1 Mapper层</h4><p><strong>创建AddressBookMapper.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.mapper;<br><br><span class="hljs-keyword">import</span> com.sky.entity.AddressBook;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.*;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AddressBookMapper</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 条件查询</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> addressBook</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    List&lt;AddressBook&gt; <span class="hljs-title function_">list</span><span class="hljs-params">(AddressBook addressBook)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 新增</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> addressBook</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Insert(&quot;insert into address_book&quot; +</span><br><span class="hljs-meta">            &quot;        (user_id, consignee, phone, sex, province_code, province_name, city_code, city_name, district_code,&quot; +</span><br><span class="hljs-meta">            &quot;         district_name, detail, label, is_default)&quot; +</span><br><span class="hljs-meta">            &quot;        values (#&#123;userId&#125;, #&#123;consignee&#125;, #&#123;phone&#125;, #&#123;sex&#125;, #&#123;provinceCode&#125;, #&#123;provinceName&#125;, #&#123;cityCode&#125;, #&#123;cityName&#125;,&quot; +</span><br><span class="hljs-meta">            &quot;                #&#123;districtCode&#125;, #&#123;districtName&#125;, #&#123;detail&#125;, #&#123;label&#125;, #&#123;isDefault&#125;)&quot;)</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(AddressBook addressBook)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据id查询</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Select(&quot;select * from address_book where id = #&#123;id&#125;&quot;)</span><br>    AddressBook <span class="hljs-title function_">getById</span><span class="hljs-params">(Long id)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据id修改</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> addressBook</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(AddressBook addressBook)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据 用户id修改 是否默认地址</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> addressBook</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Update(&quot;update address_book set is_default = #&#123;isDefault&#125; where user_id = #&#123;userId&#125;&quot;)</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateIsDefaultByUserId</span><span class="hljs-params">(AddressBook addressBook)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据id删除地址</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Delete(&quot;delete from address_book where id = #&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteById</span><span class="hljs-params">(Long id)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>创建AddressBookMapper.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.sky.mapper.AddressBookMapper&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;list&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;AddressBook&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;AddressBook&quot;</span>&gt;</span><br>        select * from address_book<br>        <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;userId != null&quot;</span>&gt;</span><br>                and user_id = #&#123;userId&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;phone != null&quot;</span>&gt;</span><br>                and phone = #&#123;phone&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;isDefault != null&quot;</span>&gt;</span><br>                and is_default = #&#123;isDefault&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;update&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;addressBook&quot;</span>&gt;</span><br>        update address_book<br>        <span class="hljs-tag">&lt;<span class="hljs-name">set</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;consignee != null&quot;</span>&gt;</span><br>                consignee = #&#123;consignee&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;sex != null&quot;</span>&gt;</span><br>                sex = #&#123;sex&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;phone != null&quot;</span>&gt;</span><br>                phone = #&#123;phone&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;detail != null&quot;</span>&gt;</span><br>                detail = #&#123;detail&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;label != null&quot;</span>&gt;</span><br>                label = #&#123;label&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;isDefault != null&quot;</span>&gt;</span><br>                is_default = #&#123;isDefault&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">set</span>&gt;</span><br>        where id = #&#123;id&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="1-2-2-Service层"><a href="#1-2-2-Service层" class="headerlink" title="1.2.2 Service层"></a>1.2.2 Service层</h4><p><strong>创建AddressBookService.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.service;<br><br><span class="hljs-keyword">import</span> com.sky.entity.AddressBook;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AddressBookService</span> &#123;<br><br>    List&lt;AddressBook&gt; <span class="hljs-title function_">list</span><span class="hljs-params">(AddressBook addressBook)</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(AddressBook addressBook)</span>;<br><br>    AddressBook <span class="hljs-title function_">getById</span><span class="hljs-params">(Long id)</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(AddressBook addressBook)</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setDefault</span><span class="hljs-params">(AddressBook addressBook)</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteById</span><span class="hljs-params">(Long id)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>创建AddressBookServiceImpl.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.service.impl;<br><br><span class="hljs-keyword">import</span> com.sky.context.BaseContext;<br><span class="hljs-keyword">import</span> com.sky.entity.AddressBook;<br><span class="hljs-keyword">import</span> com.sky.mapper.AddressBookMapper;<br><span class="hljs-keyword">import</span> com.sky.service.AddressBookService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AddressBookServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AddressBookService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> AddressBookMapper addressBookMapper;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 条件查询</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> addressBook</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> List&lt;AddressBook&gt; <span class="hljs-title function_">list</span><span class="hljs-params">(AddressBook addressBook)</span> &#123;<br>        <span class="hljs-keyword">return</span> addressBookMapper.list(addressBook);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 新增地址</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> addressBook</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(AddressBook addressBook)</span> &#123;<br>        addressBook.setUserId(BaseContext.getCurrentId());<br>        addressBook.setIsDefault(<span class="hljs-number">0</span>);<br>        addressBookMapper.insert(addressBook);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据id查询</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> AddressBook <span class="hljs-title function_">getById</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-type">AddressBook</span> <span class="hljs-variable">addressBook</span> <span class="hljs-operator">=</span> addressBookMapper.getById(id);<br>        <span class="hljs-keyword">return</span> addressBook;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据id修改地址</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> addressBook</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(AddressBook addressBook)</span> &#123;<br>        addressBookMapper.update(addressBook);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 设置默认地址</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> addressBook</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setDefault</span><span class="hljs-params">(AddressBook addressBook)</span> &#123;<br>        <span class="hljs-comment">//1、将当前用户的所有地址修改为非默认地址 update address_book set is_default = ? where user_id = ?</span><br>        addressBook.setIsDefault(<span class="hljs-number">0</span>);<br>        addressBook.setUserId(BaseContext.getCurrentId());<br>        addressBookMapper.updateIsDefaultByUserId(addressBook);<br><br>        <span class="hljs-comment">//2、将当前地址改为默认地址 update address_book set is_default = ? where id = ?</span><br>        addressBook.setIsDefault(<span class="hljs-number">1</span>);<br>        addressBookMapper.update(addressBook);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据id删除地址</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteById</span><span class="hljs-params">(Long id)</span> &#123;<br>        addressBookMapper.deleteById(id);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="1-2-3-Controller层"><a href="#1-2-3-Controller层" class="headerlink" title="1.2.3 Controller层"></a>1.2.3 Controller层</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.controller.user;<br><br><span class="hljs-keyword">import</span> com.sky.context.BaseContext;<br><span class="hljs-keyword">import</span> com.sky.entity.AddressBook;<br><span class="hljs-keyword">import</span> com.sky.result.Result;<br><span class="hljs-keyword">import</span> com.sky.service.AddressBookService;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/user/addressBook&quot;)</span><br><span class="hljs-meta">@Api(tags = &quot;C端地址簿接口&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AddressBookController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> AddressBookService addressBookService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询当前登录用户的所有地址信息</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;/list&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;查询当前登录用户的所有地址信息&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;List&lt;AddressBook&gt;&gt; <span class="hljs-title function_">list</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">AddressBook</span> <span class="hljs-variable">addressBook</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AddressBook</span>();<br>        addressBook.setUserId(BaseContext.getCurrentId());<br>        List&lt;AddressBook&gt; list = addressBookService.list(addressBook);<br>        <span class="hljs-keyword">return</span> Result.success(list);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 新增地址</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> addressBook</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostMapping</span><br>    <span class="hljs-meta">@ApiOperation(&quot;新增地址&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">save</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> AddressBook addressBook)</span> &#123;<br>        addressBookService.save(addressBook);<br>        <span class="hljs-keyword">return</span> Result.success();<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;根据id查询地址&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;AddressBook&gt; <span class="hljs-title function_">getById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> &#123;<br>        <span class="hljs-type">AddressBook</span> <span class="hljs-variable">addressBook</span> <span class="hljs-operator">=</span> addressBookService.getById(id);<br>        <span class="hljs-keyword">return</span> Result.success(addressBook);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据id修改地址</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> addressBook</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PutMapping</span><br>    <span class="hljs-meta">@ApiOperation(&quot;根据id修改地址&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">update</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> AddressBook addressBook)</span> &#123;<br>        addressBookService.update(addressBook);<br>        <span class="hljs-keyword">return</span> Result.success();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 设置默认地址</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> addressBook</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PutMapping(&quot;/default&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;设置默认地址&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">setDefault</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> AddressBook addressBook)</span> &#123;<br>        addressBookService.setDefault(addressBook);<br>        <span class="hljs-keyword">return</span> Result.success();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据id删除地址</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@DeleteMapping</span><br>    <span class="hljs-meta">@ApiOperation(&quot;根据id删除地址&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">deleteById</span><span class="hljs-params">(Long id)</span> &#123;<br>        addressBookService.deleteById(id);<br>        <span class="hljs-keyword">return</span> Result.success();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询默认地址</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;default&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;查询默认地址&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;AddressBook&gt; <span class="hljs-title function_">getDefault</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//SQL:select * from address_book where user_id = ? and is_default = 1</span><br>        <span class="hljs-type">AddressBook</span> <span class="hljs-variable">addressBook</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AddressBook</span>();<br>        addressBook.setIsDefault(<span class="hljs-number">1</span>);<br>        addressBook.setUserId(BaseContext.getCurrentId());<br>        List&lt;AddressBook&gt; list = addressBookService.list(addressBook);<br><br>        <span class="hljs-keyword">if</span> (list != <span class="hljs-literal">null</span> &amp;&amp; list.size() == <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-keyword">return</span> Result.success(list.get(<span class="hljs-number">0</span>));<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> Result.error(<span class="hljs-string">&quot;没有查询到默认地址&quot;</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-3-功能测试"><a href="#1-3-功能测试" class="headerlink" title="1.3 功能测试"></a>1.3 功能测试</h3><p>可以通过如下方式进行测试：</p><ul><li>查看控制台sql和数据库中的数据变化</li><li>Swagger接口文档测试</li><li>前后端联调</li></ul><p>我们直接使用<strong>前后端联调</strong>测试：</p><p>启动后台服务，编译小程序</p><p>登录进入首页–&gt;进入个人中心–&gt;进入地址管理</p><p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356293.png" alt="image-20221214192141197" style="zoom:50%;" /> <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356294.png" alt="image-20221214192446868" style="zoom:50%;" /> <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356295.png" alt="image-20221214192610374" style="zoom:50%;" /> </p><p><strong>1). 新增收货地址</strong></p><p><strong>添加两条收货地址：</strong></p><p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356296.png" alt="image-20221214193135164" style="zoom:50%;" /> <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356297.png" alt="image-20221214193314440" style="zoom:50%;" /> </p><p><strong>查看收货地址：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356298.png" alt="image-20221214193437578" style="zoom:50%;" /> <p><strong>查看数据库：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356299.png" alt="image-20221214193552879" style="zoom:80%;" /> <p><strong>2). 设置默认收货地址</strong></p><p><strong>设置默认地址：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356300.png" alt="image-20221214193714137" style="zoom:50%;" /> <p><strong>查看数据库：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356301.png" alt="image-20221214193829043" style="zoom:80%;" /> <p><strong>3). 删除收货地址</strong></p><p><strong>进行编辑：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356302.png" alt="image-20221214194051783" style="zoom:50%;" /> <p><strong>删除地址：</strong></p><p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356303.png" alt="image-20221214194126920" style="zoom:50%;" /> <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356304.png" alt="image-20221214194227711" style="zoom:50%;" /></p><p><strong>查看数据库：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356305.png" alt="image-20221214194251343" style="zoom:80%;" /> <h3 id="1-4-代码提交"><a href="#1-4-代码提交" class="headerlink" title="1.4 代码提交"></a>1.4 代码提交</h3><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356306.png" alt="image-20221214204411614" style="zoom:50%;" /> <p>后续步骤和其它功能代码提交一致，不再赘述。</p><h2 id="2-用户下单"><a href="#2-用户下单" class="headerlink" title="2. 用户下单"></a>2. 用户下单</h2><h3 id="2-1-需求分析和设计"><a href="#2-1-需求分析和设计" class="headerlink" title="2.1 需求分析和设计"></a>2.1 需求分析和设计</h3><h4 id="2-1-1-产品原型"><a href="#2-1-1-产品原型" class="headerlink" title="2.1.1 产品原型"></a>2.1.1 产品原型</h4><p><strong>用户下单业务说明：</strong><br>在电商系统中，用户是通过下单的方式通知商家，用户已经购买了商品，需要商家进行备货和发货。<br>用户下单后会产生订单相关数据，订单数据需要能够体现如下信息：</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356307.png" alt="image-20221214195633802" style="zoom:50%;" /> <p>用户将菜品或者套餐加入购物车后，可以点击购物车中的 “去结算” 按钮，页面跳转到订单确认页面，点击 “去支付” 按钮则完成下单操作。</p><p><strong>用户点餐业务流程(效果图)：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356308.png" alt="image-20221214195913467" style="zoom:80%;" /> <h4 id="2-1-2-接口设计"><a href="#2-1-2-接口设计" class="headerlink" title="2.1.2 接口设计"></a>2.1.2 接口设计</h4><p><strong>接口分析：</strong></p><p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356309.png" alt="image-20221214200913654" style="zoom:50%;" /> <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356310.png" alt="image-20221214200959943" style="zoom:50%;" /> </p><p><strong>接口设计：</strong></p><p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356311.png" alt="image-20221214201211364" style="zoom:50%;" /> <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356312.png" alt="image-20221214201220993" style="zoom:50%;" /> <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356314.png" alt="image-20221214201236107" style="zoom:50%;" /> </p><h4 id="2-1-3-表设计"><a href="#2-1-3-表设计" class="headerlink" title="2.1.3 表设计"></a>2.1.3 表设计</h4><p>用户下单业务对应的数据表为orders表和order_detail表(一对多关系,一个订单关联多个订单明细)：</p><table><thead><tr><th>表名</th><th>含义</th><th>说明</th></tr></thead><tbody><tr><td>orders</td><td>订单表</td><td>主要存储订单的基本信息(如: 订单号、状态、金额、支付方式、下单用户、收件地址等)</td></tr><tr><td>order_detail</td><td>订单明细表</td><td>主要存储订单详情信息(如: 该订单关联的套餐及菜品的信息)</td></tr></tbody></table><p>具体的表结构如下: </p><p><strong>1). orders订单表</strong></p><table><thead><tr><th><strong>字段名</strong></th><th><strong>数据类型</strong></th><th><strong>说明</strong></th><th><strong>备注</strong></th></tr></thead><tbody><tr><td>id</td><td>bigint</td><td>主键</td><td>自增</td></tr><tr><td>number</td><td>varchar(50)</td><td>订单号</td><td></td></tr><tr><td>status</td><td>int</td><td>订单状态</td><td>1待付款 2待接单 3已接单 4派送中 5已完成 6已取消</td></tr><tr><td>user_id</td><td>bigint</td><td>用户id</td><td>逻辑外键</td></tr><tr><td>address_book_id</td><td>bigint</td><td>地址id</td><td>逻辑外键</td></tr><tr><td>order_time</td><td>datetime</td><td>下单时间</td><td></td></tr><tr><td>checkout_time</td><td>datetime</td><td>付款时间</td><td></td></tr><tr><td>pay_method</td><td>int</td><td>支付方式</td><td>1微信支付 2支付宝支付</td></tr><tr><td>pay_status</td><td>tinyint</td><td>支付状态</td><td>0未支付 1已支付 2退款</td></tr><tr><td>amount</td><td>decimal(10,2)</td><td>订单金额</td><td></td></tr><tr><td>remark</td><td>varchar(100)</td><td>备注信息</td><td></td></tr><tr><td>phone</td><td>varchar(11)</td><td>手机号</td><td>冗余字段</td></tr><tr><td>address</td><td>varchar(255)</td><td>详细地址信息</td><td>冗余字段</td></tr><tr><td>consignee</td><td>varchar(32)</td><td>收货人</td><td>冗余字段</td></tr><tr><td>cancel_reason</td><td>varchar(255)</td><td>订单取消原因</td><td></td></tr><tr><td>rejection_reason</td><td>varchar(255)</td><td>拒单原因</td><td></td></tr><tr><td>cancel_time</td><td>datetime</td><td>订单取消时间</td><td></td></tr><tr><td>estimated_delivery_time</td><td>datetime</td><td>预计送达时间</td><td></td></tr><tr><td>delivery_status</td><td>tinyint</td><td>配送状态</td><td>1立即送出 0选择具体时间</td></tr><tr><td>delivery_time</td><td>datetime</td><td>送达时间</td><td></td></tr><tr><td>pack_amount</td><td>int</td><td>打包费</td><td></td></tr><tr><td>tableware_number</td><td>int</td><td>餐具数量</td><td></td></tr><tr><td>tableware_status</td><td>tinyint</td><td>餐具数量状态</td><td>1按餐量提供 0选择具体数量</td></tr></tbody></table><p><strong>2). order_detail订单明细表</strong></p><table><thead><tr><th><strong>字段名</strong></th><th><strong>数据类型</strong></th><th><strong>说明</strong></th><th><strong>备注</strong></th></tr></thead><tbody><tr><td>id</td><td>bigint</td><td>主键</td><td>自增</td></tr><tr><td>name</td><td>varchar(32)</td><td>商品名称</td><td>冗余字段</td></tr><tr><td>image</td><td>varchar(255)</td><td>商品图片路径</td><td>冗余字段</td></tr><tr><td>order_id</td><td>bigint</td><td>订单id</td><td>逻辑外键</td></tr><tr><td>dish_id</td><td>bigint</td><td>菜品id</td><td>逻辑外键</td></tr><tr><td>setmeal_id</td><td>bigint</td><td>套餐id</td><td>逻辑外键</td></tr><tr><td>dish_flavor</td><td>varchar(50)</td><td>菜品口味</td><td></td></tr><tr><td>number</td><td>int</td><td>商品数量</td><td></td></tr><tr><td>amount</td><td>decimal(10,2)</td><td>商品单价</td><td></td></tr></tbody></table><p><strong>说明：</strong>用户提交订单时，需要往订单表orders中插入一条记录，并且需要往order_detail中插入一条或多条记录。</p><h3 id="2-2-代码开发"><a href="#2-2-代码开发" class="headerlink" title="2.2 代码开发"></a>2.2 代码开发</h3><h4 id="2-2-1-DTO设计"><a href="#2-2-1-DTO设计" class="headerlink" title="2.2.1 DTO设计"></a>2.2.1 DTO设计</h4><p><strong>根据用户下单接口的参数设计DTO：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356315.png" alt="image-20221214203913803" style="zoom:50%;" /> <p>在sky-pojo模块，OrdersSubmitDTO.java已定义</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.dto;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.JsonFormat;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.math.BigDecimal;<br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrdersSubmitDTO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-comment">//地址簿id</span><br>    <span class="hljs-keyword">private</span> Long addressBookId;<br>    <span class="hljs-comment">//付款方式</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> payMethod;<br>    <span class="hljs-comment">//备注</span><br>    <span class="hljs-keyword">private</span> String remark;<br>    <span class="hljs-comment">//预计送达时间</span><br>    <span class="hljs-meta">@JsonFormat(shape = JsonFormat.Shape.STRING, pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span><br>    <span class="hljs-keyword">private</span> LocalDateTime estimatedDeliveryTime;<br>    <span class="hljs-comment">//配送状态  1立即送出  0选择具体时间</span><br>    <span class="hljs-keyword">private</span> Integer deliveryStatus;<br>    <span class="hljs-comment">//餐具数量</span><br>    <span class="hljs-keyword">private</span> Integer tablewareNumber;<br>    <span class="hljs-comment">//餐具数量状态  1按餐量提供  0选择具体数量</span><br>    <span class="hljs-keyword">private</span> Integer tablewareStatus;<br>    <span class="hljs-comment">//打包费</span><br>    <span class="hljs-keyword">private</span> Integer packAmount;<br>    <span class="hljs-comment">//总金额</span><br>    <span class="hljs-keyword">private</span> BigDecimal amount;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-2-2-VO设计"><a href="#2-2-2-VO设计" class="headerlink" title="2.2.2 VO设计"></a>2.2.2 VO设计</h4><p><strong>根据用户下单接口的返回结果设计VO：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356316.png" alt="image-20221214204113316" style="zoom:50%;" /> <p>在sky-pojo模块，OrderSubmitVO.java已定义</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.vo;<br><br><span class="hljs-keyword">import</span> lombok.AllArgsConstructor;<br><span class="hljs-keyword">import</span> lombok.Builder;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> lombok.NoArgsConstructor;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.math.BigDecimal;<br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Builder</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderSubmitVO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-comment">//订单id</span><br>    <span class="hljs-keyword">private</span> Long id;<br>    <span class="hljs-comment">//订单号</span><br>    <span class="hljs-keyword">private</span> String orderNumber;<br>    <span class="hljs-comment">//订单金额</span><br>    <span class="hljs-keyword">private</span> BigDecimal orderAmount;<br>    <span class="hljs-comment">//下单时间</span><br>    <span class="hljs-keyword">private</span> LocalDateTime orderTime;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-2-3-Controller层"><a href="#2-2-3-Controller层" class="headerlink" title="2.2.3 Controller层"></a>2.2.3 Controller层</h4><p><strong>创建OrderController并提供用户下单方法：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.controller.user;<br><br><span class="hljs-keyword">import</span> com.sky.dto.OrdersPaymentDTO;<br><span class="hljs-keyword">import</span> com.sky.dto.OrdersSubmitDTO;<br><span class="hljs-keyword">import</span> com.sky.result.PageResult;<br><span class="hljs-keyword">import</span> com.sky.result.Result;<br><span class="hljs-keyword">import</span> com.sky.service.OrderService;<br><span class="hljs-keyword">import</span> com.sky.vo.OrderPaymentVO;<br><span class="hljs-keyword">import</span> com.sky.vo.OrderSubmitVO;<br><span class="hljs-keyword">import</span> com.sky.vo.OrderVO;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 订单</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RestController(&quot;userOrderController&quot;)</span><br><span class="hljs-meta">@RequestMapping(&quot;/user/order&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Api(tags = &quot;C端-订单接口&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderService orderService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 用户下单</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> ordersSubmitDTO</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostMapping(&quot;/submit&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;用户下单&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;OrderSubmitVO&gt; <span class="hljs-title function_">submit</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> OrdersSubmitDTO ordersSubmitDTO)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;用户下单：&#123;&#125;&quot;</span>, ordersSubmitDTO);<br>        <span class="hljs-type">OrderSubmitVO</span> <span class="hljs-variable">orderSubmitVO</span> <span class="hljs-operator">=</span> orderService.submitOrder(ordersSubmitDTO);<br>        <span class="hljs-keyword">return</span> Result.success(orderSubmitVO);<br>    &#125; <br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-2-4-Service层接口"><a href="#2-2-4-Service层接口" class="headerlink" title="2.2.4 Service层接口"></a>2.2.4 Service层接口</h4><p><strong>创建OrderService接口，并声明用户下单方法：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.service;<br><br><span class="hljs-keyword">import</span> com.sky.dto.*;<br><span class="hljs-keyword">import</span> com.sky.vo.OrderSubmitVO;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderService</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 用户下单</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> ordersSubmitDTO</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    OrderSubmitVO <span class="hljs-title function_">submitOrder</span><span class="hljs-params">(OrdersSubmitDTO ordersSubmitDTO)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-2-5-Service层实现类"><a href="#2-2-5-Service层实现类" class="headerlink" title="2.2.5 Service层实现类"></a>2.2.5 Service层实现类</h4><p><strong>创建OrderServiceImpl实现OrderService接口：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.service.impl;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 订单</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OrderService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderMapper orderMapper;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderDetailMapper orderDetailMapper;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ShoppingCartMapper shoppingCartMapper;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> AddressBookMapper addressBookMapper;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 用户下单</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> ordersSubmitDTO</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-keyword">public</span> OrderSubmitVO <span class="hljs-title function_">submitOrder</span><span class="hljs-params">(OrdersSubmitDTO ordersSubmitDTO)</span> &#123;<br>        <span class="hljs-comment">//异常情况的处理（收货地址为空、超出配送范围、购物车为空）</span><br>        <span class="hljs-type">AddressBook</span> <span class="hljs-variable">addressBook</span> <span class="hljs-operator">=</span> addressBookMapper.getById(ordersSubmitDTO.getAddressBookId());<br>        <span class="hljs-keyword">if</span> (addressBook == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AddressBookBusinessException</span>(MessageConstant.ADDRESS_BOOK_IS_NULL);<br>        &#125;<br><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> BaseContext.getCurrentId();<br>        <span class="hljs-type">ShoppingCart</span> <span class="hljs-variable">shoppingCart</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShoppingCart</span>();<br>        shoppingCart.setUserId(userId);<br><br>        <span class="hljs-comment">//查询当前用户的购物车数据</span><br>        List&lt;ShoppingCart&gt; shoppingCartList = shoppingCartMapper.list(shoppingCart);<br>        <span class="hljs-keyword">if</span> (shoppingCartList == <span class="hljs-literal">null</span> || shoppingCartList.size() == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShoppingCartBusinessException</span>(MessageConstant.SHOPPING_CART_IS_NULL);<br>        &#125;<br><br>        <span class="hljs-comment">//构造订单数据</span><br>        <span class="hljs-type">Orders</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Orders</span>();<br>        BeanUtils.copyProperties(ordersSubmitDTO,order);<br>        order.setPhone(addressBook.getPhone());<br>        order.setAddress(addressBook.getDetail());<br>        order.setConsignee(addressBook.getConsignee());<br>        order.setNumber(String.valueOf(System.currentTimeMillis()));<br>        order.setUserId(userId);<br>        order.setStatus(Orders.PENDING_PAYMENT);<br>        order.setPayStatus(Orders.UN_PAID);<br>        order.setOrderTime(LocalDateTime.now());<br><br>        <span class="hljs-comment">//向订单表插入1条数据</span><br>        orderMapper.insert(order);<br><br>        <span class="hljs-comment">//订单明细数据</span><br>        List&lt;OrderDetail&gt; orderDetailList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (ShoppingCart cart : shoppingCartList) &#123;<br>            <span class="hljs-type">OrderDetail</span> <span class="hljs-variable">orderDetail</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderDetail</span>();<br>            BeanUtils.copyProperties(cart, orderDetail);<br>            orderDetail.setOrderId(order.getId());<br>            orderDetailList.add(orderDetail);<br>        &#125;<br><br>        <span class="hljs-comment">//向明细表插入n条数据</span><br>        orderDetailMapper.insertBatch(orderDetailList);<br><br>        <span class="hljs-comment">//清理购物车中的数据</span><br>        shoppingCartMapper.deleteByUserId(userId);<br><br>        <span class="hljs-comment">//封装返回结果</span><br>        <span class="hljs-type">OrderSubmitVO</span> <span class="hljs-variable">orderSubmitVO</span> <span class="hljs-operator">=</span> OrderSubmitVO.builder()<br>                .id(order.getId())<br>                .orderNumber(order.getNumber())<br>                .orderAmount(order.getAmount())<br>                .orderTime(order.getOrderTime())<br>                .build();<br><br>        <span class="hljs-keyword">return</span> orderSubmitVO;<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-2-6-Mapper层"><a href="#2-2-6-Mapper层" class="headerlink" title="2.2.6 Mapper层"></a>2.2.6 Mapper层</h4><p><strong>创建OrderMapper接口和对应的xml映射文件：</strong></p><p>OrderMapper.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.mapper;<br><br><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderMapper</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 插入订单数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> order</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(Orders order)</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>OrderMapper.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.sky.mapper.OrderMapper&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;insert&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;Orders&quot;</span> <span class="hljs-attr">useGeneratedKeys</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">keyProperty</span>=<span class="hljs-string">&quot;id&quot;</span>&gt;</span><br>        insert into orders<br>        (number, status, user_id, address_book_id, order_time, checkout_time, pay_method, pay_status, amount, remark,<br>         phone, address, consignee, estimated_delivery_time, delivery_status, pack_amount, tableware_number,<br>         tableware_status)<br>        values (#&#123;number&#125;, #&#123;status&#125;, #&#123;userId&#125;, #&#123;addressBookId&#125;, #&#123;orderTime&#125;, #&#123;checkoutTime&#125;, #&#123;payMethod&#125;,<br>                #&#123;payStatus&#125;, #&#123;amount&#125;, #&#123;remark&#125;, #&#123;phone&#125;, #&#123;address&#125;, #&#123;consignee&#125;,<br>                #&#123;estimatedDeliveryTime&#125;, #&#123;deliveryStatus&#125;, #&#123;packAmount&#125;, #&#123;tablewareNumber&#125;, #&#123;tablewareStatus&#125;)<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p><strong>创建OrderDetailMapper接口和对应的xml映射文件：</strong></p><p>OrderDetailMapper.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.mapper;<br><br><span class="hljs-keyword">import</span> com.sky.entity.OrderDetail;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderDetailMapper</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 批量插入订单明细数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> orderDetails</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertBatch</span><span class="hljs-params">(List&lt;OrderDetail&gt; orderDetails)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>OrderDetailMapper.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.sky.mapper.OrderDetailMapper&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;insertBatch&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;list&quot;</span>&gt;</span><br>        insert into order_detail<br>        (name, order_id, dish_id, setmeal_id, dish_flavor, number, amount, image)<br>        values<br>        <span class="hljs-tag">&lt;<span class="hljs-name">foreach</span> <span class="hljs-attr">collection</span>=<span class="hljs-string">&quot;orderDetails&quot;</span> <span class="hljs-attr">item</span>=<span class="hljs-string">&quot;od&quot;</span> <span class="hljs-attr">separator</span>=<span class="hljs-string">&quot;,&quot;</span>&gt;</span><br>            (#&#123;od.name&#125;,#&#123;od.orderId&#125;,#&#123;od.dishId&#125;,#&#123;od.setmealId&#125;,#&#123;od.dishFlavor&#125;,<br>             #&#123;od.number&#125;,#&#123;od.amount&#125;,#&#123;od.image&#125;)<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">foreach</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="2-3-功能测试"><a href="#2-3-功能测试" class="headerlink" title="2.3 功能测试"></a>2.3 功能测试</h3><p>登录小程序，完成下单操作</p><p>下单操作时，同时会删除购物车中的数据</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356317.png" alt="image-20221214214128415" style="zoom:50%;" /> <p><strong>查看shopping_cart表：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356318.png" alt="image-20221214214642428" style="zoom: 80%;" /> <p><strong>去结算–&gt;去支付</strong></p><p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356319.png" alt="image-20221214214808218" style="zoom:50%;" /> <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356320.png" alt="image-20221214214852362" style="zoom:50%;" /> </p><p><strong>查看orders表：</strong></p><p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356321.png" alt="image-20221214215116451"></p><p><strong>查看order_detail表：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356322.png" alt="image-20221214215250553" style="zoom:80%;" /> <p><strong>同时，购物车表中数据删除：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356323.png" alt="image-20221214215428516" style="zoom:80%;" /> <h3 id="2-4-代码提交"><a href="#2-4-代码提交" class="headerlink" title="2.4 代码提交"></a>2.4 代码提交</h3><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356324.png" alt="image-20221214215650664" style="zoom:50%;" /> <p>后续步骤和其它功能代码提交一致，不再赘述。</p><h2 id="3-订单支付"><a href="#3-订单支付" class="headerlink" title="3. 订单支付"></a>3. 订单支付</h2><h3 id="3-1-微信支付介绍"><a href="#3-1-微信支付介绍" class="headerlink" title="3.1 微信支付介绍"></a>3.1 微信支付介绍</h3><p>前面的课程已经实现了用户下单，那接下来就是订单支付，就是完成付款功能。支付大家应该都不陌生了，在现实生活中经常购买商品并且使用支付功能来付款，在付款的时候可能使用比较多的就是微信支付和支付宝支付了。在苍穹外卖项目中，选择的就是<strong>微信支付</strong>这种支付方式。</p><p>要实现微信支付就需要注册微信支付的一个商户号，这个商户号是必须要有一家企业并且有正规的营业执照。只有具备了这些资质之后，才可以去注册商户号，才能开通支付权限。</p><p>个人不具备这种资质，所以我们在学习微信支付时，最重要的是了解微信支付的流程，并且能够阅读微信官方提供的接口文档，能够和第三方支付平台对接起来就可以了。</p><p><strong>微信支付产品：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356325.png" alt="image-20221214223302651" style="zoom:50%;" /> <p>本项目选择<strong>小程序支付</strong></p><p>参考：<a href="https://pay.weixin.qq.com/static/product/product_index.shtml">https://pay.weixin.qq.com/static/product/product_index.shtml</a></p><p><strong>微信支付接入流程：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356326.png" alt="image-20221214223509246" style="zoom:50%;" /> <p><strong>微信小程序支付时序图：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356327.png" alt="image-20221214223910840" style="zoom:50%;" /> <p><strong>微信支付相关接口：</strong></p><p><strong>JSAPI下单：</strong>商户系统调用该接口在微信支付服务后台生成预支付交易单(对应时序图的第5步)</p><p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356328.png" alt="image-20221214224409174"></p><p><strong>微信小程序调起支付：</strong>通过JSAPI下单接口获取到发起支付的必要参数prepay_id，然后使用微信支付提供的小程序方法调起小程序支付(对应时序图的第10步)</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356329.png" alt="image-20221214224551220" style="zoom:50%;" /> <h3 id="3-2-微信支付准备工作"><a href="#3-2-微信支付准备工作" class="headerlink" title="3.2 微信支付准备工作"></a>3.2 微信支付准备工作</h3><h4 id="3-2-1-如何保证数据安全？"><a href="#3-2-1-如何保证数据安全？" class="headerlink" title="3.2.1 如何保证数据安全？"></a>3.2.1 如何保证数据安全？</h4><p>完成微信支付有两个关键的步骤：</p><p><strong>第一个</strong>就是需要在商户系统当中调用微信后台的一个下单接口，就是生成预支付交易单。</p><p><strong>第二个</strong>就是支付成功之后微信后台会给推送消息。</p><p>这两个接口数据的安全性，要求其实是非常高的。</p><p><strong>解决：</strong>微信提供的方式就是对数据进行加密、解密、签名多种方式。要完成数据加密解密，需要提前准备相应的一些文件，其实就是一些证书。</p><p><strong>获取微信支付平台证书、商户私钥文件：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356330.png" alt="image-20221214234038395" style="zoom:50%;" /> <p>在后绪程序开发过程中，就会使用到这两个文件，需要提前把这两个文件准备好。</p><h4 id="3-2-2-如何调用到商户系统？"><a href="#3-2-2-如何调用到商户系统？" class="headerlink" title="3.2.2 如何调用到商户系统？"></a>3.2.2 如何调用到商户系统？</h4><p>微信后台会调用到商户系统给推送支付的结果，在这里我们就会遇到一个问题，就是微信后台怎么就能调用到我们这个商户系统呢？因为这个调用过程，其实本质上也是一个HTTP请求。</p><p>目前，商户系统它的ip地址就是当前自己电脑的ip地址，只是一个局域网内的ip地址，微信后台无法调用到。</p><p><strong>解决：</strong>内网穿透。通过<strong>cpolar软件</strong>可以获得一个临时域名，而这个临时域名是一个公网ip，这样，微信后台就可以请求到商户系统了。</p><p><strong>cpolar软件的使用：</strong></p><p><strong>1). 下载与安装</strong></p><p>下载地址：<a href="https://dashboard.cpolar.com/get-started">https://dashboard.cpolar.com/get-started</a></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356331.png" alt="image-20221215184407217" style="zoom:50%;" /> <p>在资料中已提供，可无需下载。</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356332.png" alt="image-20221215184446260" style="zoom:80%;" /> <p>安装过程中，一直下一步即可，不再演示。</p><p><strong>2). cpolar指定authtoken</strong></p><p>复制authtoken：</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356333.png" alt="image-20221215184746092" style="zoom:50%;" /> <p>执行命令：</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356334.png" alt="image-20221215185152869" style="zoom:50%;" /> <p><strong>3). 获取临时域名</strong></p><p>执行命令：</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356335.png" alt="image-20221215185749163" style="zoom:50%;" /> <p>获取域名：</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356336.png" alt="image-20221215185833157" style="zoom:50%;" /> <p><strong>4). 验证临时域名有效性</strong></p><p><strong>访问接口文档</strong></p><p>使用localhost:8080访问</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356337.png" alt="image-20221215190440717" style="zoom:50%;" /> <p>使用临时域名访问</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356338.png" alt="image-20221215190525166" style="zoom:50%;" /> <p>证明临时域名生效。</p><h3 id="3-3-代码导入"><a href="#3-3-代码导入" class="headerlink" title="3.3 代码导入"></a>3.3 代码导入</h3><p>导入资料中的微信支付功能代码即可</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356339.png" alt="image-20221215192120424" style="zoom:50%;" /> <h4 id="3-3-1-微信支付相关配置"><a href="#3-3-1-微信支付相关配置" class="headerlink" title="3.3.1 微信支付相关配置"></a>3.3.1 微信支付相关配置</h4><p>application-dev.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">sky:</span><br>  <span class="hljs-attr">wechat:</span><br>    <span class="hljs-attr">appid:</span> <span class="hljs-string">wxcd2e39f677fd30ba</span><br>    <span class="hljs-attr">secret:</span> <span class="hljs-string">84fbfdf5ea288f0c432d829599083637</span><br>    <span class="hljs-attr">mchid :</span> <span class="hljs-number">1561414331</span><br>    <span class="hljs-attr">mchSerialNo:</span> <span class="hljs-string">4B3B3DC35414AD50B1B755BAF8DE9CC7CF407606</span><br>    <span class="hljs-attr">privateKeyFilePath:</span> <span class="hljs-string">D:\apiclient_key.pem</span><br>    <span class="hljs-attr">apiV3Key:</span> <span class="hljs-string">CZBK51236435wxpay435434323FFDuv3</span><br>    <span class="hljs-attr">weChatPayCertFilePath:</span> <span class="hljs-string">D:\wechatpay_166D96F876F45C7D07CE98952A96EC980368ACFC.pem</span><br>    <span class="hljs-attr">notifyUrl:</span> <span class="hljs-string">https://www.weixin.qq.com/wxpay/pay.php</span><br>    <span class="hljs-attr">refundNotifyUrl:</span> <span class="hljs-string">https://www.weixin.qq.com/wxpay/pay.php</span><br></code></pre></td></tr></table></figure><p>application.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">sky:</span><br>  <span class="hljs-attr">wechat:</span><br>    <span class="hljs-attr">appid:</span> <span class="hljs-string">$&#123;sky.wechat.appid&#125;</span><br>    <span class="hljs-attr">secret:</span> <span class="hljs-string">$&#123;sky.wechat.secret&#125;</span><br>    <span class="hljs-attr">mchid :</span> <span class="hljs-string">$&#123;sky.wechat.mchid&#125;</span><br>    <span class="hljs-attr">mchSerialNo:</span> <span class="hljs-string">$&#123;sky.wechat.mchSerialNo&#125;</span><br>    <span class="hljs-attr">privateKeyFilePath:</span> <span class="hljs-string">$&#123;sky.wechat.privateKeyFilePath&#125;</span><br>    <span class="hljs-attr">apiV3Key:</span> <span class="hljs-string">$&#123;sky.wechat.apiV3Key&#125;</span><br>    <span class="hljs-attr">weChatPayCertFilePath:</span> <span class="hljs-string">$&#123;sky.wechat.weChatPayCertFilePath&#125;</span><br>    <span class="hljs-attr">notifyUrl:</span> <span class="hljs-string">$&#123;sky.wechat.notifyUrl&#125;</span><br>    <span class="hljs-attr">refundNotifyUrl:</span> <span class="hljs-string">$&#123;sky.wechat.refundNotifyUrl&#125;</span><br><br></code></pre></td></tr></table></figure><p>WeChatProperties.java：读取配置(已定义)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.properties;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@ConfigurationProperties(prefix = &quot;sky.wechat&quot;)</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeChatProperties</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String appid; <span class="hljs-comment">//小程序的appid</span><br>    <span class="hljs-keyword">private</span> String secret; <span class="hljs-comment">//小程序的秘钥</span><br>    <span class="hljs-keyword">private</span> String mchid; <span class="hljs-comment">//商户号</span><br>    <span class="hljs-keyword">private</span> String mchSerialNo; <span class="hljs-comment">//商户API证书的证书序列号</span><br>    <span class="hljs-keyword">private</span> String privateKeyFilePath; <span class="hljs-comment">//商户私钥文件</span><br>    <span class="hljs-keyword">private</span> String apiV3Key; <span class="hljs-comment">//证书解密的密钥</span><br>    <span class="hljs-keyword">private</span> String weChatPayCertFilePath; <span class="hljs-comment">//平台证书</span><br>    <span class="hljs-keyword">private</span> String notifyUrl; <span class="hljs-comment">//支付成功的回调地址</span><br>    <span class="hljs-keyword">private</span> String refundNotifyUrl; <span class="hljs-comment">//退款成功的回调地址</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-3-2-Mapper层"><a href="#3-3-2-Mapper层" class="headerlink" title="3.3.2 Mapper层"></a>3.3.2 Mapper层</h4><p><strong>在OrderMapper.java中添加getByNumberAndUserId和update两个方法</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 根据订单号和用户id查询订单</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> orderNumber</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> userId</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@Select(&quot;select * from orders where number = #&#123;orderNumber&#125; and user_id= #&#123;userId&#125;&quot;)</span><br>   Orders <span class="hljs-title function_">getByNumberAndUserId</span><span class="hljs-params">(String orderNumber, Long userId)</span>;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 修改订单信息</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> orders</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Orders orders)</span>;<br></code></pre></td></tr></table></figure><p><strong>在OrderMapper.xml中添加</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;update&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;com.sky.entity.Orders&quot;</span>&gt;</span><br>        update orders<br>        <span class="hljs-tag">&lt;<span class="hljs-name">set</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;cancelReason != null and cancelReason!=&#x27;&#x27; &quot;</span>&gt;</span><br>                cancel_reason=#&#123;cancelReason&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;rejectionReason != null and rejectionReason!=&#x27;&#x27; &quot;</span>&gt;</span><br>                rejection_reason=#&#123;rejectionReason&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;cancelTime != null&quot;</span>&gt;</span><br>                cancel_time=#&#123;cancelTime&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;payStatus != null&quot;</span>&gt;</span><br>                pay_status=#&#123;payStatus&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;payMethod != null&quot;</span>&gt;</span><br>                pay_method=#&#123;payMethod&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;checkoutTime != null&quot;</span>&gt;</span><br>                checkout_time=#&#123;checkoutTime&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;status != null&quot;</span>&gt;</span><br>                status = #&#123;status&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;deliveryTime != null&quot;</span>&gt;</span><br>                delivery_time = #&#123;deliveryTime&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">set</span>&gt;</span><br>        where id = #&#123;id&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="3-3-3-Service层"><a href="#3-3-3-Service层" class="headerlink" title="3.3.3 Service层"></a>3.3.3 Service层</h4><p><strong>在OrderService.java中添加payment和paySuccess两个方法定义</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 订单支付</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> ordersPaymentDTO</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   OrderPaymentVO <span class="hljs-title function_">payment</span><span class="hljs-params">(OrdersPaymentDTO ordersPaymentDTO)</span> <span class="hljs-keyword">throws</span> Exception;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 支付成功，修改订单状态</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> outTradeNo</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">void</span> <span class="hljs-title function_">paySuccess</span><span class="hljs-params">(String outTradeNo)</span>;<br></code></pre></td></tr></table></figure><p><strong>在OrderServiceImpl.java中实现payment和paySuccess两个方法</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br>   <span class="hljs-keyword">private</span> UserMapper userMapper;<br><span class="hljs-meta">@Autowired</span><br>   <span class="hljs-keyword">private</span> WeChatPayUtil weChatPayUtil;<br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 订单支付</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> ordersPaymentDTO</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">public</span> OrderPaymentVO <span class="hljs-title function_">payment</span><span class="hljs-params">(OrdersPaymentDTO ordersPaymentDTO)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>       <span class="hljs-comment">// 当前登录用户id</span><br>       <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> BaseContext.getCurrentId();<br>       <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.getById(userId);<br><br>       <span class="hljs-comment">//调用微信支付接口，生成预支付交易单</span><br>       <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> weChatPayUtil.pay(<br>               ordersPaymentDTO.getOrderNumber(), <span class="hljs-comment">//商户订单号</span><br>               <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">0.01</span>), <span class="hljs-comment">//支付金额，单位 元</span><br>               <span class="hljs-string">&quot;苍穹外卖订单&quot;</span>, <span class="hljs-comment">//商品描述</span><br>               user.getOpenid() <span class="hljs-comment">//微信用户的openid</span><br>       );<br><br>       <span class="hljs-keyword">if</span> (jsonObject.getString(<span class="hljs-string">&quot;code&quot;</span>) != <span class="hljs-literal">null</span> &amp;&amp; jsonObject.getString(<span class="hljs-string">&quot;code&quot;</span>).equals(<span class="hljs-string">&quot;ORDERPAID&quot;</span>)) &#123;<br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderBusinessException</span>(<span class="hljs-string">&quot;该订单已支付&quot;</span>);<br>       &#125;<br><br>       <span class="hljs-type">OrderPaymentVO</span> <span class="hljs-variable">vo</span> <span class="hljs-operator">=</span> jsonObject.toJavaObject(OrderPaymentVO.class);<br>       vo.setPackageStr(jsonObject.getString(<span class="hljs-string">&quot;package&quot;</span>));<br><br>       <span class="hljs-keyword">return</span> vo;<br>   &#125;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 支付成功，修改订单状态</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> outTradeNo</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">paySuccess</span><span class="hljs-params">(String outTradeNo)</span> &#123;<br>       <span class="hljs-comment">// 当前登录用户id</span><br>       <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> BaseContext.getCurrentId();<br><br>       <span class="hljs-comment">// 根据订单号查询当前用户的订单</span><br>       <span class="hljs-type">Orders</span> <span class="hljs-variable">ordersDB</span> <span class="hljs-operator">=</span> orderMapper.getByNumberAndUserId(outTradeNo, userId);<br><br>       <span class="hljs-comment">// 根据订单id更新订单的状态、支付方式、支付状态、结账时间</span><br>       <span class="hljs-type">Orders</span> <span class="hljs-variable">orders</span> <span class="hljs-operator">=</span> Orders.builder()<br>               .id(ordersDB.getId())<br>               .status(Orders.TO_BE_CONFIRMED)<br>               .payStatus(Orders.PAID)<br>               .checkoutTime(LocalDateTime.now())<br>               .build();<br><br>       orderMapper.update(orders);<br>   &#125;<br></code></pre></td></tr></table></figure><h4 id="3-3-4-Controller层"><a href="#3-3-4-Controller层" class="headerlink" title="3.3.4 Controller层"></a>3.3.4 Controller层</h4><p><strong>在OrderController.java中添加payment方法</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 订单支付</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> ordersPaymentDTO</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@PutMapping(&quot;/payment&quot;)</span><br>  <span class="hljs-meta">@ApiOperation(&quot;订单支付&quot;)</span><br>  <span class="hljs-keyword">public</span> Result&lt;OrderPaymentVO&gt; <span class="hljs-title function_">payment</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> OrdersPaymentDTO ordersPaymentDTO)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>      log.info(<span class="hljs-string">&quot;订单支付：&#123;&#125;&quot;</span>, ordersPaymentDTO);<br>      <span class="hljs-type">OrderPaymentVO</span> <span class="hljs-variable">orderPaymentVO</span> <span class="hljs-operator">=</span> orderService.payment(ordersPaymentDTO);<br>      log.info(<span class="hljs-string">&quot;生成预支付交易单：&#123;&#125;&quot;</span>, orderPaymentVO);<br>      <span class="hljs-keyword">return</span> Result.success(orderPaymentVO);<br>  &#125;<br></code></pre></td></tr></table></figure><p>PayNotifyController.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.controller.notify;<br><br><span class="hljs-keyword">import</span> com.alibaba.druid.support.json.JSONUtils;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><span class="hljs-keyword">import</span> com.sky.annotation.IgnoreToken;<br><span class="hljs-keyword">import</span> com.sky.properties.WeChatProperties;<br><span class="hljs-keyword">import</span> com.sky.service.OrderService;<br><span class="hljs-keyword">import</span> com.wechat.pay.contrib.apache.httpclient.util.AesUtil;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.http.entity.ContentType;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.BufferedReader;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 支付回调相关接口</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/notify&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PayNotifyController</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderService orderService;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> WeChatProperties weChatProperties;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 支付成功回调</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@RequestMapping(&quot;/paySuccess&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">paySuccessNotify</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//读取数据</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> readData(request);<br>        log.info(<span class="hljs-string">&quot;支付成功回调：&#123;&#125;&quot;</span>, body);<br><br>        <span class="hljs-comment">//数据解密</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">plainText</span> <span class="hljs-operator">=</span> decryptData(body);<br>        log.info(<span class="hljs-string">&quot;解密后的文本：&#123;&#125;&quot;</span>, plainText);<br><br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> JSON.parseObject(plainText);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">outTradeNo</span> <span class="hljs-operator">=</span> jsonObject.getString(<span class="hljs-string">&quot;out_trade_no&quot;</span>);<span class="hljs-comment">//商户平台订单号</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">transactionId</span> <span class="hljs-operator">=</span> jsonObject.getString(<span class="hljs-string">&quot;transaction_id&quot;</span>);<span class="hljs-comment">//微信支付交易号</span><br><br>        log.info(<span class="hljs-string">&quot;商户平台订单号：&#123;&#125;&quot;</span>, outTradeNo);<br>        log.info(<span class="hljs-string">&quot;微信支付交易号：&#123;&#125;&quot;</span>, transactionId);<br><br>        <span class="hljs-comment">//业务处理，修改订单状态、来单提醒</span><br>        orderService.paySuccess(outTradeNo);<br><br>        <span class="hljs-comment">//给微信响应</span><br>        responseToWeixin(response);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 读取数据</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">readData</span><span class="hljs-params">(HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> request.getReader();<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">line</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">while</span> ((line = reader.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (result.length() &gt; <span class="hljs-number">0</span>) &#123;<br>                result.append(<span class="hljs-string">&quot;\n&quot;</span>);<br>            &#125;<br>            result.append(line);<br>        &#125;<br>        <span class="hljs-keyword">return</span> result.toString();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 数据解密</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> body</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">decryptData</span><span class="hljs-params">(String body)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">resultObject</span> <span class="hljs-operator">=</span> JSON.parseObject(body);<br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> resultObject.getJSONObject(<span class="hljs-string">&quot;resource&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">ciphertext</span> <span class="hljs-operator">=</span> resource.getString(<span class="hljs-string">&quot;ciphertext&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">nonce</span> <span class="hljs-operator">=</span> resource.getString(<span class="hljs-string">&quot;nonce&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">associatedData</span> <span class="hljs-operator">=</span> resource.getString(<span class="hljs-string">&quot;associated_data&quot;</span>);<br><br>        <span class="hljs-type">AesUtil</span> <span class="hljs-variable">aesUtil</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AesUtil</span>(weChatProperties.getApiV3Key().getBytes(StandardCharsets.UTF_8));<br>        <span class="hljs-comment">//密文解密</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">plainText</span> <span class="hljs-operator">=</span> aesUtil.decryptToString(associatedData.getBytes(StandardCharsets.UTF_8),<br>                nonce.getBytes(StandardCharsets.UTF_8),<br>                ciphertext);<br><br>        <span class="hljs-keyword">return</span> plainText;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 给微信响应</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> response</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">responseToWeixin</span><span class="hljs-params">(HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        response.setStatus(<span class="hljs-number">200</span>);<br>        HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&quot;code&quot;</span>, <span class="hljs-string">&quot;SUCCESS&quot;</span>);<br>        map.put(<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-string">&quot;SUCCESS&quot;</span>);<br>        response.setHeader(<span class="hljs-string">&quot;Content-type&quot;</span>, ContentType.APPLICATION_JSON.toString());<br>        response.getOutputStream().write(JSONUtils.toJSONString(map).getBytes(StandardCharsets.UTF_8));<br>        response.flushBuffer();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-4-功能测试"><a href="#3-4-功能测试" class="headerlink" title="3.4 功能测试"></a>3.4 功能测试</h3><p>测试过程中，可通过断点方式查看后台每一步执行情况。</p><p><strong>下单：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356340.png" alt="image-20221215205122716" style="zoom: 80%;" /> <p><strong>去支付：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356341.png" alt="image-20221215205308701" style="zoom:80%;" /> <p><strong>确认支付：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356342.png" alt="image-20221215205434552" style="zoom:80%;" /> <p>进行扫码支付即可。</p><h3 id="3-5-代码提交"><a href="#3-5-代码提交" class="headerlink" title="3.5 代码提交"></a>3.5 代码提交</h3><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122356343.png" alt="image-20221215205746248" style="zoom:50%;" /> <p> 后续步骤和其它功能代码提交一致，不再赘述。</p>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
      <tag>项目</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>day7</title>
    <link href="/2024/12/12/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day07/"/>
    <url>/2024/12/12/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day07/</url>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js"></script><h1 id="苍穹外卖-day07"><a href="#苍穹外卖-day07" class="headerlink" title="苍穹外卖-day07"></a>苍穹外卖-day07</h1><h2 id="课程内容"><a href="#课程内容" class="headerlink" title="课程内容"></a>课程内容</h2><ul><li>缓存菜品</li><li>缓存套餐</li><li>添加购物车</li><li>查看购物车</li><li>清空购物车</li></ul><p>功能实现：<strong>缓存商品</strong>、<strong>购物车</strong></p><p><strong>效果图：</strong></p><p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357936.png" alt="image-20221208175444066" style="zoom:50%;" /> <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357937.png" alt="image-20221208175454987" style="zoom:50%;" /><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357938.png" alt="image-20221208175533325" style="zoom:50%;" /></p><h2 id="1-缓存菜品"><a href="#1-缓存菜品" class="headerlink" title="1. 缓存菜品"></a>1. 缓存菜品</h2><h3 id="1-1-问题说明"><a href="#1-1-问题说明" class="headerlink" title="1.1 问题说明"></a>1.1 问题说明</h3><p>用户端小程序展示的菜品数据都是通过查询数据库获得，如果用户端访问量比较大，数据库访问压力随之增大。</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357939.png" alt="image-20221208180228667" style="zoom:80%;" /> <p><strong>结果：</strong>系统响应慢、用户体验差</p><h3 id="1-2-实现思路"><a href="#1-2-实现思路" class="headerlink" title="1.2 实现思路"></a>1.2 实现思路</h3><p>通过Redis来缓存菜品数据，减少数据库查询操作。</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357940.png" alt="image-20221208180818572" style="zoom:80%;" /> <p><strong>缓存逻辑分析：</strong></p><ul><li>每个分类下的菜品保存一份缓存数据</li><li>数据库中菜品数据有变更时清理缓存数据</li></ul><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357941.png" alt="image-20221208181007639" style="zoom:67%;" /> <h3 id="1-3-代码开发"><a href="#1-3-代码开发" class="headerlink" title="1.3 代码开发"></a>1.3 代码开发</h3><p><strong>修改用户端接口 DishController 的 list 方法，加入缓存处理逻辑：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br>   <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 根据分类id查询菜品</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> categoryId</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@GetMapping(&quot;/list&quot;)</span><br>   <span class="hljs-meta">@ApiOperation(&quot;根据分类id查询菜品&quot;)</span><br>   <span class="hljs-keyword">public</span> Result&lt;List&lt;DishVO&gt;&gt; <span class="hljs-title function_">list</span><span class="hljs-params">(Long categoryId)</span> &#123;<br><br>       <span class="hljs-comment">//构造redis中的key，规则：dish_分类id</span><br>       <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;dish_&quot;</span> + categoryId;<br><br>       <span class="hljs-comment">//查询redis中是否存在菜品数据</span><br>       List&lt;DishVO&gt; list = (List&lt;DishVO&gt;) redisTemplate.opsForValue().get(key);<br>       <span class="hljs-keyword">if</span>(list != <span class="hljs-literal">null</span> &amp;&amp; list.size() &gt; <span class="hljs-number">0</span>)&#123;<br>           <span class="hljs-comment">//如果存在，直接返回，无须查询数据库</span><br>           <span class="hljs-keyword">return</span> Result.success(list);<br>       &#125;<br><span class="hljs-comment">////////////////////////////////////////////////////////</span><br>       <span class="hljs-type">Dish</span> <span class="hljs-variable">dish</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dish</span>();<br>       dish.setCategoryId(categoryId);<br>       dish.setStatus(StatusConstant.ENABLE);<span class="hljs-comment">//查询起售中的菜品</span><br><br>       <span class="hljs-comment">//如果不存在，查询数据库，将查询到的数据放入redis中</span><br>       list = dishService.listWithFlavor(dish);<br>       <span class="hljs-comment">////////////////////////////////////////////////////////</span><br>       redisTemplate.opsForValue().set(key, list);<br><br>       <span class="hljs-keyword">return</span> Result.success(list);<br>   &#125;<br></code></pre></td></tr></table></figure><p>为了保证<strong>数据库</strong>和<strong>Redis</strong>中的数据保持一致，修改<strong>管理端接口 DishController</strong> 的相关方法，加入清理缓存逻辑。</p><p>需要改造的方法：</p><ul><li>新增菜品</li><li>修改菜品</li><li>批量删除菜品</li><li>起售、停售菜品</li></ul><p><strong>抽取清理缓存的方法：</strong></p><p>在管理端DishController中添加</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br>   <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 清理缓存数据，pattern支持通配符</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> pattern</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cleanCache</span><span class="hljs-params">(String pattern)</span>&#123;<br>       <br>       <span class="hljs-type">Set</span> <span class="hljs-variable">keys</span> <span class="hljs-operator">=</span> redisTemplate.keys(pattern);<br>       redisTemplate.delete(keys);<br>   &#125;<br></code></pre></td></tr></table></figure><p><strong>调用清理缓存的方法，保证数据一致性：</strong></p><p><strong>1). 新增菜品优化</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 新增菜品</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> dishDTO</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@PostMapping</span><br>   <span class="hljs-meta">@ApiOperation(&quot;新增菜品&quot;)</span><br>   <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">save</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> DishDTO dishDTO)</span> &#123;<br>       log.info(<span class="hljs-string">&quot;新增菜品：&#123;&#125;&quot;</span>, dishDTO);<br>       dishService.saveWithFlavor(dishDTO);<br><br>       <span class="hljs-comment">//清理缓存数据，具体某一个key</span><br>       <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;dish_&quot;</span> + dishDTO.getCategoryId();<br>       cleanCache(key);<br>       <span class="hljs-keyword">return</span> Result.success();<br>   &#125;<br></code></pre></td></tr></table></figure><p><strong>2). 菜品批量删除优化</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 菜品批量删除</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> ids</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@DeleteMapping</span><br>   <span class="hljs-meta">@ApiOperation(&quot;菜品批量删除&quot;)</span><br>   <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">delete</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> List&lt;Long&gt; ids)</span> &#123;<br>       log.info(<span class="hljs-string">&quot;菜品批量删除：&#123;&#125;&quot;</span>, ids);<br>       dishService.deleteBatch(ids);<br><br>       <span class="hljs-comment">//将所有的菜品缓存数据清理掉，所有以dish_开头的key</span><br>       cleanCache(<span class="hljs-string">&quot;dish_*&quot;</span>);<br><br>       <span class="hljs-keyword">return</span> Result.success();<br>   &#125;<br></code></pre></td></tr></table></figure><p><strong>3). 修改菜品优化</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 修改菜品</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> dishDTO</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@PutMapping</span><br>   <span class="hljs-meta">@ApiOperation(&quot;修改菜品&quot;)</span><br>   <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">update</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> DishDTO dishDTO)</span> &#123;<br>       log.info(<span class="hljs-string">&quot;修改菜品：&#123;&#125;&quot;</span>, dishDTO);<br>       dishService.updateWithFlavor(dishDTO);<br><br>       <span class="hljs-comment">//将所有的菜品缓存数据清理掉，所有以dish_开头的key</span><br>       cleanCache(<span class="hljs-string">&quot;dish_*&quot;</span>);<br><br>       <span class="hljs-keyword">return</span> Result.success();<br>   &#125;<br></code></pre></td></tr></table></figure><p><strong>4). 菜品起售停售优化</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 菜品起售停售</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> status</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@PostMapping(&quot;/status/&#123;status&#125;&quot;)</span><br>   <span class="hljs-meta">@ApiOperation(&quot;菜品起售停售&quot;)</span><br>   <span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">startOrStop</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Integer status, Long id)</span> &#123;<br>       dishService.startOrStop(status, id);<br><br>       <span class="hljs-comment">//将所有的菜品缓存数据清理掉，所有以dish_开头的key</span><br>       cleanCache(<span class="hljs-string">&quot;dish_*&quot;</span>);<br><br>       <span class="hljs-keyword">return</span> Result.success();<br>   &#125;<br></code></pre></td></tr></table></figure><h3 id="1-4-功能测试"><a href="#1-4-功能测试" class="headerlink" title="1.4 功能测试"></a>1.4 功能测试</h3><p>可以通过如下方式进行测试：</p><ul><li>查看控制台sql</li><li>前后端联调</li><li>查看Redis中的缓存数据</li></ul><p>以<strong>加入缓存</strong>、<strong>菜品修改</strong>两个功能测试为例，通过前后端联调方式，查看控制台sql的打印和Redis中的缓存数据变化。</p><p><strong>1). 加入缓存</strong></p><p>当第一次查询某个分类的菜品时，会从数据为中进行查询，同时将查询的结果存储到Redis中，在后绪的访问，若查询相同分类的菜品时，直接从Redis缓存中查询，不再查询数据库。</p><p><strong>登录小程序：</strong>选择蜀味牛蛙(id=17)</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357942.png" alt="image-20221210174656770" style="zoom:50%;" /> <p><strong>查看控制台sql：</strong>有查询语句，说明是从数据库中进行查询</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357943.png" alt="image-20221210174839028" style="zoom:50%;" /> <p><strong>查看Redis中的缓存数据：</strong>说明缓存成功</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357944.png" alt="image-20221210175055282" style="zoom:50%;" /> <p><strong>再次访问：</strong>选择蜀味牛蛙(id=17)</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357945.png" alt="image-20221210175438411" style="zoom:50%;" /> <p>说明是从Redis中查询的数据。</p><p><strong>2). 菜品修改</strong></p><p>当在后台修改菜品数据时，为了保证Redis缓存中的数据和数据库中的数据时刻保持一致，当修改后，需要清空对应的缓存数据。用户再次访问时，还是先从数据库中查询，同时再把查询的结果存储到Redis中，这样，就能保证缓存和数据库的数据保持一致。</p><p><strong>进入后台：</strong>修改蜀味牛蛙分类下的任意一个菜品，当前分类的菜品数据已在Redis中缓存</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357946.png" alt="image-20221210180624453" style="zoom:50%;" /> <p><strong>修改：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357947.png" alt="image-20221210180900924" style="zoom:50%;" /> <p><strong>查看Redis中的缓存数据：</strong>说明修改时，已清空缓存</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357948.png" alt="image-20221210181142408" style="zoom:50%;" /> <p>用户再次访问同一个菜品分类时，需要先查询数据库，再把结果同步到Redis中，保证了两者数据一致性。</p><p>其它功能测试步骤基本一致，自已测试即可。</p><h3 id="1-5-代码提交"><a href="#1-5-代码提交" class="headerlink" title="1.5 代码提交"></a>1.5 代码提交</h3><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357949.png" alt="image-20221210202804407" style="zoom:50%;" /> <p>后续步骤和其它功能代码提交一致，不再赘述。</p><h2 id="2-缓存套餐"><a href="#2-缓存套餐" class="headerlink" title="2. 缓存套餐"></a>2. 缓存套餐</h2><h3 id="2-1-Spring-Cache"><a href="#2-1-Spring-Cache" class="headerlink" title="2.1 Spring Cache"></a>2.1 Spring Cache</h3><h4 id="2-1-1-介绍"><a href="#2-1-1-介绍" class="headerlink" title="2.1.1 介绍"></a>2.1.1 介绍</h4><p>Spring Cache 是一个框架，实现了基于注解的缓存功能，只需要简单地加一个注解，就能实现缓存功能。</p><p>Spring Cache 提供了一层抽象，底层可以切换不同的缓存实现，例如：</p><ul><li>EHCache</li><li>Caffeine</li><li>Redis(常用)</li></ul><p><strong>起步依赖：</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>                      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.7.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> <br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="2-1-2-常用注解"><a href="#2-1-2-常用注解" class="headerlink" title="2.1.2 常用注解"></a>2.1.2 常用注解</h4><p>在SpringCache中提供了很多缓存操作的注解，常见的是以下的几个：</p><table><thead><tr><th><strong>注解</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>@EnableCaching</td><td>开启缓存注解功能，通常加在启动类上</td></tr><tr><td>@Cacheable</td><td>在方法执行前先查询缓存中是否有数据，如果有数据，则直接返回缓存数据；如果没有缓存数据，调用方法并将方法返回值放到缓存中</td></tr><tr><td>@CachePut</td><td>将方法的返回值放到缓存中</td></tr><tr><td>@CacheEvict</td><td>将一条或多条数据从缓存中删除</td></tr></tbody></table><p>在spring boot项目中，使用缓存技术只需在项目中导入相关缓存技术的依赖包，并在启动类上使用@EnableCaching开启缓存支持即可。</p><p>例如，使用Redis作为缓存技术，只需要导入Spring data Redis的maven坐标即可。</p><h4 id="2-1-3-入门案例"><a href="#2-1-3-入门案例" class="headerlink" title="2.1.3 入门案例"></a>2.1.3 入门案例</h4><p><strong>1). 环境准备</strong></p><p>**导入基础工程:**底层已使用Redis缓存实现</p><p>基础环境的代码，在我们今天的资料中已经准备好了， 大家只需要将这个工程导入进来就可以了。导入进来的工程结构如下： </p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357950.png" alt="image-20221210183942040" style="zoom:50%;" /> <p><strong>数据库准备:</strong></p><p>创建名为spring_cache_demo数据库，将springcachedemo.sql脚本直接导入数据库中。</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357951.png" alt="image-20221210184346304" style="zoom:80%;" /> <p><strong>引导类上加@EnableCaching:</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima;<br><br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><span class="hljs-keyword">import</span> org.springframework.cache.annotation.EnableCaching;<br><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableCaching</span><span class="hljs-comment">//开启缓存注解功能</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheDemoApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(CacheDemoApplication.class,args);<br>        log.info(<span class="hljs-string">&quot;项目启动成功...&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>2). @CachePut注解</strong></p><p><strong>@CachePut 说明：</strong> </p><p>​    作用: 将方法返回值，放入缓存</p><p>​    value: 缓存的名称, 每个缓存名称下面可以有很多key</p><p>​    key: 缓存的key  ———-&gt; 支持Spring的表达式语言SPEL语法</p><p><strong>在save方法上加注解@CachePut</strong></p><p>当前UserController的save方法是用来保存用户信息的，我们希望在该用户信息保存到数据库的同时，也往缓存中缓存一份数据，我们可以在save方法上加上注解 @CachePut，用法如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* CachePut：将方法返回值放入缓存</span><br><span class="hljs-comment">* value：缓存的名称，每个缓存名称下面可以有多个key</span><br><span class="hljs-comment">* key：缓存的key</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">@PostMapping</span><br>   <span class="hljs-meta">@CachePut(value = &quot;userCache&quot;, key = &quot;#user.id&quot;)</span><span class="hljs-comment">//key的生成：userCache::1</span><br>   <span class="hljs-keyword">public</span> User <span class="hljs-title function_">save</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span>&#123;<br>       userMapper.insert(user);<br>       <span class="hljs-keyword">return</span> user;<br>   &#125;<br></code></pre></td></tr></table></figure><p><strong>说明：</strong>key的写法如下</p><p>#user.id : #user指的是方法形参的名称, id指的是user的id属性 , 也就是使用user的id属性作为key ;</p><p>#result.id : #result代表方法返回值，该表达式 代表以返回对象的id属性作为key ；</p><p>#p0.id：#p0指的是方法中的第一个参数，id指的是第一个参数的id属性,也就是使用第一个参数的id属性作为key ;</p><p>#a0.id：#a0指的是方法中的第一个参数，id指的是第一个参数的id属性,也就是使用第一个参数的id属性作为key ;</p><p>#root.args[0].id:#root.args[0]指的是方法中的第一个参数，id指的是第一个参数的id属性,也就是使用第一个参数的id属性作为key ;</p><p><strong>启动服务,通过swagger接口文档测试，访问UserController的save()方法</strong></p><p>因为id是自增，所以不需要设置id属性</p> <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357952.png" alt="image-20221210191702887" style="zoom:50%;" /> <p><strong>查看user表中的数据</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357953.png" alt="image-20221210192325931" style="zoom: 67%;" /> <p><strong>查看Redis中的数据</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357954.png" alt="image-20221210192418204" style="zoom:50%;" /> <p><strong>3). @Cacheable注解</strong></p><p><strong>@Cacheable 说明:</strong></p><p>​    作用: 在方法执行前，spring先查看缓存中是否有数据，如果有数据，则直接返回缓存数据；若没有数据，调用方法并将方法返回值放到缓存中</p><p>​    value: 缓存的名称，每个缓存名称下面可以有多个key</p><p>​    key: 缓存的key  ———-&gt; 支持Spring的表达式语言SPEL语法</p><p> <strong>在getById上加注解@Cacheable</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* Cacheable：在方法执行前spring先查看缓存中是否有数据，如果有数据，则直接返回缓存数据；若没有数据，  *调用方法并将方法返回值放到缓存中</span><br><span class="hljs-comment">* value：缓存的名称，每个缓存名称下面可以有多个key</span><br><span class="hljs-comment">* key：缓存的key</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">@GetMapping</span><br>   <span class="hljs-meta">@Cacheable(cacheNames = &quot;userCache&quot;,key=&quot;#id&quot;)</span><br>   <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getById</span><span class="hljs-params">(Long id)</span>&#123;<br>       <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.getById(id);<br>       <span class="hljs-keyword">return</span> user;<br>   &#125;<br></code></pre></td></tr></table></figure><p><strong>重启服务,通过swagger接口文档测试，访问UserController的getById()方法</strong></p><p>第一次访问，会请求我们controller的方法，查询数据库。后面再查询相同的id，就直接从Redis中查询数据，不用再查询数据库了，就说明缓存生效了。</p><p>提前在redis中手动删除掉id=1的用户数据</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357955.png" alt="image-20221210193834150" style="zoom:50%;" /> <p><strong>查看控制台sql语句：</strong>说明从数据库查询的用户数据</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357956.png" alt="image-20221210193948896" style="zoom: 67%;" /> <p><strong>查看Redis中的缓存数据：</strong>说明已成功缓存</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357957.png" alt="image-20221210194112334" style="zoom:50%;" /> <p>再次查询相同id的数据时，直接从redis中直接获取，不再查询数据库。</p><p><strong>4). @CacheEvict注解</strong></p><p><strong>@CacheEvict 说明：</strong> </p><p>​    作用: 清理指定缓存</p><p>​    value: 缓存的名称，每个缓存名称下面可以有多个key</p><p>​    key: 缓存的key  ———-&gt; 支持Spring的表达式语言SPEL语法</p><p><strong>在 delete 方法上加注解@CacheEvict</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DeleteMapping</span><br>   <span class="hljs-meta">@CacheEvict(cacheNames = &quot;userCache&quot;,key = &quot;#id&quot;)</span><span class="hljs-comment">//删除某个key对应的缓存数据</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteById</span><span class="hljs-params">(Long id)</span>&#123;<br>       userMapper.deleteById(id);<br>   &#125;<br><br><span class="hljs-meta">@DeleteMapping(&quot;/delAll&quot;)</span><br>   <span class="hljs-meta">@CacheEvict(cacheNames = &quot;userCache&quot;,allEntries = true)</span><span class="hljs-comment">//删除userCache下所有的缓存数据</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteAll</span><span class="hljs-params">()</span>&#123;<br>       userMapper.deleteAll();<br>   &#125;<br></code></pre></td></tr></table></figure><p><strong>重启服务,通过swagger接口文档测试，访问UserController的deleteAll()方法</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357958.png" alt="image-20221210195254874" style="zoom:50%;" /> <p><strong>查看user表：</strong>数据清空</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357959.png" alt="image-20221210195332101" style="zoom:80%;" /> <p><strong>查询Redis缓存数据</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357960.png" alt="image-20221210195500014" style="zoom:50%;" /> <h3 id="2-2-实现思路"><a href="#2-2-实现思路" class="headerlink" title="2.2 实现思路"></a>2.2 实现思路</h3><p><strong>实现步骤：</strong></p><p>1). 导入Spring Cache和Redis相关maven坐标</p><p>2). 在启动类上加入@EnableCaching注解，开启缓存注解功能</p><p>3). 在用户端接口SetmealController的 list 方法上加入@Cacheable注解</p><p>4). 在管理端接口SetmealController的 save、delete、update、startOrStop等方法上加入CacheEvict注解</p><h3 id="2-3-代码开发"><a href="#2-3-代码开发" class="headerlink" title="2.3 代码开发"></a>2.3 代码开发</h3><p>按照上述实现步骤：</p><p><strong>1). 导入Spring Cache和Redis相关maven坐标(已实现)</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>2). 在启动类上加入@EnableCaching注解，开启缓存注解功能</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky;<br><br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><span class="hljs-keyword">import</span> org.springframework.cache.annotation.EnableCaching;<br><span class="hljs-keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableTransactionManagement</span> <span class="hljs-comment">//开启注解方式的事务管理</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@EnableCaching</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SkyApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(SkyApplication.class, args);<br>        log.info(<span class="hljs-string">&quot;server started&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>3). 在用户端接口SetmealController的 list 方法上加入@Cacheable注解</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 条件查询</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> categoryId</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@GetMapping(&quot;/list&quot;)</span><br>   <span class="hljs-meta">@ApiOperation(&quot;根据分类id查询套餐&quot;)</span><br>   <span class="hljs-meta">@Cacheable(cacheNames = &quot;setmealCache&quot;,key = &quot;#categoryId&quot;)</span> <span class="hljs-comment">//key: setmealCache::100</span><br>   <span class="hljs-keyword">public</span> Result&lt;List&lt;Setmeal&gt;&gt; <span class="hljs-title function_">list</span><span class="hljs-params">(Long categoryId)</span> &#123;<br>       <span class="hljs-type">Setmeal</span> <span class="hljs-variable">setmeal</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Setmeal</span>();<br>       setmeal.setCategoryId(categoryId);<br>       setmeal.setStatus(StatusConstant.ENABLE);<br><br>       List&lt;Setmeal&gt; list = setmealService.list(setmeal);<br>       <span class="hljs-keyword">return</span> Result.success(list);<br>   &#125;<br></code></pre></td></tr></table></figure><p><strong>4). 在管理端接口SetmealController的 save、delete、update、startOrStop等方法上加入CacheEvict注解</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 新增套餐</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> setmealDTO</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@PostMapping</span><br>   <span class="hljs-meta">@ApiOperation(&quot;新增套餐&quot;)</span><br>   <span class="hljs-meta">@CacheEvict(cacheNames = &quot;setmealCache&quot;,key = &quot;#setmealDTO.categoryId&quot;)</span><span class="hljs-comment">//key: setmealCache::100</span><br>   <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">save</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> SetmealDTO setmealDTO)</span> &#123;<br>       setmealService.saveWithDish(setmealDTO);<br>       <span class="hljs-keyword">return</span> Result.success();<br>   &#125;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 批量删除套餐</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> ids</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@DeleteMapping</span><br>   <span class="hljs-meta">@ApiOperation(&quot;批量删除套餐&quot;)</span><br>   <span class="hljs-meta">@CacheEvict(cacheNames = &quot;setmealCache&quot;,allEntries = true)</span><br>   <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">delete</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> List&lt;Long&gt; ids)</span> &#123;<br>       setmealService.deleteBatch(ids);<br>       <span class="hljs-keyword">return</span> Result.success();<br>   &#125;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 修改套餐</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> setmealDTO</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@PutMapping</span><br>   <span class="hljs-meta">@ApiOperation(&quot;修改套餐&quot;)</span><br>   <span class="hljs-meta">@CacheEvict(cacheNames = &quot;setmealCache&quot;,allEntries = true)</span><br>   <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">update</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> SetmealDTO setmealDTO)</span> &#123;<br>       setmealService.update(setmealDTO);<br>       <span class="hljs-keyword">return</span> Result.success();<br>   &#125;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 套餐起售停售</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> status</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@PostMapping(&quot;/status/&#123;status&#125;&quot;)</span><br>   <span class="hljs-meta">@ApiOperation(&quot;套餐起售停售&quot;)</span><br>   <span class="hljs-meta">@CacheEvict(cacheNames = &quot;setmealCache&quot;,allEntries = true)</span><br>   <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">startOrStop</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Integer status, Long id)</span> &#123;<br>       setmealService.startOrStop(status, id);<br>       <span class="hljs-keyword">return</span> Result.success();<br>   &#125;<br></code></pre></td></tr></table></figure><h3 id="2-4-功能测试"><a href="#2-4-功能测试" class="headerlink" title="2.4 功能测试"></a>2.4 功能测试</h3><p>通过前后端联调方式来进行测试，同时观察redis中缓存的套餐数据。和<strong>缓存菜品</strong>功能测试基本一致，不再赘述。</p><h3 id="2-5-代码提交"><a href="#2-5-代码提交" class="headerlink" title="2.5 代码提交"></a>2.5 代码提交</h3><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357961.png" alt="image-20221210203035708" style="zoom:50%;" /> <p>后续步骤和其它功能代码提交一致，不再赘述。</p><h2 id="3-添加购物车"><a href="#3-添加购物车" class="headerlink" title="3. 添加购物车"></a>3. 添加购物车</h2><h3 id="3-1-需求分析和设计"><a href="#3-1-需求分析和设计" class="headerlink" title="3.1 需求分析和设计"></a>3.1 需求分析和设计</h3><h4 id="3-1-1-产品原型"><a href="#3-1-1-产品原型" class="headerlink" title="3.1.1 产品原型"></a>3.1.1 产品原型</h4><p>用户可以将菜品或者套餐添加到购物车。对于菜品来说，如果设置了口味信息，则需要选择规格后才能加入购物车;对于套餐来说，可以直接点击<img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357962.png" alt="image-20210813181916235" style="zoom: 67%;" />将当前套餐加入购物车。在购物车中可以修改菜品和套餐的数量，也可以清空购物车。</p><p><strong>效果图：</strong></p> <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357963.png" alt="image-20221210203822817" style="zoom:50%;" /> <h4 id="3-1-2-接口设计"><a href="#3-1-2-接口设计" class="headerlink" title="3.1.2 接口设计"></a>3.1.2 接口设计</h4><p>通过上述原型图，设计出对应的添加购物车接口。</p><p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357964.png" alt="image-20221208184342490" style="zoom:50%;" /> <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357965.png" alt="image-20221208184354291" style="zoom:50%;" /></p><p><strong>说明：</strong>添加购物车时，有可能添加菜品，也有可能添加套餐。故传入参数要么是菜品id，要么是套餐id。</p><h4 id="3-1-3-表设计"><a href="#3-1-3-表设计" class="headerlink" title="3.1.3 表设计"></a>3.1.3 表设计</h4><p>用户的购物车数据，也是需要保存在数据库中的，购物车对应的数据表为shopping_cart表，具体表结构如下：</p><table><thead><tr><th><strong>字段名</strong></th><th><strong>数据类型</strong></th><th><strong>说明</strong></th><th><strong>备注</strong></th></tr></thead><tbody><tr><td>id</td><td>bigint</td><td>主键</td><td>自增</td></tr><tr><td>name</td><td>varchar(32)</td><td>商品名称</td><td>冗余字段</td></tr><tr><td>image</td><td>varchar(255)</td><td>商品图片路径</td><td>冗余字段</td></tr><tr><td>user_id</td><td>bigint</td><td>用户id</td><td>逻辑外键</td></tr><tr><td>dish_id</td><td>bigint</td><td>菜品id</td><td>逻辑外键</td></tr><tr><td>setmeal_id</td><td>bigint</td><td>套餐id</td><td>逻辑外键</td></tr><tr><td>dish_flavor</td><td>varchar(50)</td><td>菜品口味</td><td></td></tr><tr><td>number</td><td>int</td><td>商品数量</td><td></td></tr><tr><td>amount</td><td>decimal(10,2)</td><td>商品单价</td><td>冗余字段</td></tr><tr><td>create_time</td><td>datetime</td><td>创建时间</td><td></td></tr></tbody></table><p><strong>说明：</strong> </p><ul><li>购物车数据是关联用户的，在表结构中，我们需要记录，每一个用户的购物车数据是哪些</li><li>菜品列表展示出来的既有套餐，又有菜品，如果用户选择的是套餐，就保存套餐ID(setmeal_id)，如果用户选择的是菜品，就保存菜品ID(dish_id)</li><li>对同一个菜品/套餐，如果选择多份不需要添加多条记录，增加数量number即可</li></ul><h3 id="3-2-代码开发"><a href="#3-2-代码开发" class="headerlink" title="3.2 代码开发"></a>3.2 代码开发</h3><h4 id="3-2-1-DTO设计"><a href="#3-2-1-DTO设计" class="headerlink" title="3.2.1 DTO设计"></a>3.2.1 DTO设计</h4><p><strong>根据添加购物车接口的参数设计DTO：</strong></p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357966.png" alt="image-20221208184938195" style="zoom:50%;" /> <p>在sky-pojo模块，ShoppingCartDTO.java已定义</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.dto;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShoppingCartDTO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> Long dishId;<br>    <span class="hljs-keyword">private</span> Long setmealId;<br>    <span class="hljs-keyword">private</span> String dishFlavor;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-2-2-Controller层"><a href="#3-2-2-Controller层" class="headerlink" title="3.2.2 Controller层"></a>3.2.2 Controller层</h4><p><strong>根据添加购物车接口创建ShoppingCartController：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.controller.user;<br><br><br><span class="hljs-keyword">import</span> com.sky.dto.ShoppingCartDTO;<br><span class="hljs-keyword">import</span> com.sky.result.Result;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PostMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestBody;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 购物车</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/user/shoppingCart&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Api(tags = &quot;C端-购物车接口&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShoppingCartController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ShoppingCartService shoppingCartService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 添加购物车</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> shoppingCartDTO</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostMapping(&quot;/add&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;添加购物车&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> ShoppingCartDTO shoppingCartDTO)</span>&#123;<br>        log.info(<span class="hljs-string">&quot;添加购物车：&#123;&#125;&quot;</span>, shoppingCartDTO);<br>        shoppingCartService.addShoppingCart(shoppingCartDTO);<span class="hljs-comment">//后绪步骤实现</span><br>        <span class="hljs-keyword">return</span> Result.success();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-2-3-Service层接口"><a href="#3-2-3-Service层接口" class="headerlink" title="3.2.3 Service层接口"></a>3.2.3 Service层接口</h4><p><strong>创建ShoppingCartService接口：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.service;<br><br><span class="hljs-keyword">import</span> com.sky.dto.ShoppingCartDTO;<br><span class="hljs-keyword">import</span> com.sky.entity.ShoppingCart;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ShoppingCartService</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 添加购物车</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> shoppingCartDTO</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">addShoppingCart</span><span class="hljs-params">(ShoppingCartDTO shoppingCartDTO)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-2-4-Service层实现类"><a href="#3-2-4-Service层实现类" class="headerlink" title="3.2.4 Service层实现类"></a>3.2.4 Service层实现类</h4><p><strong>创建ShoppingCartServiceImpl实现类，并实现add方法：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.service.impl;<br><br><br><span class="hljs-keyword">import</span> com.sky.context.BaseContext;<br><span class="hljs-keyword">import</span> com.sky.dto.ShoppingCartDTO;<br><span class="hljs-keyword">import</span> com.sky.entity.Dish;<br><span class="hljs-keyword">import</span> com.sky.entity.Setmeal;<br><span class="hljs-keyword">import</span> com.sky.entity.ShoppingCart;<br><span class="hljs-keyword">import</span> com.sky.mapper.DishMapper;<br><span class="hljs-keyword">import</span> com.sky.mapper.SetmealMapper;<br><span class="hljs-keyword">import</span> com.sky.service.ShoppingCartService;<br><span class="hljs-keyword">import</span> org.springframework.beans.BeanUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShoppingCartServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ShoppingCartService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ShoppingCartMapper shoppingCartMapper;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> DishMapper dishMapper;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SetmealMapper setmealMapper;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 添加购物车</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> shoppingCartDTO</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addShoppingCart</span><span class="hljs-params">(ShoppingCartDTO shoppingCartDTO)</span> &#123;<br>        <span class="hljs-type">ShoppingCart</span> <span class="hljs-variable">shoppingCart</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShoppingCart</span>();<br>        BeanUtils.copyProperties(shoppingCartDTO, shoppingCart);<br>        <span class="hljs-comment">//只能查询自己的购物车数据</span><br>        shoppingCart.setUserId(BaseContext.getCurrentId());<br><br>        <span class="hljs-comment">//判断当前商品是否在购物车中</span><br>        List&lt;ShoppingCart&gt; shoppingCartList = shoppingCartMapper.list(shoppingCart);<br><br>        <span class="hljs-keyword">if</span> (shoppingCartList != <span class="hljs-literal">null</span> &amp;&amp; shoppingCartList.size() == <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-comment">//如果已经存在，就更新数量，数量加1</span><br>            shoppingCart = shoppingCartList.get(<span class="hljs-number">0</span>);<br>            shoppingCart.setNumber(shoppingCart.getNumber() + <span class="hljs-number">1</span>);<br>            shoppingCartMapper.updateNumberById(shoppingCart);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//如果不存在，插入数据，数量就是1</span><br><br>            <span class="hljs-comment">//判断当前添加到购物车的是菜品还是套餐</span><br>            <span class="hljs-type">Long</span> <span class="hljs-variable">dishId</span> <span class="hljs-operator">=</span> shoppingCartDTO.getDishId();<br>            <span class="hljs-keyword">if</span> (dishId != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">//添加到购物车的是菜品</span><br>                <span class="hljs-type">Dish</span> <span class="hljs-variable">dish</span> <span class="hljs-operator">=</span> dishMapper.getById(dishId);<br>                shoppingCart.setName(dish.getName());<br>                shoppingCart.setImage(dish.getImage());<br>                shoppingCart.setAmount(dish.getPrice());<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//添加到购物车的是套餐</span><br>                <span class="hljs-type">Setmeal</span> <span class="hljs-variable">setmeal</span> <span class="hljs-operator">=</span> setmealMapper.getById(shoppingCartDTO.getSetmealId());<br>                shoppingCart.setName(setmeal.getName());<br>                shoppingCart.setImage(setmeal.getImage());<br>                shoppingCart.setAmount(setmeal.getPrice());<br>            &#125;<br>            shoppingCart.setNumber(<span class="hljs-number">1</span>);<br>            shoppingCart.setCreateTime(LocalDateTime.now());<br>            shoppingCartMapper.insert(shoppingCart);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-2-5-Mapper层"><a href="#3-2-5-Mapper层" class="headerlink" title="3.2.5 Mapper层"></a>3.2.5 Mapper层</h4><p><strong>创建ShoppingCartMapper接口:</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sky.mapper;<br><br><span class="hljs-keyword">import</span> com.sky.entity.ShoppingCart;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Delete;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Insert;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Mapper;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Update;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ShoppingCartMapper</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 条件查询</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> shoppingCart</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    List&lt;ShoppingCart&gt; <span class="hljs-title function_">list</span><span class="hljs-params">(ShoppingCart shoppingCart)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 更新商品数量</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> shoppingCart</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Update(&quot;update shopping_cart set number = #&#123;number&#125; where id = #&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateNumberById</span><span class="hljs-params">(ShoppingCart shoppingCart)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 插入购物车数据</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> shoppingCart</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Insert(&quot;insert into shopping_cart (name, user_id, dish_id, setmeal_id, dish_flavor, number, amount, image, create_time) &quot; +</span><br><span class="hljs-meta">            &quot; values (#&#123;name&#125;,#&#123;userId&#125;,#&#123;dishId&#125;,#&#123;setmealId&#125;,#&#123;dishFlavor&#125;,#&#123;number&#125;,#&#123;amount&#125;,#&#123;image&#125;,#&#123;createTime&#125;)&quot;)</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(ShoppingCart shoppingCart)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>创建ShoppingCartMapper.xml：</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.sky.mapper.ShoppingCartMapper&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;list&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;ShoppingCart&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;ShoppingCart&quot;</span>&gt;</span><br>        select * from shopping_cart<br>        <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;userId != null&quot;</span>&gt;</span><br>                and user_id = #&#123;userId&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;dishId != null&quot;</span>&gt;</span><br>                and dish_id = #&#123;dishId&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;setmealId != null&quot;</span>&gt;</span><br>                and setmeal_id = #&#123;setmealId&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;dishFlavor != null&quot;</span>&gt;</span><br>                and dish_flavor = #&#123;dishFlavor&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span><br>        order by create_time desc<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="3-3-功能测试"><a href="#3-3-功能测试" class="headerlink" title="3.3 功能测试"></a>3.3 功能测试</h3><p>进入小程序，添加菜品</p><p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357967.png" alt="image-20221210210338094" style="zoom:50%;" /> <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357968.png" alt="image-20221210210409954" style="zoom:50%;" /></p><p>加入购物车，查询数据库</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357969.png" alt="image-20221210210643308" style="zoom:80%;" /> <p>因为现在没有实现查看购物车功能，所以只能在表中进行查看。</p><p>在前后联调时，后台可通断点方式启动，查看运行的每一步。</p><h3 id="3-4-代码提交"><a href="#3-4-代码提交" class="headerlink" title="3.4 代码提交"></a>3.4 代码提交</h3><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357970.png" alt="image-20221210211145602" style="zoom:50%;" /> <p>后续步骤和其它功能代码提交一致，不再赘述。</p><h2 id="4-查看购物车"><a href="#4-查看购物车" class="headerlink" title="4. 查看购物车"></a>4. 查看购物车</h2><h3 id="4-1-需求分析和设计"><a href="#4-1-需求分析和设计" class="headerlink" title="4.1 需求分析和设计"></a>4.1 需求分析和设计</h3><h4 id="4-1-1-产品原型"><a href="#4-1-1-产品原型" class="headerlink" title="4.1.1 产品原型"></a>4.1.1 产品原型</h4><p>当用户添加完菜品和套餐后，可进入到购物车中，查看购物中的菜品和套餐。</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357971.png" alt="image-20221208190038058" style="zoom:50%;" /> <h4 id="4-1-2-接口设计"><a href="#4-1-2-接口设计" class="headerlink" title="4.1.2 接口设计"></a>4.1.2 接口设计</h4><p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357972.png" alt="image-20221208190052467" style="zoom:50%;" /> <img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357973.png" alt="image-20221208190102904" style="zoom:50%;" /></p><h3 id="4-2-代码开发"><a href="#4-2-代码开发" class="headerlink" title="4.2 代码开发"></a>4.2 代码开发</h3><h4 id="4-2-1-Controller层"><a href="#4-2-1-Controller层" class="headerlink" title="4.2.1 Controller层"></a>4.2.1 Controller层</h4><p><strong>在ShoppingCartController中创建查看购物车的方法：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 查看购物车</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@GetMapping(&quot;/list&quot;)</span><br>   <span class="hljs-meta">@ApiOperation(&quot;查看购物车&quot;)</span><br>   <span class="hljs-keyword">public</span> Result&lt;List&lt;ShoppingCart&gt;&gt; <span class="hljs-title function_">list</span><span class="hljs-params">()</span>&#123;<br>       <span class="hljs-keyword">return</span> Result.success(shoppingCartService.showShoppingCart());<br>   &#125;<br></code></pre></td></tr></table></figure><h4 id="4-2-2-Service层接口"><a href="#4-2-2-Service层接口" class="headerlink" title="4.2.2 Service层接口"></a>4.2.2 Service层接口</h4><p><strong>在ShoppingCartService接口中声明查看购物车的方法：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 查看购物车</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   List&lt;ShoppingCart&gt; <span class="hljs-title function_">showShoppingCart</span><span class="hljs-params">()</span>;<br></code></pre></td></tr></table></figure><h4 id="4-2-3-Service层实现类"><a href="#4-2-3-Service层实现类" class="headerlink" title="4.2.3 Service层实现类"></a>4.2.3 Service层实现类</h4><p><strong>在ShoppingCartServiceImpl中实现查看购物车的方法：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 查看购物车</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">public</span> List&lt;ShoppingCart&gt; <span class="hljs-title function_">showShoppingCart</span><span class="hljs-params">()</span> &#123;<br>       <span class="hljs-keyword">return</span> shoppingCartMapper.list(ShoppingCart.<br>                                      builder().<br>                                      userId(BaseContext.getCurrentId()).<br>                                      build());<br>   &#125;<br></code></pre></td></tr></table></figure><h3 id="4-3-功能测试"><a href="#4-3-功能测试" class="headerlink" title="4.3 功能测试"></a>4.3 功能测试</h3><p>当进入小程序时，就会发起查看购物车的请求</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357974.png" alt="image-20221210213347557" style="zoom:50%;" /> <p>点击购物车图标</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357975.png" alt="image-20221210213438878" style="zoom:50%;" /> <p>测试成功。</p><h3 id="4-4-代码提交"><a href="#4-4-代码提交" class="headerlink" title="4.4 代码提交"></a>4.4 代码提交</h3><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357976.png" alt="image-20221210213555667" style="zoom:50%;" /> <p>后续步骤和其它功能代码提交一致，不再赘述。</p><h2 id="5-清空购物车"><a href="#5-清空购物车" class="headerlink" title="5. 清空购物车"></a>5. 清空购物车</h2><h3 id="5-1-需求分析和设计"><a href="#5-1-需求分析和设计" class="headerlink" title="5.1 需求分析和设计"></a>5.1 需求分析和设计</h3><h4 id="5-1-1-产品原型"><a href="#5-1-1-产品原型" class="headerlink" title="5.1.1 产品原型"></a>5.1.1 产品原型</h4><p>当点击清空按钮时，会把购物车中的数据全部清空。</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357977.png" alt="image-20221210213703715" style="zoom:50%;" /> <h4 id="5-1-2-接口设计"><a href="#5-1-2-接口设计" class="headerlink" title="5.1.2 接口设计"></a>5.1.2 接口设计</h4><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357978.png" alt="image-20221208191606894" style="zoom:50%;" /> <h3 id="5-2-代码开发"><a href="#5-2-代码开发" class="headerlink" title="5.2 代码开发"></a>5.2 代码开发</h3><h4 id="5-2-1-Controller层"><a href="#5-2-1-Controller层" class="headerlink" title="5.2.1 Controller层"></a>5.2.1 Controller层</h4><p><strong>在ShoppingCartController中创建清空购物车的方法：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 清空购物车商品</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@DeleteMapping(&quot;/clean&quot;)</span><br>   <span class="hljs-meta">@ApiOperation(&quot;清空购物车商品&quot;)</span><br>   <span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">clean</span><span class="hljs-params">()</span>&#123;<br>       shoppingCartService.cleanShoppingCart();<br>       <span class="hljs-keyword">return</span> Result.success();<br>   &#125;<br></code></pre></td></tr></table></figure><h4 id="5-2-2-Service层接口"><a href="#5-2-2-Service层接口" class="headerlink" title="5.2.2 Service层接口"></a>5.2.2 Service层接口</h4><p><strong>在ShoppingCartService接口中声明清空购物车的方法：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 清空购物车商品</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">void</span> <span class="hljs-title function_">cleanShoppingCart</span><span class="hljs-params">()</span>;<br></code></pre></td></tr></table></figure><h4 id="5-2-3-Service层实现类"><a href="#5-2-3-Service层实现类" class="headerlink" title="5.2.3 Service层实现类"></a>5.2.3 Service层实现类</h4><p><strong>在ShoppingCartServiceImpl中实现清空购物车的方法：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 清空购物车商品</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cleanShoppingCart</span><span class="hljs-params">()</span> &#123;<br>       shoppingCartMapper.deleteByUserId(BaseContext.getCurrentId());<br>   &#125;<br></code></pre></td></tr></table></figure><h4 id="5-2-4-Mapper层"><a href="#5-2-4-Mapper层" class="headerlink" title="5.2.4 Mapper层"></a>5.2.4 Mapper层</h4><p><strong>在ShoppingCartMapper接口中创建删除购物车数据的方法：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 根据用户id删除购物车数据</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> userId</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@Delete(&quot;delete from shopping_cart where user_id = #&#123;userId&#125;&quot;)</span><br>   <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteByUserId</span><span class="hljs-params">(Long userId)</span>;<br></code></pre></td></tr></table></figure><h3 id="5-3-功能测试"><a href="#5-3-功能测试" class="headerlink" title="5.3 功能测试"></a>5.3 功能测试</h3><p>进入到购物车页面</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357979.png" alt="image-20221210214710863" style="zoom:50%;" /> <p>点击清空</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357980.png" alt="image-20221210214914092" style="zoom:50%;" /> <p>查看数据库中的数据</p><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357981.png" alt="image-20221210214950261" style="zoom:80%;" /> <p>说明当前用户的购物车数据已全部删除。</p><h3 id="5-4-代码提交"><a href="#5-4-代码提交" class="headerlink" title="5.4 代码提交"></a>5.4 代码提交</h3><img src="https://lxh-photo.oss-cn-nanjing.aliyuncs.com/images/202412122357982.png" alt="image-20221210215130746" style="zoom:50%;" /> <p>后续步骤和其它功能代码提交一致，不再赘述。</p>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
      <tag>项目</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>技术相关网站</title>
    <link href="/2024/11/14/%E6%8A%80%E6%9C%AF%E7%9B%B8%E5%85%B3%E7%BD%91%E7%AB%99/"/>
    <url>/2024/11/14/%E6%8A%80%E6%9C%AF%E7%9B%B8%E5%85%B3%E7%BD%91%E7%AB%99/</url>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js"></script><p>介绍一些搭建个人博客参考的网站，以及后续的进展</p><span id="more"></span><p>个人博客搭建</p><p><a href="https://juejin.cn/column/7150928014518272007">https://juejin.cn/column/7150928014518272007</a></p><p><a href="https://blog.kevinchu.top/categories/">https://blog.kevinchu.top/categories/</a></p><p>评论、网易云、星星</p>]]></content>
    
    
    <categories>
      
      <category>tech</category>
      
    </categories>
    
    
    <tags>
      
      <tag>tech</tag>
      
      <tag>web</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>12306项目</title>
    <link href="/2024/11/14/12306/"/>
    <url>/2024/11/14/12306/</url>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js"></script><p>12306项目的笔记</p><span id="more"></span><p>Spring Boot 基础框架   3.0.7  <a href="https://spring.io/projects/spring-boot">https://spring.io/projects/spring-boot</a></p><p>MyBatis-Plus   持久层框架  3.5.3.1 <a href="https://baomidou.com/">https://baomidou.com</a></p><p>Redis  分布式缓存数据库   Latest  <a href="https://redis.io/">https://redis.io</a></p><p>RocketMQ   消息队列   2.2.3  <a href="https://rocketmq.apache.org/">https://rocketmq.apache.org</a></p><p>ShardingSphere  数据库生态系统 5.3.2  <a href="https://shardingsphere.apache.org/">https://shardingsphere.apache.org</a></p><p>SpringCloud Alibaba 分布式框架  2022.0.0.0-RC2  <a href="https://github.com/alibaba/spring-cloud-alibaba">https://github.com/alibaba/spring-cloud-alibaba</a></p><p>SpringCloud Gateway 网关框架   2022.0.3   <a href="https://spring.io/projects/spring-cloud-gateway">https://spring.io/projects/spring-cloud-gateway</a></p><p>TTL 增强版 ThreadLocal 2.14.3  <a href="https://github.com/alibaba/transmittable-thread-local">https://github.com/alibaba/transmittable-thread-local</a></p><p>FastJson2  JSON 序列化工具  2.0.36  <a href="https://github.com/alibaba/fastjson2">https://github.com/alibaba/fastjson2</a></p><p>Canal  BinLog 订阅组件 1.1.6  <a href="https://github.com/alibaba/canal">https://github.com/alibaba/canal</a></p><p>HuTool  小而全的工具集项目  5.8.2  <a href="https://hutool.cn/">https://hutool.cn</a></p><p>Redisson   Redis Java 客户端  3.21.3  <a href="https://redisson.org/">https://redisson.org</a></p><p>Sentinel   流控防护框架  1.8.6  <a href="https://github.com/alibaba/Sentinel">https://github.com/alibaba/Sentinel</a></p><p>Hippo4j 动态线程池框架 1.5.0  <a href="https://hippo4j.cn/">https://hippo4j.cn</a></p><p>XXL-Job 分布式定时任务框架  2.4.0  <a href="http://www.xuxueli.com/xxl-job">http://www.xuxueli.com/xxl-job</a></p><p>SkyWalking  分布式链路追踪框架  9.5.0  <a href="https://skywalking.apache.org/">https://skywalking.apache.org</a></p>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
      <tag>12306</tag>
      
      <tag>微服务</tag>
      
      <tag>项目</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>docker安装</title>
    <link href="/2024/11/14/docker/"/>
    <url>/2024/11/14/docker/</url>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js"></script><p>dockerx 相关技术的内容</p><span id="more"></span><h3 id="docker安装"><a href="#docker安装" class="headerlink" title="docker安装"></a>docker安装</h3><p><a href="https://blog.csdn.net/weixin_42571882/article/details/134015815">https://blog.csdn.net/weixin_42571882/article/details/134015815</a></p><h3 id="docker镜像源（国外）"><a href="#docker镜像源（国外）" class="headerlink" title="docker镜像源（国外）"></a>docker镜像源（国外）</h3><p><a href="https://blog.csdn.net/llc580231/article/details/139979603">https://blog.csdn.net/llc580231/article/details/139979603</a></p>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hello World</title>
    <link href="/2024/11/14/hello-world/"/>
    <url>/2024/11/14/hello-world/</url>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="https://cdn.jsdelivr.net/npm/meting/dist/Meting.min.js"></script><p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><span id="more"></span><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo new <span class="hljs-string">&quot;My New Post&quot;</span><br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo server<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo generate<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo deploy<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
    
    
    <categories>
      
      <category>hexo</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hexo</tag>
      
      <tag>博客搭建</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
